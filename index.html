<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rehab Harmony | Gentle Recovery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --jade-900: #0b2f2d;
            --jade-800: #0f3f3b;
            --jade-700: #0f524c;
            --jade-600: #117164;
            --jade-500: #14b689;
            --jade-400: #47d8aa;
            --jade-200: #c8f4e5;
            --jade-100: #e8fbf4;
            --sky-500: #3b82f6;
            --sky-100: #e2f2ff;
            --amber-400: #fbbf24;
            --pink-200: #ffe4ed;
            --slate-900: #0f172a;
            --slate-800: #1f2937;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.7);
            --card: rgba(255, 255, 255, 0.9);
            --shadow: 0 14px 48px rgba(15, 23, 42, 0.12);
            --radius-lg: 28px;
            --radius-md: 18px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: radial-gradient(circle at 10% 20%, #e6fff4 0, #f3f8ff 50%, #eef7ff 100%);
            color: var(--slate-900);
            min-height: 100vh;
            line-height: 1.7;
            padding-bottom: 6rem;
        }

        .ambient {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .ambient span {
            position: absolute;
            filter: blur(120px);
            opacity: 0.7;
            border-radius: 50%;
        }
        .ambient .a1 { width: 520px; height: 520px; background: #c7f7e8; top: -120px; left: -60px; }
        .ambient .a2 { width: 420px; height: 420px; background: #cfe3ff; right: -120px; top: 10%; }
        .ambient .a3 { width: 560px; height: 560px; background: #ffe8b8; bottom: -180px; left: 12%; }

        .container { width: min(1180px, 100% - 2.5rem); margin: 0 auto; position: relative; z-index: 2; }

        header.topbar {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.86);
            border-bottom: 1px solid rgba(15,23,42,0.06);
            box-shadow: 0 10px 24px rgba(15,23,42,0.06);
        }
        .topbar-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.7rem 0.25rem;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 0.9rem;
        }
        .logo-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--jade-500), var(--jade-400));
            display: grid;
            place-items: center;
            color: white;
            font-size: 1.3rem;
            box-shadow: 0 10px 26px rgba(20, 182, 137, 0.32);
        }
        .brand h1 { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.02em; }
        .brand p { color: var(--slate-500); font-weight: 600; font-size: 0.95rem; }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.9rem;
            border-radius: 999px;
            background: var(--card);
            border: 1px solid var(--slate-200);
            font-weight: 800;
            font-size: 0.95rem;
            color: var(--slate-700);
            box-shadow: 0 8px 20px rgba(15,23,42,0.06);
        }
        .pill.success { background: linear-gradient(135deg, #ecfff6, #e0f9ef); color: var(--jade-700); border-color: #b4f1db; }
        .pill.neutral { background: #f8fafc; }

        .hero {
            padding: 1.8rem 0 0.6rem;
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 1.5rem;
            align-items: stretch;
        }
        .hero-copy h2 {
            font-size: clamp(2.3rem, 2.6vw, 2.9rem);
            line-height: 1.15;
            letter-spacing: -0.02em;
            margin-bottom: 0.8rem;
        }
        .hero-copy p { font-size: 1.08rem; color: var(--slate-600); max-width: 540px; }
        .hero-actions { display: flex; gap: 0.65rem; flex-wrap: wrap; margin-top: 1.2rem; }
        .btn {
            border: none;
            border-radius: 16px;
            padding: 1rem 1.4rem;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.65rem;
            box-shadow: 0 14px 32px rgba(16,185,129,0.2);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, var(--jade-600), var(--jade-400)); color: white; }
        .btn-ghost { background: var(--card); color: var(--slate-800); border: 1px solid var(--slate-200); box-shadow: 0 12px 24px rgba(15,23,42,0.06); }

        .hero-panel {
            background: var(--card);
            border: 1px solid rgba(15,23,42,0.06);
            border-radius: var(--radius-lg);
            padding: 1.35rem;
            box-shadow: var(--shadow);
            display: grid;
            gap: 0.9rem;
        }
        .hero-panel h3 { font-size: 1.02rem; color: var(--slate-600); letter-spacing: 0.03em; text-transform: uppercase; }
        .hero-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 0.7rem; }
        .hero-card {
            border-radius: 16px;
            padding: 0.9rem 1rem;
            background: linear-gradient(135deg, #f9ffff, #f5fbff);
            border: 1px solid var(--slate-200);
            box-shadow: 0 6px 18px rgba(15,23,42,0.06);
        }
        .hero-card strong { display: block; font-size: 1.05rem; color: var(--slate-900); }
        .hero-card span { color: var(--slate-600); font-weight: 600; }

        .utility-bar {
            margin: 0.9rem 0 0.4rem;
            background: var(--glass);
            border: 1px solid rgba(15,23,42,0.08);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 0.9rem 1.1rem;
            position: sticky;
            top: 70px;
            z-index: 15;
            backdrop-filter: blur(14px);
        }
        .utility-inner { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; }
        .utility-actions { display: flex; gap: 0.6rem; overflow-x: auto; padding-bottom: 0.35rem; }
        .utility-actions::-webkit-scrollbar { height: 6px; }
        .utility-actions::-webkit-scrollbar-thumb { background: var(--slate-200); border-radius: 999px; }
        .utility-chip {
            border: 1px solid var(--slate-200);
            background: white;
            color: var(--slate-700);
            border-radius: 999px;
            padding: 0.7rem 1.1rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 22px rgba(15,23,42,0.07);
            transition: all 0.18s ease;
            white-space: nowrap;
        }
        .utility-chip.active { background: linear-gradient(135deg, #e7fff5, #e8f5ff); color: var(--jade-700); border-color: #b8f1df; }
        .utility-menus { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .mode-pill-group { display: inline-flex; border: 1px solid var(--slate-200); border-radius: 999px; background: #f8fafc; }
        .mode-pill { border: none; background: transparent; padding: 0.7rem 1.1rem; font-weight: 800; color: var(--slate-500); cursor: pointer; }
        .mode-pill.active { background: white; color: var(--jade-700); border-radius: 999px; box-shadow: inset 0 0 0 2px #b6f0dd; }
        .utility-select { display: inline-flex; gap: 0.6rem; align-items: center; background: white; border: 1px solid var(--slate-200); border-radius: 14px; padding: 0.5rem 0.75rem; box-shadow: 0 8px 22px rgba(15,23,42,0.08); }
        .utility-select label { font-weight: 800; color: var(--slate-600); }
        .utility-select select, .utility-select button { border: none; background: #f8fafc; padding: 0.55rem 0.8rem; border-radius: 12px; font-weight: 700; color: var(--slate-700); cursor: pointer; }
        .utility-select button { background: linear-gradient(135deg, var(--jade-600), var(--jade-500)); color: white; }

        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1.2rem; }
        .status-card {
            padding: 1.4rem;
            background: var(--card);
            border-radius: var(--radius-md);
            border: 1px solid rgba(15,23,42,0.06);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .status-card.glow { background: linear-gradient(135deg, #f4fffb, #eef7ff); }
        .status-head { display: flex; justify-content: space-between; gap: 0.6rem; align-items: center; margin-bottom: 0.6rem; }
        .eyebrow { text-transform: uppercase; letter-spacing: 0.08em; font-weight: 800; color: var(--slate-500); font-size: 0.85rem; }
        .progress-shell { height: 14px; border-radius: 999px; overflow: hidden; background: #f1f5f9; border: 1px solid #e2e8f0; margin: 0.5rem 0 0.4rem; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--jade-600), var(--jade-400)); transition: width 0.3s ease; }
        .progress-text { display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: var(--slate-800); }
        .progress-text span { color: var(--slate-500); font-weight: 700; font-size: 0.95rem; }
        .micro-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.6rem; }
        .micro-tag { background: #f8fafc; border: 1px solid var(--slate-200); border-radius: 12px; padding: 0.35rem 0.7rem; font-weight: 700; color: var(--slate-600); }
        .breath-steps { font-weight: 800; color: var(--jade-700); font-size: 1.1rem; }
        .checklist { display: grid; gap: 0.55rem; }
        .check-pill { display: flex; gap: 0.55rem; align-items: center; background: #f8fafc; border: 1px solid var(--slate-200); border-radius: 12px; padding: 0.55rem 0.7rem; font-weight: 700; color: var(--slate-700); }
        .check-pill input { accent-color: var(--jade-600); width: 18px; height: 18px; }
        .mini-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.55rem; margin-top: 0.4rem; }
        .mini-stat { background: #f9fcff; border: 1px solid var(--slate-200); border-radius: 12px; padding: 0.7rem 0.8rem; font-weight: 700; color: var(--slate-600); }
        .mini-stat strong { color: var(--slate-900); display: block; }

        .step-nav { display: flex; gap: 1rem; justify-content: space-between; margin: 1.75rem 0 2.25rem; position: relative; }
        .step-nav::before { content: ''; position: absolute; left: 8%; right: 8%; top: 38px; height: 4px; background: #e2e8f0; }
        .step { position: relative; text-align: center; flex: 1; z-index: 1; }
        .step-circle { width: 76px; height: 76px; margin: 0 auto 0.75rem; border-radius: 50%; border: 4px solid #e2e8f0; background: white; display: grid; place-items: center; font-weight: 900; font-size: 1.8rem; color: var(--slate-400); box-shadow: 0 12px 26px rgba(15,23,42,0.08); transition: transform 0.25s ease, background 0.25s ease; }
        .step.active .step-circle, .step.completed .step-circle { background: linear-gradient(135deg, var(--jade-600), var(--jade-400)); color: white; border-color: transparent; }
        .step.active .step-circle { transform: scale(1.08); }
        .step-label { font-weight: 800; color: var(--slate-500); }
        .step.active .step-label { color: var(--slate-900); }

        .section-card {
            background: var(--card);
            border: 1px solid rgba(15,23,42,0.08);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .section-card.collapsible { padding: 0; }
        .section-card.collapsible .section-header { padding: 1.4rem 1.5rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap; }
        .section-card.collapsible .section-body { padding: 0 1.5rem 1.5rem; display: grid; gap: 1.25rem; }
        .section-card.collapsed .section-body { display: none; }
        .section-title { font-size: 1.8rem; font-weight: 900; letter-spacing: -0.01em; }
        .section-subtitle { color: var(--slate-600); font-size: 1.05rem; font-weight: 600; }
        .section-toggle { border: 1px solid var(--slate-200); background: white; color: var(--slate-700); border-radius: 12px; padding: 0.6rem 0.85rem; font-weight: 800; cursor: pointer; box-shadow: 0 10px 22px rgba(15,23,42,0.08); display: inline-flex; align-items: center; gap: 0.45rem; }
        .section-toggle .chevron { transition: transform 0.2s ease; }
        .section-card.collapsed .section-toggle .chevron { transform: rotate(-90deg); }

        .voice-card { border: 1px solid #d8f2e7; background: linear-gradient(135deg, #f2fffb, #f6fbff); }
        .voice-commands { list-style: none; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.6rem; }
        .voice-command { padding: 0.8rem 0.95rem; border-radius: 12px; background: white; border: 1px solid var(--slate-200); font-weight: 700; color: var(--slate-700); }
        .voice-controls { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center; }
        .voice-toggle { border: 2px solid #c7f5e3; background: linear-gradient(135deg, #dffdf2, #d7f2ff); color: var(--jade-800); font-weight: 800; padding: 0.9rem 1.25rem; border-radius: 14px; cursor: pointer; box-shadow: 0 12px 28px rgba(20,182,137,0.2); }
        .voice-toggle.active { background: linear-gradient(135deg, var(--jade-600), var(--jade-400)); color: white; border-color: transparent; }
        .voice-status { font-weight: 700; color: var(--slate-600); background: #f8fafc; border: 1px solid var(--slate-200); border-radius: 12px; padding: 0.7rem 0.9rem; }
        .voice-status.active { background: #e6fff5; color: var(--jade-700); }
        .voice-response { background: #f8fafc; border: 1px solid var(--slate-200); border-radius: 14px; padding: 1rem; font-weight: 700; color: var(--slate-700); }

        .input-group { display: grid; gap: 0.75rem; }
        .input-label { font-weight: 800; color: var(--slate-800); font-size: 1.1rem; }
        .input-field { width: 100%; padding: 1rem 1.1rem; border: 2px solid var(--slate-200); border-radius: 14px; font-size: 1.05rem; font-weight: 600; background: white; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .input-field:focus { outline: none; border-color: var(--jade-500); box-shadow: 0 0 0 4px rgba(20,182,137,0.15); }
        textarea.input-field { resize: vertical; min-height: 120px; }

        .pain-slider-container { background: linear-gradient(135deg, #f5fffb, #fff9ef); border: 1px solid #e8f5ed; border-radius: var(--radius-md); padding: 1.5rem; }
        .pain-track { height: 14px; background: linear-gradient(90deg, var(--jade-500), var(--amber-400), #ef4444); border-radius: 999px; position: relative; margin: 36px 0; box-shadow: inset 0 0 0 2px rgba(15,23,42,0.04); }
        .pain-handle { position: absolute; top: -28px; width: 76px; height: 76px; transform: translateX(-50%); background: white; border-radius: 50%; display: grid; place-items: center; font-weight: 900; font-size: 1.4rem; color: var(--slate-900); border: 4px solid var(--jade-500); box-shadow: 0 14px 32px rgba(15,23,42,0.2); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .pain-handle:hover { transform: translateX(-50%) scale(1.05); }
        .pain-handle:focus-visible { outline: none; box-shadow: 0 0 0 6px rgba(20,182,137,0.26); }
        .pain-labels { display: flex; justify-content: space-between; color: var(--slate-500); font-weight: 700; }

        .exercise-grid { display: grid; gap: 1.25rem; }
        .exercise-card { border-radius: 18px; border: 1px solid var(--slate-200); padding: 1.25rem; background: white; box-shadow: 0 12px 26px rgba(15,23,42,0.08); display: none; }
        .exercise-card.active { display: block; border-color: var(--jade-500); box-shadow: 0 18px 38px rgba(20,182,137,0.16); }
        .exercise-card.completed { background: linear-gradient(135deg, #f1fff8, #f2fbff); }
        .exercise-header { display: flex; align-items: center; gap: 0.9rem; flex-wrap: wrap; justify-content: space-between; }
        .exercise-icon { width: 56px; height: 56px; border-radius: 14px; background: #ecfff8; display: grid; place-items: center; font-size: 1.8rem; border: 1px solid #baf2df; }
        .exercise-title { font-size: 1.35rem; font-weight: 800; flex: 1; }
        .exercise-status { padding: 0.55rem 0.9rem; border-radius: 12px; font-weight: 800; background: #f8fafc; border: 1px solid var(--slate-200); color: var(--slate-600); }
        .exercise-card.active .exercise-status { background: var(--jade-600); color: white; border-color: transparent; }
        .exercise-card.completed .exercise-status { background: var(--jade-500); color: white; border-color: transparent; }
        .exercise-description { color: var(--slate-600); font-weight: 600; }
        .rep-counter { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
        .rep-btn { width: 64px; height: 64px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--jade-600), var(--jade-400)); color: white; font-size: 1.6rem; font-weight: 900; cursor: pointer; box-shadow: 0 12px 26px rgba(20,182,137,0.28); }
        .rep-count { font-size: 2.1rem; font-weight: 900; min-width: 72px; text-align: center; }
        .rep-goal { color: var(--slate-500); font-weight: 700; }

        .exercise-nav { display: flex; flex-wrap: wrap; gap: 0.6rem; align-items: center; border: 1px dashed var(--slate-200); border-radius: 14px; padding: 0.9rem 1rem; background: #f8fafc; }
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .ghost-btn { padding: 0.65rem 1rem; border-radius: 12px; border: 1px solid var(--slate-200); background: white; font-weight: 700; cursor: pointer; }

        .session-timer { text-align: center; background: linear-gradient(135deg, #f2fffb, #f5f9ff); border: 1px solid #dcf3eb; border-radius: 16px; padding: 1.4rem; }
        .timer-display { font-size: 3rem; font-weight: 900; color: var(--jade-600); }
        .timer-label { color: var(--slate-500); font-weight: 800; letter-spacing: 0.06em; text-transform: uppercase; font-size: 0.9rem; }

        .action-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .btn-secondary { background: white; color: var(--slate-700); border: 1px solid var(--slate-200); box-shadow: 0 12px 24px rgba(15,23,42,0.08); }

        .completion-screen { text-align: center; display: grid; gap: 1.5rem; }
        .celebration-icon { width: 120px; height: 120px; border-radius: 50%; display: grid; place-items: center; margin: 0 auto; background: linear-gradient(135deg, var(--jade-600), var(--jade-400)); color: white; font-size: 3.2rem; box-shadow: 0 18px 38px rgba(20,182,137,0.28); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .result-card { background: white; border: 1px solid var(--slate-200); border-radius: 14px; padding: 1.2rem; box-shadow: 0 12px 26px rgba(15,23,42,0.08); }
        .result-value { font-size: 2.8rem; font-weight: 900; color: var(--jade-600); }
        .result-label { color: var(--slate-500); font-weight: 700; }

        .control-dock {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(15,23,42,0.08);
            border-radius: 18px;
            padding: 1rem;
            box-shadow: 0 18px 42px rgba(15,23,42,0.18);
            width: min(360px, calc(100% - 2rem));
            z-index: 25;
        }
        .dock-header { display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: var(--slate-800); margin-bottom: 0.6rem; }
        .dock-toggle { border: 1px solid var(--slate-200); background: #f8fafc; border-radius: 10px; padding: 0.45rem 0.7rem; font-weight: 800; cursor: pointer; }
        .dock-body { display: grid; gap: 0.75rem; }
        .dock-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.55rem; }
        .dock-btn { padding: 0.8rem 0.9rem; border-radius: 12px; border: 1px solid var(--slate-200); background: #f8fafc; font-weight: 800; cursor: pointer; }
        .dock-btn.primary { background: linear-gradient(135deg, var(--jade-600), var(--jade-400)); color: white; border-color: transparent; }
        .dock-meta { display: flex; justify-content: space-between; color: var(--slate-600); font-weight: 700; }
        .control-dock.collapsed .dock-body { display: none; }

        @media (max-width: 1024px) {
            .hero { grid-template-columns: 1fr; }
            .utility-inner { grid-template-columns: 1fr; }
        }
        @media (max-width: 720px) {
            body { padding-bottom: 8rem; }
            .container { width: calc(100% - 1.4rem); }
            .topbar-inner { flex-direction: column; align-items: flex-start; gap: 0.6rem; padding: 0.75rem 0; }
            .brand h1 { font-size: 1.2rem; }
            .brand p { font-size: 0.9rem; }
            .top-actions { width: 100%; justify-content: flex-start; }
            .pill { font-size: 0.9rem; padding: 0.55rem 0.8rem; }
            .hero { gap: 1rem; padding-top: 1.2rem; }
            .hero-copy h2 { font-size: clamp(1.9rem, 6vw, 2.3rem); }
            .hero-panel { padding: 1rem; }
            .hero-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .utility-bar { position: static; margin: 1rem 0 0.2rem; padding: 0.85rem 0.9rem; box-shadow: 0 8px 18px rgba(15,23,42,0.06); }
            .utility-inner { gap: 0.8rem; }
            .utility-actions { gap: 0.5rem; padding-bottom: 0.2rem; }
            .utility-chip { padding: 0.55rem 0.9rem; font-size: 0.9rem; }
            .utility-menus { width: 100%; justify-content: space-between; }
            .utility-select { width: 100%; justify-content: space-between; }
            .section-card { border-radius: 20px; padding: 1.25rem; margin-bottom: 1rem; }
            .step-nav { flex-direction: column; gap: 1rem; margin: 1.4rem 0 1.6rem; }
            .step-nav::before { display: none; }
            .step { display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 0.8rem; text-align: left; }
            .step-circle { width: 64px; height: 64px; font-size: 1.4rem; }
            .control-dock { left: 10px; right: 10px; bottom: 12px; width: auto; padding: 0.75rem; }
            .dock-controls { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .dock-btn { padding: 0.7rem 0.8rem; text-align: center; }
            .rep-counter { justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="ambient" aria-hidden="true">
        <span class="a1"></span>
        <span class="a2"></span>
        <span class="a3"></span>
    </div>

    <header class="topbar">
        <div class="container topbar-inner">
            <div class="brand">
                <div class="logo-icon">‚ù§Ô∏è</div>
                <div>
                    <h1>Rehab Harmony</h1>
                    <p>Therapeutic recovery, beautifully paced</p>
                </div>
            </div>
            <div class="top-actions">
                <span class="pill success">Calm ¬∑ Kind ¬∑ Consistent</span>
                <span class="pill neutral" id="currentTime">--:--</span>
                <span class="pill">Today's focus: <strong id="miniMode">Guided</strong></span>
            </div>
        </div>
    </header>

    <div class="container">
        <section class="hero">
            <div class="hero-copy">
                <div class="pill success" id="stepBanner">Step 1 ¬∑ Check in gently</div>
                <h2>Your gentle, expertly crafted recovery ritual</h2>
                <p>Move with a clinician-designed flow that balances breath, joint nourishment, and tiny wins. Every control, cue, and exercise was tuned for ease.</p>
                <div class="hero-actions">
                    <button class="btn btn-primary" onclick="startSession()">Start Session ‚Üí</button>
                    <button class="btn btn-ghost" onclick="document.getElementById('step1').scrollIntoView({behavior:'smooth'})">Check-in first</button>
                </div>
            </div>
            <div class="hero-panel">
                <h3>Today at a glance</h3>
                <div class="hero-grid">
                    <div class="hero-card"><strong id="heroMode">Guided mode</strong><span>Voice + on-screen tips</span></div>
                    <div class="hero-card"><strong id="heroFocus">Mobility today</strong><span>Pre-selected routine</span></div>
                    <div class="hero-card"><strong id="heroPace">Gentle ¬∑ steady breathing</strong><span>Change pace anytime</span></div>
                    <div class="hero-card"><strong id="heroReminders">On ¬∑ gentle nudges</strong><span>Remind me to pause & hydrate</span></div>
                </div>
            </div>
        </section>

        <div class="utility-bar">
            <div class="utility-inner">
                <div class="utility-actions">
                    <button class="utility-chip active" data-scroll="#step1" data-step="1" data-step-chip="1">Step 1 ¬∑ Check-in</button>
                    <button class="utility-chip" data-scroll="#step2" data-step="2" data-step-chip="2">Step 2 ¬∑ Exercises</button>
                    <button class="utility-chip" data-scroll="#step3" data-step="3" data-step-chip="3">Step 3 ¬∑ Complete</button>
                    <button class="utility-chip active" id="paceChip">Gentle Pace</button>
                    <button class="utility-chip active" id="reminderChip">üîî Gentle Reminders</button>
                    <button class="utility-chip" id="voiceChip">üéôÔ∏è Voice Coach</button>
                </div>
                <div class="utility-menus">
                    <div class="utility-select">
                        <label for="focusSelect">Focus</label>
                        <select id="focusSelect">
                            <option>Mobility</option>
                            <option>Strength</option>
                            <option>Balance</option>
                            <option>Breathwork</option>
                        </select>
                        <button type="button" id="applyFocus">Apply</button>
                    </div>
                    <div class="mode-pill-group" role="group" aria-label="Guidance style">
                        <button class="mode-pill active" data-mode="Guided">Guided</button>
                        <button class="mode-pill" data-mode="Manual">Manual</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-grid" aria-label="Session overview">
            <article class="status-card glow">
                <div class="status-head">
                    <span class="eyebrow">Readiness</span>
                    <span class="pill" id="sessionStateChip">Not started</span>
                </div>
                <div class="progress-shell" aria-hidden="true"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text"><strong id="progressLabel">0% ready</strong><span id="progressMeta">0/35 gentle reps</span></div>
                <div class="micro-tags"><span class="micro-tag" id="focusBadge">Mobility focus</span><span class="micro-tag" id="reminderCue">Reminders on ¬∑ gentle nudges</span></div>
            </article>
            <article class="status-card">
                <div class="status-head"><span class="eyebrow">Breath guide</span><span class="pill success">Stay relaxed</span></div>
                <div class="breath-steps" id="breathCue">Inhale 4s ¬∑ Exhale 6s</div>
                <p class="status-body">Match your pace to your breath. Slow exhales down-regulate tension and keep movements calm.</p>
                <div class="micro-tags"><span class="micro-tag" id="paceCue">Gentle pace</span><span class="micro-tag">Soft shoulders</span></div>
            </article>
            <article class="status-card">
                <div class="status-head"><span class="eyebrow">Comfort check</span><span class="pill">1‚Äì2 mins</span></div>
                <div class="checklist" aria-label="Comfort checklist">
                    <label class="check-pill"><input type="checkbox" checked>Supportive surface ready</label>
                    <label class="check-pill"><input type="checkbox" checked>Water nearby</label>
                    <label class="check-pill"><input type="checkbox">Pillows or rolled towel handy</label>
                </div>
            </article>
            <article class="status-card">
                <div class="status-head"><span class="eyebrow">Small wins</span><span class="pill success">Celebrate</span></div>
                <div class="mini-stats">
                    <div class="mini-stat"><strong id="miniStep">Step 1 of 3</strong><span>Current stage</span></div>
                    <div class="mini-stat"><strong id="navMode">Guided</strong><span>Support style</span></div>
                </div>
                <p class="status-body" style="margin-top:0.5rem;">Keep an easy tempo‚Äîquality over quantity. Tap a card to jump to any exercise when ready.</p>
            </article>
        </div>

        <div class="step-nav">
            <div class="step active" data-step="1"><div class="step-circle"><span class="step-number">1</span></div><div class="step-label">Check In</div></div>
            <div class="step" data-step="2"><div class="step-circle"><span class="step-number">2</span></div><div class="step-label">Exercises</div></div>
            <div class="step" data-step="3"><div class="step-circle"><span class="step-number">3</span></div><div class="step-label">Complete</div></div>
        </div>

        <main class="main-content">
            <section class="section-card voice-card collapsible" aria-labelledby="voiceControlHeading" data-collapsible data-default-collapsed="true">
                <div class="section-header">
                    <div>
                        <h2 class="section-title" id="voiceControlHeading">Voice Coach</h2>
                        <p class="section-subtitle">Control your session hands-free with calm, confident prompts.</p>
                    </div>
                    <button class="section-toggle" type="button" aria-expanded="false"><span class="chevron">‚ñ∏</span><span class="toggle-label">Expand</span></button>
                </div>
                <div class="section-body">
                    <ul class="voice-commands">
                        <li class="voice-command">üéôÔ∏è <span>"Start session"</span> to begin</li>
                        <li class="voice-command">üéôÔ∏è <span>"Pause session"</span> or <span>"Resume session"</span></li>
                        <li class="voice-command">üéôÔ∏è <span>"Next exercise"</span> or <span>"Previous exercise"</span></li>
                        <li class="voice-command">üéôÔ∏è <span>"Increase reps"</span> / <span>"Decrease reps"</span> (say a number too!)</li>
                        <li class="voice-command">üéôÔ∏è <span>"Finish session"</span> when you're done</li>
                    </ul>
                    <div class="voice-controls">
                        <button class="voice-toggle" id="voiceToggle" type="button" aria-pressed="false"><span>üé§ Start Voice Coach</span></button>
                        <div class="voice-status" id="voiceStatus" aria-live="polite">Voice ready when you are.</div>
                    </div>
                    <div class="voice-response" id="voiceResponse" aria-live="polite">Voice responses will appear here so you always know what was heard.</div>
                </div>
            </section>

            <section id="step1" class="section-card collapsible" data-collapsible>
                <div class="section-header">
                    <div>
                        <h2 class="section-title">How are you feeling today?</h2>
                        <p class="section-subtitle">A quick check-in helps us tailor your session</p>
                    </div>
                    <button class="section-toggle" type="button" aria-expanded="true"><span class="chevron">‚ñæ</span><span class="toggle-label">Hide</span></button>
                </div>
                <div class="section-body">
                    <div class="input-group">
                        <label class="input-label">Your Name</label>
                        <input type="text" class="input-field" value="Marvin" id="userName" placeholder="Enter your name">
                    </div>
                    <div class="pain-slider-container">
                        <label class="input-label">Current Pain Level</label>
                        <div class="pain-track" id="painTrack">
                            <div class="pain-handle" id="painHandle" style="left: 25%;" role="slider" aria-valuemin="0" aria-valuemax="10" aria-valuenow="2.5" aria-label="Pain level" tabindex="0">2.5</div>
                        </div>
                        <div class="pain-labels"><span>No Pain</span><span>Moderate</span><span>Severe</span></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Quick setup</label>
                        <div class="checklist">
                            <label class="check-pill"><input type="checkbox" checked>Notifications on for breaks</label>
                            <label class="check-pill"><input type="checkbox" checked>Room temperature feels comfortable</label>
                            <label class="check-pill"><input type="checkbox">I have a chair or wall for balance</label>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="startSession()"><span>Start Today's Session</span><span>‚Üí</span></button>
                    </div>
                </div>
            </section>

            <section id="step2" class="section-card collapsible hidden" data-collapsible data-default-collapsed="false">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Today's Gentle Exercises</h2>
                        <p class="section-subtitle">One exercise at a time‚Äîclear instructions so you can move with confidence.</p>
                    </div>
                    <button class="section-toggle" type="button" aria-expanded="true"><span class="chevron">‚ñæ</span><span class="toggle-label">Hide</span></button>
                </div>
                <div class="section-body">
                    <div class="exercise-nav">
                        <span class="micro-tag" id="navCurrent">Exercise 1 of 3</span>
                        <span class="micro-tag">Mode: <span id="navMode">Guided walkthrough</span></span>
                        <div class="nav-buttons">
                            <button class="ghost-btn" onclick="goToAdjacentExercise(-1)">‚Üê Previous</button>
                            <button class="ghost-btn" onclick="goToAdjacentExercise(1)">Next ‚Üí</button>
                            <button class="ghost-btn" onclick="completeCurrentExercise()">Mark complete</button>
                        </div>
                    </div>
                    <div class="session-timer">
                        <div class="timer-display" id="sessionTimer" aria-live="polite">00:00</div>
                        <div class="timer-label">Session Duration</div>
                    </div>
                    <div class="exercise-grid">
                        <div class="exercise-card active" data-exercise="1">
                            <div class="exercise-header">
                                <div class="exercise-icon">ü¶µ</div>
                                <div class="exercise-title">Heel Slides</div>
                                <span class="exercise-status">Current</span>
                            </div>
                            <p class="exercise-description">Gently slide your heel toward your buttocks while keeping contact with the surface. Hold briefly, then slowly return. Move slow and steady‚Äîcomfort is key.</p>
                            <div class="rep-counter">
                                <button class="rep-btn" onclick="adjustReps(1, -1)" aria-label="Decrease reps">‚àí</button>
                                <span class="rep-count" id="reps1">0</span>
                                <button class="rep-btn" onclick="adjustReps(1, 1)" aria-label="Increase reps">+</button>
                                <span class="rep-goal">Goal: 10 reps</span>
                            </div>
                        </div>
                        <div class="exercise-card" data-exercise="2">
                            <div class="exercise-header">
                                <div class="exercise-icon">üí™</div>
                                <div class="exercise-title">Quad Sets</div>
                                <span class="exercise-status">Up Next</span>
                            </div>
                            <p class="exercise-description">Tighten your thigh muscle as if trying to straighten your knee. Hold the contraction for 3-5 seconds, then relax completely. Breathe naturally throughout.</p>
                            <div class="rep-counter">
                                <button class="rep-btn" onclick="adjustReps(2, -1)" aria-label="Decrease reps">‚àí</button>
                                <span class="rep-count" id="reps2">0</span>
                                <button class="rep-btn" onclick="adjustReps(2, 1)" aria-label="Increase reps">+</button>
                                <span class="rep-goal">Goal: 15 reps</span>
                            </div>
                        </div>
                        <div class="exercise-card" data-exercise="3">
                            <div class="exercise-header">
                                <div class="exercise-icon">üèãÔ∏è</div>
                                <div class="exercise-title">Leg Raises</div>
                                <span class="exercise-status">Up Next</span>
                            </div>
                            <p class="exercise-description">With knee straight, lift your leg 6-12 inches. Hold briefly, then lower with control. Keep breathing steady and stop if you feel any sharp pain.</p>
                            <div class="rep-counter">
                                <button class="rep-btn" onclick="adjustReps(3, -1)" aria-label="Decrease reps">‚àí</button>
                                <span class="rep-count" id="reps3">0</span>
                                <button class="rep-btn" onclick="adjustReps(3, 1)" aria-label="Increase reps">+</button>
                                <span class="rep-goal">Goal: 10 reps</span>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="pauseSession()" id="pauseBtn"><span>‚è∏Ô∏è Pause Session</span></button>
                        <button class="btn btn-primary" onclick="completeSession()"><span>Finish Session</span><span>‚úì</span></button>
                    </div>
                </div>
            </section>

            <section id="step3" class="section-card collapsible hidden" data-collapsible data-default-collapsed="true">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Excellent Work Today!</h2>
                        <p class="section-subtitle">You're making great progress in your recovery journey</p>
                    </div>
                    <button class="section-toggle" type="button" aria-expanded="false"><span class="chevron">‚ñ∏</span><span class="toggle-label">Expand</span></button>
                </div>
                <div class="section-body">
                    <div class="completion-screen">
                        <div class="celebration-icon">üéâ</div>
                        <div class="results-grid">
                            <div class="result-card"><div class="result-value" id="totalReps">0</div><div class="result-label">Total Reps</div></div>
                            <div class="result-card"><div class="result-value" id="exercisesDone">0/3</div><div class="result-label">Exercises Done</div></div>
                            <div class="result-card"><div class="result-value" id="sessionDuration">00:00</div><div class="result-label">Time Spent</div></div>
                            <div class="result-card"><div class="result-value" id="painChange">2.5</div><div class="result-label">Pain Level</div></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Session Notes (Optional)</label>
                            <textarea class="input-field" rows="4" placeholder="How did you feel during the session? Any observations..." id="sessionNotes"></textarea>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="returnToExercises()"><span>‚Ü∂ Return to Exercises</span></button>
                            <button class="btn btn-primary" onclick="saveAndFinish()"><span>Save & Complete</span><span>‚úì</span></button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="control-dock" aria-label="Quick session controls" data-dock>
        <div class="dock-header">
            <span>Quick Controls</span>
            <div><span id="dockStatus">Idle</span> <button class="dock-toggle" type="button" aria-expanded="true">Hide</button></div>
        </div>
        <div class="dock-body">
            <div class="dock-controls">
                <button class="dock-btn primary" onclick="toggleStartOrResume()">Start / Resume</button>
                <button class="dock-btn" onclick="pauseSession()">Pause / Play</button>
                <button class="dock-btn" onclick="goToAdjacentExercise(-1)">‚Üê Previous</button>
                <button class="dock-btn" onclick="goToAdjacentExercise(1)">Next ‚Üí</button>
                <button class="dock-btn" onclick="completeSession()">Finish</button>
                <button class="dock-btn" onclick="completeCurrentExercise()">Mark Exercise Done</button>
            </div>
            <div class="dock-meta"><span id="dockExercise">Exercise 1/3</span><span id="dockTimer">00:00</span></div>
        </div>
    </div>

    <script>
        const AppState = {
            currentStep: 1,
            user: { name: 'Marvin', painLevel: 2.5, sessionStart: null },
            currentExercise: 1,
            exercises: {
                1: { name: 'Heel Slides', reps: 0, goal: 10, completed: false },
                2: { name: 'Quad Sets', reps: 0, goal: 15, completed: false },
                3: { name: 'Leg Raises', reps: 0, goal: 10, completed: false }
            },
            session: { active: false, paused: false, duration: 0, timer: null },
            voice: { recognition: null, listening: false, supported: false },
            preferences: { pace: 'Gentle', reminders: true, mode: 'Guided', focus: 'Mobility' },
            results: { totalReps: 0, exercisesCompleted: 0 }
        };
        const totalGoalReps = Object.values(AppState.exercises).reduce((sum, ex) => sum + ex.goal, 0);

        document.addEventListener('DOMContentLoaded', () => {
            initClock();
            setupPainSlider();
            setupPainSliderKeyboard();
            setupExerciseCardClicks();
            initCollapsibles();
            initDockToggle();
            initVoiceControl();
            bindVoiceToggle();
            initUtilityBar();
            updateStepDisplay();
            updateTotalReps();
            updateHeroSummary();
            updateProgressUI();
            updateWellnessCards();
            updateMiniSummary();
            updateExerciseNav();
            updateDockUI();
        });

        function initClock() {
            const updateClock = () => {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                const timeEl = document.getElementById('currentTime');
                if (timeEl) timeEl.textContent = timeString;
            };
            updateClock();
            setInterval(updateClock, 1000);
        }

        function setupPainSlider() {
            const track = document.getElementById('painTrack');
            const handle = document.getElementById('painHandle');
            if (!track || !handle) return;
            let dragging = false;
            const updatePainValue = (clientX) => {
                const rect = track.getBoundingClientRect();
                let percent = ((clientX - rect.left) / rect.width) * 100;
                percent = Math.max(0, Math.min(100, percent));
                const painValue = (percent / 10).toFixed(1);
                handle.style.left = `${percent}%`;
                handle.textContent = painValue;
                handle.setAttribute('aria-valuenow', painValue);
                AppState.user.painLevel = parseFloat(painValue);
                handle.style.transform = `translateX(-50%) scale(${dragging ? 1.05 : 1})`;
            };
            track.addEventListener('mousedown', (e) => { dragging = true; updatePainValue(e.clientX); });
            document.addEventListener('mousemove', (e) => { if (dragging) updatePainValue(e.clientX); });
            document.addEventListener('mouseup', () => { dragging = false; handle.style.transform = 'translateX(-50%)'; });
            track.addEventListener('touchstart', (e) => { dragging = true; if (e.touches[0]) updatePainValue(e.touches[0].clientX); }, { passive: true });
            document.addEventListener('touchmove', (e) => { if (dragging && e.touches[0]) updatePainValue(e.touches[0].clientX); }, { passive: true });
            document.addEventListener('touchend', () => { dragging = false; handle.style.transform = 'translateX(-50%)'; });
        }

        function setupPainSliderKeyboard() {
            const handle = document.getElementById('painHandle');
            if (!handle) return;
            const step = 0.5;
            const setFromValue = (value) => {
                const bounded = Math.min(10, Math.max(0, value));
                const percent = (bounded / 10) * 100;
                handle.style.left = `${percent}%`;
                handle.textContent = bounded.toFixed(1);
                handle.setAttribute('aria-valuenow', bounded.toFixed(1));
                AppState.user.painLevel = bounded;
            };
            handle.addEventListener('keydown', (e) => {
                if (['ArrowLeft', 'ArrowDown'].includes(e.key)) { e.preventDefault(); setFromValue(AppState.user.painLevel - step); }
                else if (['ArrowRight', 'ArrowUp'].includes(e.key)) { e.preventDefault(); setFromValue(AppState.user.painLevel + step); }
                else if (e.key === 'Home') { e.preventDefault(); setFromValue(0); }
                else if (e.key === 'End') { e.preventDefault(); setFromValue(10); }
            });
        }

        function setupExerciseCardClicks() {
            document.querySelectorAll('.exercise-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    if (event.target.closest('.rep-btn')) return;
                    const exerciseNum = parseInt(card.dataset.exercise, 10);
                    setActiveExercise(exerciseNum, { scroll: true });
                });
            });
        }

        function initCollapsibles() {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            document.querySelectorAll('[data-collapsible]').forEach(section => {
                const toggle = section.querySelector('.section-toggle');
                if (!toggle) return;
                const defaultCollapsed = section.dataset.defaultCollapsed === 'true' && isMobile;
                setCollapsed(section, defaultCollapsed);
                toggle.addEventListener('click', () => toggleSection(section));
            });
        }
        function toggleSection(section) { setCollapsed(section, !section.classList.contains('collapsed')); }
        function setCollapsed(section, collapsed) {
            const body = section.querySelector('.section-body');
            const toggle = section.querySelector('.section-toggle');
            section.classList.toggle('collapsed', collapsed);
            if (body) body.hidden = collapsed;
            if (toggle) {
                toggle.setAttribute('aria-expanded', (!collapsed).toString());
                const label = toggle.querySelector('.toggle-label');
                const chevron = toggle.querySelector('.chevron');
                if (label) label.textContent = collapsed ? 'Expand' : 'Hide';
                if (chevron) chevron.textContent = collapsed ? '‚ñ∏' : '‚ñæ';
            }
        }

        function initDockToggle() {
            const dock = document.querySelector('[data-dock]');
            if (!dock) return;
            const toggle = dock.querySelector('.dock-toggle');
            const body = dock.querySelector('.dock-body');
            if (!toggle || !body) return;
            const shouldCollapse = window.matchMedia('(max-width: 768px)').matches;
            setDockCollapsed(dock, shouldCollapse);
            toggle.addEventListener('click', () => setDockCollapsed(dock, !dock.classList.contains('collapsed')));
        }
        function setDockCollapsed(dock, collapsed) {
            const toggle = dock.querySelector('.dock-toggle');
            const body = dock.querySelector('.dock-body');
            dock.classList.toggle('collapsed', collapsed);
            if (body) body.hidden = collapsed;
            if (toggle) { toggle.textContent = collapsed ? 'Show' : 'Hide'; toggle.setAttribute('aria-expanded', (!collapsed).toString()); }
        }

        function initUtilityBar() {
            document.querySelectorAll('[data-scroll]').forEach(chip => {
                chip.addEventListener('click', () => {
                    const target = chip.getAttribute('data-scroll');
                    const step = parseInt(chip.getAttribute('data-step'), 10);
                    if (step) { AppState.currentStep = step; updateStepDisplay(); }
                    if (target) { const el = document.querySelector(target); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
                });
            });
            const voiceChip = document.getElementById('voiceChip');
            if (voiceChip) voiceChip.addEventListener('click', () => document.getElementById('voiceToggle')?.click());
            const reminderChip = document.getElementById('reminderChip');
            if (reminderChip) reminderChip.addEventListener('click', () => toggleReminders());
            const paceChip = document.getElementById('paceChip');
            if (paceChip) paceChip.addEventListener('click', () => cyclePace());
            const focusSelect = document.getElementById('focusSelect');
            const applyFocus = document.getElementById('applyFocus');
            if (applyFocus && focusSelect) {
                applyFocus.addEventListener('click', () => {
                    AppState.preferences.focus = focusSelect.value;
                    showNotification(`Focus set to ${focusSelect.value}`, 'success');
                    updateHeroSummary();
                });
            }
            document.querySelectorAll('.mode-pill').forEach(pill => pill.addEventListener('click', () => setMode(pill.dataset.mode)));
        }

        function setMode(mode) {
            AppState.preferences.mode = mode;
            document.querySelectorAll('.mode-pill').forEach(pill => pill.classList.toggle('active', pill.dataset.mode === mode));
            updateHeroSummary();
            updateExerciseNav();
            updateMiniSummary();
        }
        function cyclePace() {
            const order = ['Gentle', 'Steady', 'Confident'];
            const currentIdx = order.indexOf(AppState.preferences.pace);
            const next = order[(currentIdx + 1) % order.length];
            AppState.preferences.pace = next;
            updateHeroSummary();
            const paceChip = document.getElementById('paceChip');
            if (paceChip) { paceChip.textContent = `${next} Pace`; paceChip.classList.add('active'); setTimeout(() => paceChip.classList.remove('active'), 600); }
            showNotification(`Pace set to ${next}`, 'success');
        }
        function toggleReminders() {
            AppState.preferences.reminders = !AppState.preferences.reminders;
            const reminderChip = document.getElementById('reminderChip');
            if (reminderChip) {
                reminderChip.textContent = AppState.preferences.reminders ? 'üîî Gentle Reminders' : 'üîï Reminders Off';
                reminderChip.classList.toggle('active', AppState.preferences.reminders);
            }
            updateHeroSummary();
        }

        function updateHeroSummary() {
            const { pace, reminders, mode, focus } = AppState.preferences;
            const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
            setText('heroPace', `${pace} ¬∑ steady breathing`);
            setText('heroReminders', reminders ? 'On ¬∑ gentle nudges' : 'Off ¬∑ silent focus');
            setText('heroMode', `${mode} mode`);
            setText('heroFocus', `${focus} today`);
            setText('miniMode', mode);
            updateWellnessCards();
        }

        function updateProgressUI() {
            const percent = Math.min(100, Math.round((AppState.results.totalReps / totalGoalReps) * 100));
            const fill = document.getElementById('progressFill');
            const label = document.getElementById('progressLabel');
            const meta = document.getElementById('progressMeta');
            if (fill) fill.style.width = `${percent}%`;
            if (label) label.textContent = `${percent}% ready`;
            if (meta) meta.textContent = `${AppState.results.totalReps}/${totalGoalReps} gentle reps`;
        }

        function updateWellnessCards() {
            const paceMap = { Gentle: 'Inhale 4s ¬∑ Exhale 6s', Steady: 'Inhale 4s ¬∑ Exhale 4s', Confident: 'Inhale 5s ¬∑ Exhale 5s' };
            const breathCue = document.getElementById('breathCue');
            const reminderCue = document.getElementById('reminderCue');
            const focusBadge = document.getElementById('focusBadge');
            const paceCue = document.getElementById('paceCue');
            const stateChip = document.getElementById('sessionStateChip');
            if (breathCue) breathCue.textContent = paceMap[AppState.preferences.pace] || paceMap.Gentle;
            if (paceCue) paceCue.textContent = `${AppState.preferences.pace} pace`;
            if (reminderCue) reminderCue.textContent = AppState.preferences.reminders ? 'Reminders on ¬∑ gentle nudges' : 'Reminders paused ¬∑ stay mindful of breaks';
            if (focusBadge) focusBadge.textContent = `${AppState.preferences.focus} focus`;
            if (stateChip) {
                if (AppState.session.active && AppState.session.paused) stateChip.textContent = 'Paused ¬∑ tap resume';
                else if (AppState.session.active) stateChip.textContent = 'In session';
                else stateChip.textContent = 'Not started';
            }
        }

        function updateMiniSummary() {
            const miniStep = document.getElementById('miniStep');
            if (miniStep) miniStep.textContent = `Step ${AppState.currentStep} of 3`;
        }

        function initVoiceControl() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const statusEl = document.getElementById('voiceStatus');
            if (!SpeechRecognition) {
                AppState.voice.supported = false;
                if (statusEl) { statusEl.textContent = 'Voice control is not supported in this browser.'; statusEl.classList.remove('active'); }
                const toggle = document.getElementById('voiceToggle');
                if (toggle) toggle.disabled = true;
                return;
            }
            AppState.voice.supported = true;
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.onstart = () => updateVoiceUI(true, 'Listening... say a command like "start session".');
            recognition.onend = () => updateVoiceUI(false, 'Voice coach stopped. Tap to start again.');
            recognition.onerror = (event) => updateVoiceUI(false, `Oops, I ran into an issue: ${event.error}`);
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                handleVoiceCommand(transcript);
            };
            AppState.voice.recognition = recognition;
            if (statusEl) statusEl.textContent = 'Voice ready when you are.';
        }

        function bindVoiceToggle() {
            const toggle = document.getElementById('voiceToggle');
            if (!toggle) return;
            toggle.addEventListener('click', () => {
                if (!AppState.voice.supported) return;
                if (AppState.voice.listening) AppState.voice.recognition.stop();
                else AppState.voice.recognition.start();
                AppState.voice.listening = !AppState.voice.listening;
                toggle.classList.toggle('active', AppState.voice.listening);
                toggle.setAttribute('aria-pressed', AppState.voice.listening.toString());
                toggle.innerHTML = AppState.voice.listening ? '<span>üõë Stop Voice Coach</span>' : '<span>üé§ Start Voice Coach</span>';
            });
        }

        function updateVoiceUI(active, message) {
            const statusEl = document.getElementById('voiceStatus');
            const responseEl = document.getElementById('voiceResponse');
            const toggle = document.getElementById('voiceToggle');
            AppState.voice.listening = active;
            if (statusEl) { statusEl.textContent = message; statusEl.classList.toggle('active', active); }
            if (responseEl) responseEl.textContent = message;
            if (toggle) {
                toggle.classList.toggle('active', active);
                toggle.setAttribute('aria-pressed', active.toString());
                toggle.innerHTML = active ? '<span>üõë Stop Voice Coach</span>' : '<span>üé§ Start Voice Coach</span>';
            }
        }

        function handleVoiceCommand(transcript) {
            const text = transcript.toLowerCase();
            const responseEl = document.getElementById('voiceResponse');
            const reply = (message, type = 'info') => {
                if (responseEl) responseEl.textContent = `Heard: "${transcript}". ${message}`;
                if (type === 'success') showNotification(message, 'success');
            };
            if (text.includes('start session') || text.includes('begin session')) { startSession(); reply('Starting your session now.', 'success'); return; }
            if (text.includes('pause session')) {
                if (!AppState.session.active) { reply('You need to start the session before pausing.'); return; }
                if (!AppState.session.paused) { pauseSession(); reply('Session paused. Take your time.', 'success'); } else reply('Session is already paused.');
                return;
            }
            if (text.includes('resume session') || text.includes('continue session')) {
                if (!AppState.session.active) { reply('You need to start the session first.'); return; }
                if (AppState.session.paused) { pauseSession(); reply('Session resumed. Keep moving gently.', 'success'); } else reply('Session is already running.');
                return;
            }
            if (text.includes('finish session') || text.includes('complete session') || text.includes('end session')) { completeSession(); reply('Finishing your session now.', 'success'); return; }
            if (text.includes('next exercise')) { goToAdjacentExercise(1); reply('Moving to the next exercise.', 'success'); return; }
            if (text.includes('previous exercise') || text.includes('back exercise')) { goToAdjacentExercise(-1); reply('Returning to the previous exercise.', 'success'); return; }
            const increaseMatch = text.match(/(increase|add|plus)(?:.*?)(\d+)/);
            const decreaseMatch = text.match(/(decrease|remove|minus)(?:.*?)(\d+)/);
            if (increaseMatch) { const amount = parseInt(increaseMatch[2], 10) || 1; adjustReps(getActiveExerciseNumber(), amount); reply(`Adding ${amount} rep${amount === 1 ? '' : 's'} now.`, 'success'); return; }
            if (decreaseMatch) { const amount = parseInt(decreaseMatch[2], 10) || 1; adjustReps(getActiveExerciseNumber(), amount * -1); reply(`Removing ${amount} rep${amount === 1 ? '' : 's'} now.`, 'success'); return; }
            if (text.includes('increase reps') || text.includes('add reps')) { adjustReps(getActiveExerciseNumber(), 1); reply('Adding one rep.', 'success'); return; }
            if (text.includes('decrease reps') || text.includes('remove reps')) { adjustReps(getActiveExerciseNumber(), -1); reply('Taking one rep away.', 'success'); return; }
            if (text.includes('how many reps')) { const exercise = AppState.exercises[getActiveExerciseNumber()]; reply(`You have ${exercise.reps} rep${exercise.reps === 1 ? '' : 's'} logged for ${exercise.name}.`); return; }
            if (text.match(/go to exercise (\d+)/)) {
                const num = parseInt(text.match(/go to exercise (\d+)/)[1], 10);
                if (AppState.exercises[num]) { setActiveExercise(num, { scroll: true }); reply(`Switching to exercise ${num}.`, 'success'); }
                else reply('I could not find that exercise number.');
                return;
            }
            reply('I did not catch that command. Try saying "increase reps" or "next exercise".');
        }

        const getActiveExerciseNumber = () => AppState.currentExercise || 1;
        function goToAdjacentExercise(direction) {
            const current = getActiveExerciseNumber();
            const target = current + direction;
            const bounded = Math.min(Math.max(target, 1), Object.keys(AppState.exercises).length);
            setActiveExercise(bounded, { scroll: true });
        }

        function updateStepDisplay() {
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step, 10);
                step.classList.remove('active', 'completed');
                if (stepNum < AppState.currentStep) step.classList.add('completed');
                else if (stepNum === AppState.currentStep) step.classList.add('active');
            });
            document.querySelectorAll('[id^="step"]').forEach(section => section.classList.add('hidden'));
            const current = document.getElementById('step' + AppState.currentStep);
            if (current) current.classList.remove('hidden');
            expandActiveStepSection();
            updateStepBanner();
            refreshStepChips();
            updateMiniSummary();
        }
        function expandActiveStepSection() {
            const current = document.getElementById('step' + AppState.currentStep);
            if (current && current.dataset.collapsible !== undefined) setCollapsed(current, false);
        }
        function updateStepBanner() {
            const banner = document.getElementById('stepBanner');
            const labels = { 1: 'Check in gently', 2: 'Move mindfully', 3: 'Review & save' };
            if (banner) banner.textContent = `Step ${AppState.currentStep} ¬∑ ${labels[AppState.currentStep] || 'Your session'}`;
        }
        function refreshStepChips() { document.querySelectorAll('[data-step-chip]').forEach(chip => chip.classList.toggle('active', parseInt(chip.dataset.stepChip, 10) === AppState.currentStep)); }

        function startSession() {
            if (AppState.session.active) {
                AppState.session.paused = false;
                AppState.currentStep = Math.min(AppState.currentStep, 2);
                updateStepDisplay();
                startSessionTimer();
                updateDockUI();
                showNotification('Session resumed. Keep going!', 'success');
                return;
            }
            const nameInput = document.getElementById('userName');
            AppState.user.name = nameInput?.value.trim() || 'Marvin';
            AppState.currentStep = 2;
            AppState.session.active = true;
            AppState.user.sessionStart = new Date();
            AppState.session.duration = 0;
            AppState.session.paused = false;
            updateStepDisplay();
            setActiveExercise(1);
            startSessionTimer();
            showNotification('Session started! Take your time with each exercise.');
            updateDockUI();
            updateWellnessCards();
        }

        function setActiveExercise(exerciseNum, options = { scroll: false }) {
            AppState.currentExercise = exerciseNum;
            document.querySelectorAll('.exercise-card').forEach(card => {
                const cardNum = parseInt(card.dataset.exercise, 10);
                const status = card.querySelector('.exercise-status');
                const exercise = AppState.exercises[cardNum];
                if (cardNum === exerciseNum) {
                    card.classList.add('active');
                    if (!exercise.completed && status) status.textContent = 'Current';
                    if (options.scroll) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    card.classList.remove('active');
                    if (!exercise.completed && status) status.textContent = 'Up Next';
                    else if (status) status.textContent = 'Completed ‚úì';
                }
            });
            updateExerciseNav();
            updateDockUI();
        }

        function startSessionTimer() {
            if (AppState.session.timer) clearInterval(AppState.session.timer);
            AppState.session.timer = setInterval(() => { if (!AppState.session.paused) { AppState.session.duration++; updateTimerDisplay(); } }, 1000);
        }
        function updateTimerDisplay() {
            const minutes = Math.floor(AppState.session.duration / 60);
            const seconds = AppState.session.duration % 60;
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerEls = ['sessionTimer', 'sessionDuration', 'dockTimer'];
            timerEls.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = timeStr; });
        }

        function adjustReps(exerciseNum, change) {
            const exercise = AppState.exercises[exerciseNum];
            const newReps = exercise.reps + change;
            if (newReps < 0 || newReps > exercise.goal + 5) return;
            const wasCompleted = exercise.completed;
            exercise.reps = newReps;
            exercise.completed = newReps >= exercise.goal;
            const repEl = document.getElementById('reps' + exerciseNum);
            if (repEl) repEl.textContent = newReps;
            const card = document.querySelector(`[data-exercise="${exerciseNum}"]`);
            if (card) {
                card.classList.toggle('completed', exercise.completed);
                const status = card.querySelector('.exercise-status');
                if (status) status.textContent = exercise.completed ? 'Completed ‚úì' : (exerciseNum === AppState.currentExercise ? 'Current' : 'Up Next');
            }
            if (exercise.completed && !wasCompleted) { setTimeout(() => advanceToNextExercise(exerciseNum), 400); showNotification(`${exercise.name} feels good. Nice work!`, 'success'); }
            updateTotalReps();
            updateExercisesCompleted();
            updateExerciseNav();
            updateDockUI();
        }

        function updateTotalReps() {
            AppState.results.totalReps = Object.values(AppState.exercises).reduce((total, ex) => total + ex.reps, 0);
            const totalEl = document.getElementById('totalReps');
            if (totalEl) totalEl.textContent = AppState.results.totalReps;
            updateProgressUI();
        }
        function updateExercisesCompleted() {
            AppState.results.exercisesCompleted = Object.values(AppState.exercises).filter(ex => ex.completed).length;
            const doneEl = document.getElementById('exercisesDone');
            if (doneEl) doneEl.textContent = `${AppState.results.exercisesCompleted}/${Object.keys(AppState.exercises).length}`;
        }
        function advanceToNextExercise(currentExercise) {
            const nextExercise = currentExercise + 1;
            if (AppState.exercises[nextExercise]) { setActiveExercise(nextExercise, { scroll: true }); showNotification(`Great job! Moving to ${AppState.exercises[nextExercise].name}`, 'success'); }
            else showNotification('All exercises completed! Ready to finish.', 'success');
        }
        function completeCurrentExercise() {
            const num = getActiveExerciseNumber();
            const exercise = AppState.exercises[num];
            if (!exercise) return;
            exercise.reps = Math.max(exercise.reps, exercise.goal);
            exercise.completed = true;
            const card = document.querySelector(`[data-exercise="${num}"]`);
            if (card) {
                card.classList.add('completed');
                const status = card.querySelector('.exercise-status');
                if (status) status.textContent = 'Completed ‚úì';
                const repEl = card.querySelector('.rep-count');
                if (repEl) repEl.textContent = exercise.reps;
            }
            updateTotalReps();
            updateExercisesCompleted();
            updateExerciseNav();
            updateDockUI();
            advanceToNextExercise(num);
        }

        function updateExerciseNav() {
            const total = Object.keys(AppState.exercises).length;
            const current = getActiveExerciseNumber();
            const navLabel = document.getElementById('navCurrent');
            const navMode = document.getElementById('navMode');
            const dockExercise = document.getElementById('dockExercise');
            if (navLabel) navLabel.textContent = `Exercise ${current} of ${total}`;
            if (dockExercise) dockExercise.textContent = `${current}/${total} ¬∑ ${AppState.exercises[current]?.name || 'Warmup'}`;
            if (navMode) navMode.textContent = `${AppState.preferences.mode} walkthrough`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `position: fixed; top: 96px; left: 50%; transform: translateX(-50%); background: ${type === 'success' ? 'var(--jade-600)' : '#0ea5e9'}; color: white; padding: 1rem 1.3rem; border-radius: 14px; box-shadow: 0 14px 32px rgba(0,0,0,0.2); z-index: 50; font-weight: 800;`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '0'; notification.style.transition = 'opacity 0.3s ease'; setTimeout(() => notification.remove(), 300); }, 2600);
        }

        function pauseSession() {
            AppState.session.paused = !AppState.session.paused;
            const btn = document.getElementById('pauseBtn');
            if (btn) btn.innerHTML = AppState.session.paused ? '<span>‚ñ∂Ô∏è Resume Session</span>' : '<span>‚è∏Ô∏è Pause Session</span>';
            showNotification(AppState.session.paused ? 'Session paused - take your time' : 'Session resumed', AppState.session.paused ? 'info' : 'success');
            updateDockUI();
            updateWellnessCards();
        }

        function completeSession() {
            if (AppState.results.totalReps === 0) { if (!confirm("You haven't started any exercises. Complete session anyway?")) return; }
            AppState.currentStep = 3;
            AppState.session.active = false;
            clearInterval(AppState.session.timer);
            updateStepDisplay();
            showNotification('Session completed! Great work today!', 'success');
            const painChange = document.getElementById('painChange');
            if (painChange) painChange.textContent = AppState.user.painLevel.toFixed(1);
            updateDockUI();
            updateWellnessCards();
        }

        const returnToExercises = () => { AppState.currentStep = 2; updateStepDisplay(); };
        function saveAndFinish() {
            const saveBtn = document.querySelector('#step3 .btn-primary');
            if (!saveBtn) return;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span>Saving...</span>';
            saveBtn.disabled = true;
            setTimeout(() => {
                showNotification('Session saved successfully!', 'success');
                setTimeout(() => { saveBtn.innerHTML = originalText; saveBtn.disabled = false; alert('Great work today! Your progress has been recorded. See you next time!'); }, 500);
            }, 1500);
        }

        function updateDockUI() {
            const dockStatus = document.getElementById('dockStatus');
            const dockTimer = document.getElementById('dockTimer');
            if (dockStatus) {
                if (AppState.session.active && AppState.session.paused) dockStatus.textContent = 'Paused';
                else if (AppState.session.active) dockStatus.textContent = 'In Session';
                else dockStatus.textContent = 'Idle';
            }
            if (dockTimer) {
                const minutes = Math.floor(AppState.session.duration / 60);
                const seconds = AppState.session.duration % 60;
                dockTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        function toggleStartOrResume() {
            if (AppState.session.active) {
                AppState.session.paused = false;
                startSessionTimer();
                updateDockUI();
                showNotification('Session resumed.', 'success');
            } else {
                startSession();
            }
        }
    </script>
</body>
</html>
