<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rehab Harmony | Gentle Recovery</title>
    <style>
        /* RESET & BASE */
        :root {
            --green-500: #10b981;
            --green-400: #34d399;
            --green-300: #6ee7b7;
            --green-100: #d1fae5;
            --green-50: #ecfdf5;
            --slate-900: #0f172a;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --blue-100: #dbeafe;
            --blue-50: #eff6ff;
            --orange-500: #f59e0b;
            --red-500: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: radial-gradient(circle at 10% 20%, #f0fdf4 0, #f8fafc 45%, #e0f2fe 100%);
            color: var(--slate-900);
            line-height: 1.8;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 18px;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* UTILITY */
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        
        html { scroll-behavior: smooth; }
        
        /* CONTAINER */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1.5rem;
            width: min(1100px, calc(100% - 2rem));
        }

        /* TOP NAVIGATION */
        .utility-bar {
            position: sticky;
            top: 92px;
            z-index: 90;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 2px solid var(--slate-200);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(12px);
        }

        .utility-inner {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 1.5rem;
            align-items: center;
            padding: 1rem 0;
        }

        .utility-actions,
        .utility-menus {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .utility-actions {
            justify-content: flex-start;
        }

        .utility-chip {
            padding: 0.75rem 1.25rem;
            border-radius: 999px;
            border: 2px solid var(--slate-200);
            background: white;
            color: var(--slate-700);
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .utility-chip.active {
            border-color: var(--green-500);
            background: linear-gradient(135deg, var(--green-50), var(--green-100));
            color: var(--slate-900);
            box-shadow: 0 10px 24px rgba(16, 185, 129, 0.15);
        }

        .utility-select {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: white;
            border: 2px solid var(--slate-200);
            border-radius: 16px;
            padding: 0.75rem 1rem;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
        }

        .utility-select label {
            font-weight: 800;
            color: var(--slate-700);
        }

        .utility-select select,
        .utility-select button {
            border: none;
            background: var(--slate-50);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 700;
            color: var(--slate-700);
            cursor: pointer;
        }

        .utility-select button {
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.35);
        }

        .mode-pill-group {
            display: inline-flex;
            background: var(--slate-50);
            border: 2px solid var(--slate-200);
            border-radius: 999px;
            overflow: hidden;
        }

        .mode-pill {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            font-weight: 800;
            color: var(--slate-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-pill.active {
            background: white;
            color: var(--slate-900);
            box-shadow: inset 0 -2px 0 var(--green-500);
        }
        
        /* GLASS EFFECTS */
        .glass {
            background: white;
            border: 2px solid var(--slate-200);
            box-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
            border-radius: 24px;
        }

        /* VOICE CONTROL */
        .voice-card {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: 1fr;
            align-items: start;
        }

        .voice-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .voice-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: 14px;
            border: 3px solid var(--slate-200);
            background: linear-gradient(135deg, var(--green-50), var(--green-100));
            color: var(--slate-900);
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-toggle.active {
            border-color: var(--green-500);
            background: linear-gradient(135deg, var(--green-400), var(--green-300));
            color: white;
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.25);
        }

        .voice-toggle:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .voice-status {
            font-weight: 700;
            color: var(--slate-600);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: var(--slate-50);
            border: 2px solid var(--slate-200);
        }

        .voice-status.active {
            background: #ecfdf3;
            border-color: var(--green-200);
            color: #065f46;
        }

        .voice-response {
            background: var(--blue-50);
            border: 3px solid var(--blue-100);
            padding: 1.25rem 1.5rem;
            border-radius: 16px;
            font-weight: 700;
            color: var(--slate-700);
            line-height: 1.6;
        }

        .voice-commands {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
            padding: 0;
            margin: 0;
        }

        .voice-command {
            padding: 0.85rem 1rem;
            border-radius: 14px;
            background: var(--slate-50);
            border: 2px solid var(--slate-200);
            color: var(--slate-700);
            font-weight: 700;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .voice-command span {
            color: var(--green-600);
        }
        
        /* HEADER */
        .header {
            padding: 1.25rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.92);
            border-bottom: 3px solid #e0f2fe;
            box-shadow: 0 8px 28px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(12px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }
        
        .logo-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }
        
        .logo-text h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--slate-900);
            margin-bottom: 0.25rem;
        }
        
        .logo-text p {
            font-size: 1.125rem;
            color: var(--slate-500);
            font-weight: 500;
        }
        
        /* USER INFO */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .user-avatar {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            border: 3px solid white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }
        
        .time-display {
            font-family: 'SF Mono', monospace;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--slate-900);
            background: white;
            padding: 0.75rem 1.25rem;
            border-radius: 16px;
            border: 2px solid #e0f2fe;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }
        
        /* HERO SECTION */
        .hero {
            padding: 3rem 0 2rem;
            text-align: center;
        }
        
        .hero h2 {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--slate-900);
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .hero p {
            font-size: 1.5rem;
            color: var(--slate-600);
            max-width: 700px;
            margin: 0 auto 2rem;
            font-weight: 500;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin: 1.5rem auto 0;
            max-width: 920px;
        }

        .hero-card {
            padding: 1.25rem 1.5rem;
            border-radius: 18px;
            border: 2px solid var(--slate-200);
            background: white;
            text-align: left;
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
        }

        .hero-card strong {
            display: block;
            font-size: 1.25rem;
            margin-bottom: 0.35rem;
            color: var(--slate-900);
        }

        .hero-card span {
            color: var(--slate-600);
            font-weight: 600;
        }

        .step-banner {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            background: var(--green-50);
            color: #065f46;
            font-weight: 800;
            font-size: 1.25rem;
            box-shadow: 0 8px 18px rgba(16, 185, 129, 0.15);
            border: 2px solid var(--green-100);
            margin-bottom: 1.5rem;
        }

        /* STEP NAVIGATION */
        .step-nav {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin: 3rem 0;
            position: relative;
            padding: 0 1rem;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
        }
        
        .step-nav::before {
            content: '';
            position: absolute;
            top: 40px;
            left: 15%;
            right: 15%;
            height: 4px;
            background: #e0f2fe;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            scroll-snap-align: center;
            min-width: 160px;
        }
        
        .step-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--slate-200);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-weight: 900;
            font-size: 2rem;
            color: var(--slate-400);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
        }
        
        .step.active .step-circle {
            border-color: var(--green-500);
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            color: white;
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.3);
        }
        
        .step.completed .step-circle {
            border-color: var(--green-500);
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            color: white;
        }
        
        .step-number {
            position: relative;
            z-index: 2;
        }
        
        .step-label {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--slate-400);
            transition: color 0.3s ease, transform 0.3s ease;
        }
        
        .step.active .step-label {
            color: var(--slate-900);
            font-weight: 800;
            transform: translateY(-4px);
            font-size: 1.375rem;
        }
        
        /* MAIN CONTENT */
        .main-content {
            padding-bottom: 4rem;
        }
        
        /* SECTION CARDS */
        .section-card {
            border-radius: 32px;
            padding: 3rem;
            margin-bottom: 2rem;
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        .section-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(120% 120% at 0% 0%, rgba(16, 185, 129, 0.08), transparent 40%),
                        radial-gradient(120% 120% at 100% 0%, rgba(59, 130, 246, 0.05), transparent 35%);
            opacity: 0.6;
            z-index: -1;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--slate-900);
            margin-bottom: 1rem;
        }
        
        .section-subtitle {
            font-size: 1.375rem;
            color: var(--slate-500);
            margin-bottom: 2.5rem;
            font-weight: 500;
        }
        
        /* FORM ELEMENTS */
        .input-group {
            margin-bottom: 2rem;
        }
        
        .input-label {
            display: block;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        
        .input-field {
            width: 100%;
            padding: 1.15rem 1.25rem;
            border: 3px solid var(--slate-200);
            border-radius: 16px;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            background: white;
            font-weight: 600;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--green-500);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }
        
        /* PAIN SLIDER */
        .pain-slider-container {
            padding: 2.5rem;
            background: linear-gradient(135deg, var(--green-50), var(--green-100));
            border-radius: 24px;
            margin: 2.5rem 0;
            border: 3px solid var(--green-100);
        }
        
        .pain-visual {
            position: relative;
            height: 100px;
            margin: 2.5rem 0;
        }
        
        .pain-track {
            height: 16px;
            background: linear-gradient(90deg, var(--green-500), var(--orange-500), var(--red-500));
            border-radius: 999px;
            position: relative;
            margin: 42px 0;
            outline: none;
            box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.05);
        }
        
        .pain-handle {
            position: absolute;
            top: -32px;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
            transform: translateX(-50%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.75rem;
            color: var(--slate-900);
            transition: all 0.2s ease;
            border: 4px solid var(--green-500);
        }
        
        .pain-handle:hover {
            transform: translateX(-50%) scale(1.1);
        }
        
        .pain-handle:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        .pain-handle:focus-visible {
            box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.3);
        }

        .pain-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            color: var(--slate-600);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        /* EXERCISE CARDS */
        .exercise-grid {
            display: grid;
            gap: 2rem;
            margin: 2rem auto;
            max-width: 820px;
        }

        .exercise-card {
            border-radius: 24px;
            padding: 2rem;
            background: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid var(--slate-200);
            box-shadow: 0 12px 26px rgba(15, 23, 42, 0.06);
            display: none;
            position: relative;
        }
        
        .exercise-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--green-500), var(--green-400));
            transform: scaleX(0);
            transition: transform 0.4s ease;
            border-radius: 24px 24px 0 0;
        }
        
        .exercise-card.active {
            display: block;
            border-color: var(--green-500);
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.15);
        }
        
        .exercise-card.active::before {
            transform: scaleX(1);
        }
        
        .exercise-card.completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
            border-color: var(--green-400);
        }
        
        .exercise-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .exercise-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--green-50), var(--green-100));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 2px solid var(--green-100);
        }
        
        .exercise-card.completed .exercise-icon {
            background: linear-gradient(135deg, var(--green-100), var(--green-400));
        }
        
        .exercise-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--slate-900);
            flex: 1;
        }
        
        .exercise-status {
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: var(--slate-100);
            color: var(--slate-600);
            border: 2px solid var(--slate-200);
        }
        
        .exercise-card.active .exercise-status {
            background: var(--green-500);
            color: white;
            border-color: var(--green-500);
        }
        
        .exercise-card.completed .exercise-status {
            background: var(--green-500);
            color: white;
            border-color: var(--green-500);
        }
        
        .exercise-description {
            color: var(--slate-600);
            margin-bottom: 1.5rem;
            line-height: 1.8;
            font-size: 1.125rem;
            font-weight: 500;
        }
        
        /* REP COUNTER */
        .rep-counter {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .rep-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            color: white;
            font-size: 2rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
            touch-action: manipulation;
        }
        
        .rep-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
        }
        
        .rep-btn:active {
            transform: translateY(0);
        }
        
        .rep-count {
            font-size: 2.5rem;
            font-weight: 900;
            min-width: 80px;
            text-align: center;
            color: var(--slate-900);
            font-feature-settings: "tnum";
        }
        
        .rep-goal {
            color: var(--slate-500);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        /* SESSION TIMER */
        .session-timer {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            background: linear-gradient(135deg, var(--green-50), var(--green-100));
            border-radius: 24px;
            border: 3px solid var(--green-100);
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 900;
            color: var(--green-500);
            font-feature-settings: "tnum";
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', monospace;
        }
        
        .timer-label {
            color: var(--slate-500);
            font-size: 1.125rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        /* EXERCISE NAV BAR */
        .exercise-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 1.25rem 1.5rem;
            border: 2px dashed var(--slate-200);
            border-radius: 18px;
            background: var(--slate-50);
            margin-bottom: 1.5rem;
        }

        .mini-badge {
            padding: 0.5rem 0.85rem;
            border-radius: 12px;
            background: white;
            border: 2px solid var(--slate-200);
            font-weight: 800;
            color: var(--slate-700);
        }

        .nav-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .ghost-btn {
            padding: 0.75rem 1.25rem;
            border-radius: 14px;
            border: 2px solid var(--slate-200);
            background: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ghost-btn:hover {
            background: var(--slate-100);
        }

        /* CONTROL DOCK */
        .control-dock {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: white;
            border: 3px solid var(--slate-200);
            border-radius: 24px;
            padding: 1rem;
            box-shadow: 0 18px 48px rgba(15, 23, 42, 0.18);
            display: grid;
            gap: 0.75rem;
            min-width: 280px;
            z-index: 999;
        }

        .dock-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 800;
            color: var(--slate-800);
        }

        .dock-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .dock-btn {
            padding: 0.9rem 1rem;
            border-radius: 16px;
            border: 2px solid var(--slate-200);
            background: var(--slate-50);
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dock-btn.primary {
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            color: white;
            border-color: transparent;
            box-shadow: 0 10px 26px rgba(16, 185, 129, 0.4);
        }

        .dock-btn.secondary {
            background: white;
        }

        .dock-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            color: var(--slate-600);
        }
        
        /* ACTION BUTTONS */
        .action-buttons {
            display: flex;
            gap: 1.5rem;
            margin-top: 3rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 1.5rem 2.5rem;
            border: none;
            border-radius: 20px;
            font-weight: 800;
            font-size: 1.375rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex: 1;
            letter-spacing: 0.01em;
            min-height: 72px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            color: white;
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 16px 40px rgba(16, 185, 129, 0.5);
        }

        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 10px 28px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: var(--slate-600);
            border: 3px solid var(--slate-200);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        }
        
        .btn-secondary:hover {
            background: var(--slate-50);
            border-color: var(--slate-300);
            transform: translateY(-2px);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }
        
        /* COMPLETION SCREEN */
        .completion-screen {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .celebration-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--green-500), var(--green-400));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            color: white;
            font-size: 4rem;
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }
        
        .result-card {
            background: white;
            padding: 2rem;
            border-radius: 24px;
            text-align: center;
            border: 3px solid var(--slate-200);
        }
        
        .result-value {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--green-500);
            margin-bottom: 0.5rem;
        }
        
        .result-label {
            color: var(--slate-500);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }

            .container {
                padding: 0 1rem;
                width: min(100%, calc(100% - 1.5rem));
            }
            
            .hero h2 {
                font-size: 2.5rem;
            }

            .hero p {
                font-size: 1.25rem;
            }

            .step-nav {
                gap: 1.25rem;
                margin: 2rem -0.5rem;
                padding: 0 0.5rem 0.75rem;
                justify-content: flex-start;
            }

            .step-nav::before {
                display: none;
            }

            .step {
                min-width: 140px;
            }

            .step-circle {
                width: 64px;
                height: 64px;
                font-size: 1.5rem;
            }

            .step-label {
                font-size: 1rem;
            }

            .step.active .step-label {
                font-size: 1.125rem;
            }
            
            .section-card {
                padding: 2rem 1.5rem;
                margin-bottom: 1.5rem;
            }

            .section-title {
                font-size: 2rem;
            }

            .section-subtitle {
                font-size: 1.125rem;
            }

            .pain-slider-container {
                padding: 1.75rem;
                margin: 2rem 0;
            }

            .session-timer {
                padding: 1.5rem;
            }

            .timer-display {
                font-size: 3rem;
            }

            .exercise-card {
                padding: 1.5rem;
            }

            .rep-counter {
                gap: 1rem;
            }

            .btn {
                font-size: 1.125rem;
                padding: 1.25rem 2rem;
                min-height: 64px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .utility-inner {
                grid-template-columns: 1fr;
            }

            .utility-bar {
                top: 80px;
            }

            .control-dock {
                position: static;
                margin: 1rem auto 0;
                max-width: 420px;
            }
        }

        @media (max-width: 540px) {
            .header {
                padding: 1rem 0;
            }

            .header-content {
                gap: 0.75rem;
            }

            .logo-text h1 {
                font-size: 1.4rem;
            }

            .logo-text p,
            .time-display {
                font-size: 1rem;
            }

            .hero {
                padding: 2.25rem 0 1.5rem;
            }

            .hero p {
                font-size: 1.1rem;
            }

            .step-banner {
                width: 100%;
                justify-content: center;
            }

            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .rep-counter {
                justify-content: space-around;
            }

            .action-buttons .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚ù§Ô∏è</div>
                    <div class="logo-text">
                        <h1>Rehab Harmony</h1>
                        <p>Gentle Recovery Journey</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar">M</div>
                    <div class="time-display" id="currentTime">11:42 AM</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Utility Bar -->
    <div class="utility-bar">
        <div class="container">
            <div class="utility-inner">
                <div class="utility-actions">
                    <button class="utility-chip active" data-scroll="#step1" data-step="1" data-step-chip="1">Step 1 ¬∑ Check-in</button>
                    <button class="utility-chip" data-scroll="#step2" data-step="2" data-step-chip="2">Step 2 ¬∑ Exercises</button>
                    <button class="utility-chip" data-scroll="#step3" data-step="3" data-step-chip="3">Step 3 ¬∑ Complete</button>
                    <button class="utility-chip active" id="paceChip">Gentle Pace</button>
                    <button class="utility-chip active" id="reminderChip">üîî Gentle Reminders</button>
                    <button class="utility-chip" id="voiceChip">üéôÔ∏è Voice Coach</button>
                </div>
                <div class="utility-menus">
                    <div class="utility-select">
                        <label for="focusSelect">Focus</label>
                        <select id="focusSelect">
                            <option>Mobility</option>
                            <option>Strength</option>
                            <option>Balance</option>
                            <option>Breathwork</option>
                        </select>
                        <button type="button" id="applyFocus">Apply</button>
                    </div>
                    <div class="mode-pill-group" role="group" aria-label="Guidance style">
                        <button class="mode-pill active" data-mode="Guided">Guided</button>
                        <button class="mode-pill" data-mode="Manual">Manual</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hero -->
    <section class="hero">
        <div class="container">
            <div class="step-banner" aria-live="polite" id="stepBanner">Step 1 ¬∑ Check in gently</div>
            <h2>Your Gentle Recovery</h2>
            <p>Follow three simple steps to rebuild strength without overwhelm.</p>

            <div class="hero-grid">
                <div class="hero-card">
                    <strong id="heroMode">Guided mode</strong>
                    <span>Voice + on-screen tips</span>
                </div>
                <div class="hero-card">
                    <strong id="heroFocus">Mobility today</strong>
                    <span>Pre-selected routine</span>
                </div>
                <div class="hero-card">
                    <strong id="heroPace">Gentle ¬∑ steady breathing</strong>
                    <span>Change pace anytime</span>
                </div>
                <div class="hero-card">
                    <strong id="heroReminders">On ¬∑ gentle nudges</strong>
                    <span>Remind me to pause & hydrate</span>
                </div>
            </div>
            
            <!-- Step Navigation -->
            <div class="step-nav">
                <div class="step active" data-step="1">
                    <div class="step-circle">
                        <span class="step-number">1</span>
                    </div>
                    <div class="step-label">Check In</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">
                        <span class="step-number">2</span>
                    </div>
                    <div class="step-label">Exercises</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">
                        <span class="step-number">3</span>
                    </div>
                    <div class="step-label">Complete</div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Voice Control -->
            <section class="section-card glass voice-card" aria-labelledby="voiceControlHeading">
                <div>
                    <h2 class="section-title" id="voiceControlHeading">Voice Coach</h2>
                    <p class="section-subtitle">Control your session hands-free with simple, gentle commands.</p>
                    <ul class="voice-commands">
                        <li class="voice-command">üéôÔ∏è <span>"Start session"</span> to begin</li>
                        <li class="voice-command">üéôÔ∏è <span>"Pause session"</span> or <span>"Resume session"</span></li>
                        <li class="voice-command">üéôÔ∏è <span>"Next exercise"</span> or <span>"Previous exercise"</span></li>
                        <li class="voice-command">üéôÔ∏è <span>"Increase reps"</span> / <span>"Decrease reps"</span> (say a number too!)</li>
                        <li class="voice-command">üéôÔ∏è <span>"Finish session"</span> when you're done</li>
                    </ul>
                </div>
                <div class="voice-controls">
                    <button class="voice-toggle" id="voiceToggle" type="button" aria-pressed="false">
                        <span>üé§ Start Voice Coach</span>
                    </button>
                    <div class="voice-status" id="voiceStatus" aria-live="polite">Voice ready when you are.</div>
                </div>
                <div class="voice-response" id="voiceResponse" aria-live="polite">
                    Voice responses will appear here so you always know what was heard.
                </div>
            </section>

            <!-- Step 1: Check In -->
            <section id="step1" class="section-card glass">
                <h2 class="section-title">How are you feeling today?</h2>
                <p class="section-subtitle">A quick check-in helps us tailor your session</p>
                
                <div class="input-group">
                    <label class="input-label">Your Name</label>
                    <input type="text" class="input-field" value="Marvin" id="userName" placeholder="Enter your name">
                </div>
                
                <div class="pain-slider-container">
                    <label class="input-label">Current Pain Level</label>
                    <div class="pain-visual">
                        <div class="pain-track" id="painTrack">
                            <div class="pain-handle" id="painHandle" style="left: 25%;" role="slider" aria-valuemin="0" aria-valuemax="10" aria-valuenow="2.5" aria-label="Pain level" tabindex="0">2.5</div>
                        </div>
                    </div>
                    <div class="pain-labels">
                        <span>No Pain</span>
                        <span>Moderate</span>
                        <span>Severe</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="startSession()">
                        <span>Start Today's Session</span>
                        <span>‚Üí</span>
                    </button>
                </div>
            </section>
            
            <!-- Step 2: Exercises -->
            <section id="step2" class="section-card glass hidden">
                <h2 class="section-title">Today's Gentle Exercises</h2>
                <p class="section-subtitle">One exercise at a time‚Äîclear instructions so you can move with confidence.</p>

                <div class="exercise-nav">
                    <span class="mini-badge" id="navCurrent">Exercise 1 of 3</span>
                    <span class="mini-badge">Mode: <span id="navMode">Guided walkthrough</span></span>
                    <div class="nav-buttons">
                        <button class="ghost-btn" onclick="goToAdjacentExercise(-1)">‚Üê Previous</button>
                        <button class="ghost-btn" onclick="goToAdjacentExercise(1)">Next ‚Üí</button>
                        <button class="ghost-btn" onclick="completeCurrentExercise()">Mark complete</button>
                    </div>
                </div>

                <!-- Session Timer -->
                <div class="session-timer">
                    <div class="timer-display" id="sessionTimer" aria-live="polite">00:00</div>
                    <div class="timer-label">Session Duration</div>
                </div>

                <!-- Exercises Grid -->
                <div class="exercise-grid">
                    <!-- Exercise 1 -->
                    <div class="exercise-card active" data-exercise="1">
                        <div class="exercise-header">
                            <div class="exercise-icon">ü¶µ</div>
                            <div class="exercise-title">Heel Slides</div>
                            <span class="exercise-status">Current</span>
                        </div>
                        <div class="exercise-description">
                            Gently slide your heel toward your buttocks while keeping contact with the surface. 
                            Hold briefly, then slowly return. Move slow and steady‚Äîcomfort is key.
                        </div>
                        <div class="rep-counter">
                            <button class="rep-btn" onclick="adjustReps(1, -1)" aria-label="Decrease reps">‚àí</button>
                            <span class="rep-count" id="reps1">0</span>
                            <button class="rep-btn" onclick="adjustReps(1, 1)" aria-label="Increase reps">+</button>
                            <span class="rep-goal">Goal: 10 reps</span>
                        </div>
                    </div>
                    
                    <!-- Exercise 2 -->
                    <div class="exercise-card" data-exercise="2">
                        <div class="exercise-header">
                            <div class="exercise-icon">üí™</div>
                            <div class="exercise-title">Quad Sets</div>
                            <span class="exercise-status">Up Next</span>
                        </div>
                        <div class="exercise-description">
                            Tighten your thigh muscle as if trying to straighten your knee. 
                            Hold the contraction for 3-5 seconds, then relax completely. Breathe naturally throughout.
                        </div>
                        <div class="rep-counter">
                            <button class="rep-btn" onclick="adjustReps(2, -1)" aria-label="Decrease reps">‚àí</button>
                            <span class="rep-count" id="reps2">0</span>
                            <button class="rep-btn" onclick="adjustReps(2, 1)" aria-label="Increase reps">+</button>
                            <span class="rep-goal">Goal: 15 reps</span>
                        </div>
                    </div>
                    
                    <!-- Exercise 3 -->
                    <div class="exercise-card" data-exercise="3">
                        <div class="exercise-header">
                            <div class="exercise-icon">üèãÔ∏è</div>
                            <div class="exercise-title">Leg Raises</div>
                            <span class="exercise-status">Up Next</span>
                        </div>
                        <div class="exercise-description">
                            With knee straight, lift your leg 6-12 inches. Hold briefly, 
                            then lower with control. Keep breathing steady and stop if you feel any sharp pain.
                        </div>
                        <div class="rep-counter">
                            <button class="rep-btn" onclick="adjustReps(3, -1)" aria-label="Decrease reps">‚àí</button>
                            <span class="rep-count" id="reps3">0</span>
                            <button class="rep-btn" onclick="adjustReps(3, 1)" aria-label="Increase reps">+</button>
                            <span class="rep-goal">Goal: 10 reps</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="pauseSession()" id="pauseBtn">
                        <span>‚è∏Ô∏è Pause Session</span>
                    </button>
                    <button class="btn btn-primary" onclick="completeSession()">
                        <span>Finish Session</span>
                        <span>‚úì</span>
                    </button>
                </div>
            </section>
            
            <!-- Step 3: Completion -->
            <section id="step3" class="section-card glass hidden">
                <div class="completion-screen">
                    <div class="celebration-icon">üéâ</div>
                    <h2 class="section-title">Excellent Work Today!</h2>
                    <p class="section-subtitle">You're making great progress in your recovery journey</p>
                    
                    <!-- Results Summary -->
                    <div class="results-grid">
                        <div class="result-card glass">
                            <div class="result-value" id="totalReps">0</div>
                            <div class="result-label">Total Reps</div>
                        </div>
                        <div class="result-card glass">
                            <div class="result-value" id="exercisesDone">0/3</div>
                            <div class="result-label">Exercises Done</div>
                        </div>
                        <div class="result-card glass">
                            <div class="result-value" id="sessionDuration">00:00</div>
                            <div class="result-label">Time Spent</div>
                        </div>
                        <div class="result-card glass">
                            <div class="result-value" id="painChange">2.5</div>
                            <div class="result-label">Pain Level</div>
                        </div>
                    </div>
                    
                    <!-- Post-Session Notes -->
                    <div class="input-group">
                        <label class="input-label">Session Notes (Optional)</label>
                        <textarea class="input-field" rows="4" placeholder="How did you feel during the session? Any observations..." id="sessionNotes"></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="returnToExercises()">
                            <span>‚Ü∂ Return to Exercises</span>
                        </button>
                        <button class="btn btn-primary" onclick="saveAndFinish()">
                            <span>Save & Complete</span>
                            <span>‚úì</span>
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div class="control-dock" aria-label="Quick session controls">
        <div class="dock-header">
            <span>Quick Controls</span>
            <span id="dockStatus">Idle</span>
        </div>
        <div class="dock-controls">
            <button class="dock-btn primary" onclick="toggleStartOrResume()">Start / Resume</button>
            <button class="dock-btn secondary" onclick="pauseSession()">Pause / Play</button>
            <button class="dock-btn" onclick="goToAdjacentExercise(-1)">‚Üê Previous</button>
            <button class="dock-btn" onclick="goToAdjacentExercise(1)">Next ‚Üí</button>
            <button class="dock-btn" onclick="completeSession()">Finish</button>
            <button class="dock-btn" onclick="completeCurrentExercise()">Mark Exercise Done</button>
        </div>
        <div class="dock-meta">
            <span id="dockExercise">Exercise 1/3</span>
            <span id="dockTimer">00:00</span>
        </div>
    </div>

    <script>
        // State Management
        const AppState = {
            currentStep: 1,
            user: {
                name: 'Marvin',
                painLevel: 2.5,
                sessionStart: null
            },
            currentExercise: 1,
            exercises: {
                1: { name: 'Heel Slides', reps: 0, goal: 10, completed: false },
                2: { name: 'Quad Sets', reps: 0, goal: 15, completed: false },
                3: { name: 'Leg Raises', reps: 0, goal: 10, completed: false }
            },
            session: {
                active: false,
                paused: false,
                duration: 0,
                timer: null
            },
            voice: {
                recognition: null,
                listening: false,
                supported: false
            },
            preferences: {
                pace: 'Gentle',
                reminders: true,
                mode: 'Guided',
                focus: 'Mobility'
            },
            results: {
                totalReps: 0,
                exercisesCompleted: 0
            }
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initClock();
            setupPainSlider();
            setupPainSliderKeyboard();
            setupExerciseCardClicks();
            initVoiceControl();
            bindVoiceToggle();
            initUtilityBar();
            updateStepDisplay();
            updateTotalReps();
            updateHeroSummary();
            updateExerciseNav();
            updateDockUI();
        });
        
        // Live Clock
        function initClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                document.getElementById('currentTime').textContent = timeString;
            }
            updateClock();
            setInterval(updateClock, 1000);
        }
        
        // Setup Pain Slider
        function setupPainSlider() {
            const track = document.getElementById('painTrack');
            const handle = document.getElementById('painHandle');
            let dragging = false;
            
            function updatePainValue(clientX) {
                const rect = track.getBoundingClientRect();
                let percent = ((clientX - rect.left) / rect.width) * 100;
                percent = Math.max(0, Math.min(100, percent));
                
                const painValue = (percent / 10).toFixed(1);
                handle.style.left = percent + '%';
                handle.textContent = painValue;
                handle.setAttribute('aria-valuenow', painValue);
                AppState.user.painLevel = parseFloat(painValue);
                
                handle.style.transform = `translateX(-50%) scale(${dragging ? 1.1 : 1})`;
            }
            
            track.addEventListener('mousedown', (e) => {
                dragging = true;
                updatePainValue(e.clientX);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (dragging) updatePainValue(e.clientX);
            });
            
            document.addEventListener('mouseup', () => {
                dragging = false;
                handle.style.transform = 'translateX(-50%) scale(1)';
            });
            
            track.addEventListener('touchstart', (e) => {
                e.preventDefault();
                dragging = true;
                if (e.touches[0]) updatePainValue(e.touches[0].clientX);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (dragging && e.touches[0]) {
                    e.preventDefault();
                    updatePainValue(e.touches[0].clientX);
                }
            });
            
            document.addEventListener('touchend', () => {
                dragging = false;
                handle.style.transform = 'translateX(-50%) scale(1)';
            });
        }

        function setupPainSliderKeyboard() {
            const handle = document.getElementById('painHandle');
            if (!handle) return;

            const step = 0.5;
            const setFromValue = (value) => {
                const bounded = Math.min(10, Math.max(0, value));
                const percent = (bounded / 10) * 100;
                handle.style.left = percent + '%';
                handle.textContent = bounded.toFixed(1);
                handle.setAttribute('aria-valuenow', bounded.toFixed(1));
                AppState.user.painLevel = bounded;
            };

            handle.addEventListener('keydown', (e) => {
                if (['ArrowLeft', 'ArrowDown'].includes(e.key)) {
                    e.preventDefault();
                    setFromValue(AppState.user.painLevel - step);
                } else if (['ArrowRight', 'ArrowUp'].includes(e.key)) {
                    e.preventDefault();
                    setFromValue(AppState.user.painLevel + step);
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    setFromValue(0);
                } else if (e.key === 'End') {
                    e.preventDefault();
                    setFromValue(10);
                }
            });
        }

        function setupExerciseCardClicks() {
            const cards = document.querySelectorAll('.exercise-card');
            cards.forEach(card => {
                card.addEventListener('click', (event) => {
                    if (event.target.closest('.rep-btn')) return;
                    const exerciseNum = parseInt(card.dataset.exercise);
                    setActiveExercise(exerciseNum, { scroll: true });
                });
            });
        }

        // Utility Bar + Menus
        function initUtilityBar() {
            document.querySelectorAll('[data-scroll]').forEach(chip => {
                chip.addEventListener('click', () => {
                    const target = chip.getAttribute('data-scroll');
                    const step = parseInt(chip.getAttribute('data-step'), 10);
                    if (step) {
                        AppState.currentStep = step;
                        updateStepDisplay();
                    }
                    if (target) {
                        const el = document.querySelector(target);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            const voiceChip = document.getElementById('voiceChip');
            if (voiceChip) {
                voiceChip.addEventListener('click', () => {
                    const toggle = document.getElementById('voiceToggle');
                    if (toggle) toggle.click();
                });
            }

            const reminderChip = document.getElementById('reminderChip');
            if (reminderChip) {
                reminderChip.addEventListener('click', () => toggleReminders());
            }

            const paceChip = document.getElementById('paceChip');
            if (paceChip) {
                paceChip.addEventListener('click', () => cyclePace());
            }

            const focusSelect = document.getElementById('focusSelect');
            const applyFocus = document.getElementById('applyFocus');
            if (applyFocus && focusSelect) {
                applyFocus.addEventListener('click', () => {
                    AppState.preferences.focus = focusSelect.value;
                    showNotification(`Focus set to ${focusSelect.value}`, 'success');
                    updateHeroSummary();
                });
            }

            document.querySelectorAll('.mode-pill').forEach(pill => {
                pill.addEventListener('click', () => setMode(pill.dataset.mode));
            });
        }

        function setMode(mode) {
            AppState.preferences.mode = mode;
            document.querySelectorAll('.mode-pill').forEach(pill => {
                pill.classList.toggle('active', pill.dataset.mode === mode);
            });
            updateHeroSummary();
            updateExerciseNav();
        }

        function cyclePace() {
            const order = ['Gentle', 'Steady', 'Confident'];
            const currentIdx = order.indexOf(AppState.preferences.pace);
            const next = order[(currentIdx + 1) % order.length];
            AppState.preferences.pace = next;
            updateHeroSummary();
            const paceChip = document.getElementById('paceChip');
            if (paceChip) {
                paceChip.textContent = `${next} Pace`;
                paceChip.classList.add('active');
                setTimeout(() => paceChip.classList.remove('active'), 600);
            }
            showNotification(`Pace set to ${next}`, 'success');
        }

        function toggleReminders() {
            AppState.preferences.reminders = !AppState.preferences.reminders;
            const reminderChip = document.getElementById('reminderChip');
            if (reminderChip) {
                reminderChip.textContent = AppState.preferences.reminders ? 'üîî Gentle Reminders' : 'üîï Reminders Off';
                reminderChip.classList.toggle('active', AppState.preferences.reminders);
            }
            updateHeroSummary();
        }

        function updateHeroSummary() {
            const { pace, reminders, mode, focus } = AppState.preferences;
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };
            setText('heroPace', `${pace} ¬∑ steady breathing`);
            setText('heroReminders', reminders ? 'On ¬∑ gentle nudges' : 'Off ¬∑ silent focus');
            setText('heroMode', `${mode} mode`);
            setText('heroFocus', `${focus} today`);
        }

        // Voice Control
        function initVoiceControl() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const statusEl = document.getElementById('voiceStatus');

            if (!SpeechRecognition) {
                AppState.voice.supported = false;
                statusEl.textContent = 'Voice control is not supported in this browser.';
                statusEl.classList.remove('active');
                document.getElementById('voiceToggle').disabled = true;
                return;
            }

            AppState.voice.supported = true;
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => updateVoiceUI(true, 'Listening... say a command like "start session".');
            recognition.onend = () => updateVoiceUI(false, 'Voice coach stopped. Tap to start again.');
            recognition.onerror = (event) => {
                updateVoiceUI(false, `Oops, I ran into an issue: ${event.error}`);
            };
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                handleVoiceCommand(transcript);
            };

            AppState.voice.recognition = recognition;
            statusEl.textContent = 'Voice ready when you are.';
        }

        function bindVoiceToggle() {
            const toggle = document.getElementById('voiceToggle');
            toggle.addEventListener('click', () => {
                if (!AppState.voice.supported) return;
                if (AppState.voice.listening) {
                    AppState.voice.recognition.stop();
                } else {
                    AppState.voice.recognition.start();
                }
                AppState.voice.listening = !AppState.voice.listening;
                toggle.classList.toggle('active', AppState.voice.listening);
                toggle.setAttribute('aria-pressed', AppState.voice.listening.toString());
                toggle.innerHTML = AppState.voice.listening ? '<span>üõë Stop Voice Coach</span>' : '<span>üé§ Start Voice Coach</span>';
            });
        }

        function updateVoiceUI(active, message) {
            const statusEl = document.getElementById('voiceStatus');
            const responseEl = document.getElementById('voiceResponse');
            const toggle = document.getElementById('voiceToggle');

            AppState.voice.listening = active;
            statusEl.textContent = message;
            statusEl.classList.toggle('active', active);
            responseEl.textContent = message;
            toggle.classList.toggle('active', active);
            toggle.setAttribute('aria-pressed', active.toString());
            toggle.innerHTML = active ? '<span>üõë Stop Voice Coach</span>' : '<span>üé§ Start Voice Coach</span>';
        }

        function handleVoiceCommand(transcript) {
            const text = transcript.toLowerCase();
            const responseEl = document.getElementById('voiceResponse');

            const reply = (message, type = 'info') => {
                responseEl.textContent = `Heard: "${transcript}". ${message}`;
                if (type === 'success') {
                    showNotification(message, 'success');
                }
            };

            if (text.includes('start session') || text.includes('begin session')) {
                startSession();
                reply('Starting your session now.', 'success');
                return;
            }

            if (text.includes('pause session')) {
                if (!AppState.session.active) {
                    reply('You need to start the session before pausing.');
                    return;
                }
                if (!AppState.session.paused) {
                    pauseSession();
                    reply('Session paused. Take your time.', 'success');
                } else {
                    reply('Session is already paused.');
                }
                return;
            }

            if (text.includes('resume session') || text.includes('continue session')) {
                if (!AppState.session.active) {
                    reply('You need to start the session first.');
                    return;
                }
                if (AppState.session.paused) {
                    pauseSession();
                    reply('Session resumed. Keep moving gently.', 'success');
                } else {
                    reply('Session is already running.');
                }
                return;
            }

            if (text.includes('finish session') || text.includes('complete session') || text.includes('end session')) {
                completeSession();
                reply('Finishing your session now.', 'success');
                return;
            }

            if (text.includes('next exercise')) {
                goToAdjacentExercise(1);
                reply('Moving to the next exercise.', 'success');
                return;
            }

            if (text.includes('previous exercise') || text.includes('back exercise')) {
                goToAdjacentExercise(-1);
                reply('Returning to the previous exercise.', 'success');
                return;
            }

            const increaseMatch = text.match(/(increase|add|plus)(?:.*?)(\d+)/);
            const decreaseMatch = text.match(/(decrease|remove|minus)(?:.*?)(\d+)/);

            if (increaseMatch) {
                const amount = parseInt(increaseMatch[2], 10) || 1;
                adjustReps(getActiveExerciseNumber(), amount);
                reply(`Adding ${amount} rep${amount === 1 ? '' : 's'} now.`, 'success');
                return;
            }

            if (decreaseMatch) {
                const amount = parseInt(decreaseMatch[2], 10) || 1;
                adjustReps(getActiveExerciseNumber(), amount * -1);
                reply(`Removing ${amount} rep${amount === 1 ? '' : 's'} now.`, 'success');
                return;
            }

            if (text.includes('increase reps') || text.includes('add reps')) {
                adjustReps(getActiveExerciseNumber(), 1);
                reply('Adding one rep.', 'success');
                return;
            }

            if (text.includes('decrease reps') || text.includes('remove reps')) {
                adjustReps(getActiveExerciseNumber(), -1);
                reply('Taking one rep away.', 'success');
                return;
            }

            if (text.includes('how many reps')) {
                const exercise = AppState.exercises[getActiveExerciseNumber()];
                reply(`You have ${exercise.reps} rep${exercise.reps === 1 ? '' : 's'} logged for ${exercise.name}.`);
                return;
            }

            if (text.match(/go to exercise (\d+)/)) {
                const num = parseInt(text.match(/go to exercise (\d+)/)[1], 10);
                if (AppState.exercises[num]) {
                    setActiveExercise(num, { scroll: true });
                    reply(`Switching to exercise ${num}.`, 'success');
                } else {
                    reply('I could not find that exercise number.');
                }
                return;
            }

            reply('I did not catch that command. Try saying "increase reps" or "next exercise".');
        }

        function getActiveExerciseNumber() {
            return AppState.currentExercise || 1;
        }

        function goToAdjacentExercise(direction) {
            const current = getActiveExerciseNumber();
            const target = current + direction;
            const bounded = Math.min(Math.max(target, 1), Object.keys(AppState.exercises).length);
            setActiveExercise(bounded, { scroll: true });
        }
        
        // Step Navigation
        function updateStepDisplay() {
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                
                if (stepNum < AppState.currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === AppState.currentStep) {
                    step.classList.add('active');
                }
            });
            
            document.querySelectorAll('[id^="step"]').forEach(section => {
                section.classList.add('hidden');
            });
            const current = document.getElementById('step' + AppState.currentStep);
            if (current) current.classList.remove('hidden');
            updateStepBanner();
            refreshStepChips();
        }

        function updateStepBanner() {
            const banner = document.getElementById('stepBanner');
            if (!banner) return;
            const labels = {
                1: 'Check in gently',
                2: 'Move mindfully',
                3: 'Review & save'
            };
            const label = labels[AppState.currentStep] || 'Your session';
            banner.textContent = `Step ${AppState.currentStep} ¬∑ ${label}`;
        }

        function refreshStepChips() {
            document.querySelectorAll('[data-step-chip]').forEach(chip => {
                const stepNum = parseInt(chip.dataset.stepChip, 10);
                chip.classList.toggle('active', stepNum === AppState.currentStep);
            });
        }
        
        // Start Session
        function startSession() {
            if (AppState.session.active) {
                AppState.session.paused = false;
                AppState.currentStep = Math.min(AppState.currentStep, 2);
                updateStepDisplay();
                startSessionTimer();
                updateDockUI();
                showNotification('Session resumed. Keep going!', 'success');
                return;
            }
            AppState.user.name = document.getElementById('userName').value.trim() || 'Marvin';
            AppState.currentStep = 2;
            AppState.session.active = true;
            AppState.user.sessionStart = new Date();
            AppState.session.duration = 0;
            AppState.session.paused = false;

            updateStepDisplay();
            setActiveExercise(1);
            startSessionTimer();
            showNotification('Session started! Take your time with each exercise.');
            updateDockUI();
        }
        
        function setActiveExercise(exerciseNum, options = { scroll: false }) {
            AppState.currentExercise = exerciseNum;
            document.querySelectorAll('.exercise-card').forEach(card => {
                const cardNum = parseInt(card.dataset.exercise);
                const status = card.querySelector('.exercise-status');
                const exercise = AppState.exercises[cardNum];

                if (cardNum === exerciseNum) {
                    card.classList.add('active');
                    if (!exercise.completed) status.textContent = 'Current';
                    if (options.scroll) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    card.classList.remove('active');
                    if (!exercise.completed) status.textContent = 'Up Next';
                    else status.textContent = 'Completed ‚úì';
                }
            });
            updateExerciseNav();
            updateDockUI();
        }
        
        // Session Timer
        function startSessionTimer() {
            if (AppState.session.timer) clearInterval(AppState.session.timer);
            
            AppState.session.timer = setInterval(() => {
                if (!AppState.session.paused) {
                    AppState.session.duration++;
                    updateTimerDisplay();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(AppState.session.duration / 60);
            const seconds = AppState.session.duration % 60;
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('sessionTimer').textContent = timeStr;
            document.getElementById('sessionDuration').textContent = timeStr;
            const dockTimer = document.getElementById('dockTimer');
            if (dockTimer) dockTimer.textContent = timeStr;
        }
        
        // Adjust Reps
        function adjustReps(exerciseNum, change) {
            const exercise = AppState.exercises[exerciseNum];
            const newReps = exercise.reps + change;
            
            if (newReps >= 0 && newReps <= exercise.goal + 5) {
                exercise.reps = newReps;
                document.getElementById('reps' + exerciseNum).textContent = newReps;
                
                const wasCompleted = exercise.completed;
                exercise.completed = newReps >= exercise.goal;
                
                const card = document.querySelector(`[data-exercise="${exerciseNum}"]`);
                
                if (exercise.completed && !wasCompleted) {
                    card.classList.add('completed');
                    card.querySelector('.exercise-status').textContent = 'Completed ‚úì';
                    
                    setTimeout(() => advanceToNextExercise(exerciseNum), 500);
                } else if (!exercise.completed && wasCompleted) {
                    card.classList.remove('completed');
                    card.querySelector('.exercise-status').textContent = 'Current';
                }
                
                updateTotalReps();
                updateExercisesCompleted();
                updateExerciseNav();
                updateDockUI();
            }
        }
        
        function updateTotalReps() {
            let total = 0;
            for (const key in AppState.exercises) {
                total += AppState.exercises[key].reps;
            }
            AppState.results.totalReps = total;
            document.getElementById('totalReps').textContent = total;
        }
        
        function updateExercisesCompleted() {
            let completed = 0;
            for (const key in AppState.exercises) {
                if (AppState.exercises[key].completed) completed++;
            }
            AppState.results.exercisesCompleted = completed;
            document.getElementById('exercisesDone').textContent = `${completed}/${Object.keys(AppState.exercises).length}`;
        }
        
        function advanceToNextExercise(currentExercise) {
            const nextExercise = currentExercise + 1;
            if (AppState.exercises[nextExercise]) {
                setActiveExercise(nextExercise, { scroll: true });
                showNotification(`Great job! Moving to ${AppState.exercises[nextExercise].name}`, 'success');
            } else {
                showNotification('All exercises completed! Ready to finish.', 'success');
            }
        }

        function completeCurrentExercise() {
            const num = getActiveExerciseNumber();
            const exercise = AppState.exercises[num];
            if (!exercise) return;
            exercise.reps = Math.max(exercise.reps, exercise.goal);
            exercise.completed = true;
            const card = document.querySelector(`[data-exercise="${num}"]`);
            if (card) {
                card.classList.add('completed');
                const status = card.querySelector('.exercise-status');
                if (status) status.textContent = 'Completed ‚úì';
                const repEl = card.querySelector('.rep-count');
                if (repEl) repEl.textContent = exercise.reps;
            }
            updateTotalReps();
            updateExercisesCompleted();
            updateExerciseNav();
            updateDockUI();
            advanceToNextExercise(num);
        }

        function updateExerciseNav() {
            const total = Object.keys(AppState.exercises).length;
            const current = getActiveExerciseNumber();
            const navLabel = document.getElementById('navCurrent');
            const navMode = document.getElementById('navMode');
            const dockExercise = document.getElementById('dockExercise');

            if (navLabel) navLabel.textContent = `Exercise ${current} of ${total}`;
            if (dockExercise) {
                const name = AppState.exercises[current]?.name || 'Warmup';
                dockExercise.textContent = `${current}/${total} ¬∑ ${name}`;
            }
            if (navMode) navMode.textContent = `${AppState.preferences.mode} walkthrough`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#10b981' : '#0ea5e9'};
                color: white;
                padding: 1.25rem 2rem;
                border-radius: 16px;
                box-shadow: 0 12px 32px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 1.125rem;
                font-weight: 600;
                max-width: 90%;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function pauseSession() {
            AppState.session.paused = !AppState.session.paused;
            const btn = document.getElementById('pauseBtn');
            
            if (AppState.session.paused) {
                btn.innerHTML = '<span>‚ñ∂Ô∏è Resume Session</span>';
                showNotification('Session paused - take your time', 'info');
            } else {
                btn.innerHTML = '<span>‚è∏Ô∏è Pause Session</span>';
                showNotification('Session resumed', 'success');
            }
            updateDockUI();
        }

        function completeSession() {
            if (AppState.results.totalReps === 0) {
                if (!confirm("You haven't started any exercises. Complete session anyway?")) {
                    return;
                }
            }
            
            AppState.currentStep = 3;
            AppState.session.active = false;
            clearInterval(AppState.session.timer);

            updateStepDisplay();
            showNotification('Session completed! Great work today!', 'success');
            
            document.getElementById('painChange').textContent = AppState.user.painLevel.toFixed(1);
            updateDockUI();
        }
        
        function returnToExercises() {
            AppState.currentStep = 2;
            updateStepDisplay();
        }
        
        function saveAndFinish() {
            const saveBtn = document.querySelector('#step3 .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span>Saving...</span>';
            saveBtn.disabled = true;
            
            setTimeout(() => {
                showNotification('Session saved successfully!', 'success');
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    
                    alert('Great work today! Your progress has been recorded. See you next time!');
                }, 500);
            }, 1500);
        }

        function updateDockUI() {
            const dockStatus = document.getElementById('dockStatus');
            const dockTimer = document.getElementById('dockTimer');
            if (dockStatus) {
                if (AppState.session.active && AppState.session.paused) {
                    dockStatus.textContent = 'Paused';
                } else if (AppState.session.active) {
                    dockStatus.textContent = 'In Session';
                } else {
                    dockStatus.textContent = 'Idle';
                }
            }
            if (dockTimer) {
                const minutes = Math.floor(AppState.session.duration / 60);
                const seconds = AppState.session.duration % 60;
                dockTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function toggleStartOrResume() {
            if (AppState.session.active) {
                AppState.session.paused = false;
                startSessionTimer();
                updateDockUI();
                showNotification('Session resumed.', 'success');
            } else {
                startSession();
            }
        }
    </script>
</body>
</html>
