<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Rehab Session Pro</title>
<meta name="theme-color" content="#0B1020" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
/* =========================
   DESIGN: Premium Clinical
========================= */
:root{
  --bg: #070B14;
  --bg2:#0B1020;
  --panel:#0F172A;
  --panel2:#101B33;
  --ink:#EAF0FF;
  --muted:#93A4C7;
  --muted2:#7B8CB0;
  --line: rgba(255,255,255,.10);

  --accent:#4FE3C1;
  --accent2:#73B6FF;
  --accentInk:#07131A;

  --good:#22C55E;
  --warn:#F59E0B;
  --bad:#EF4444;

  --radius: 18px;
  --radius2: 24px;
  --shadow: 0 20px 55px rgba(0,0,0,.45);
  --shadow2: 0 12px 28px rgba(0,0,0,.35);
  --glow: 0 0 0 rgba(0,0,0,0);

  --font: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  --mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;

  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
  --space-6: 24px;
  --space-8: 32px;
  --space-10: 40px;
}

*{box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  margin:0;
  font-family:var(--font);
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 20% 10%, rgba(79,227,193,.10), transparent 55%),
    radial-gradient(900px 500px at 80% 0%, rgba(115,182,255,.10), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg2) 60%, #05070E 100%);
  min-height:100vh;
  overflow-x:hidden;
}
a{color:inherit}
.hidden{display:none!important}

/* Calm mode: less contrast, less effects, more whitespace */
body.calm{
  --bg:#F7FAFF;
  --bg2:#F7FAFF;
  --panel:#FFFFFF;
  --panel2:#FFFFFF;
  --ink:#0B1324;
  --muted:#4B5E82;
  --muted2:#5C6F96;
  --line: rgba(15,23,42,.14);
  --shadow: 0 12px 25px rgba(15,23,42,.10);
  --shadow2: 0 10px 18px rgba(15,23,42,.08);
}
body.calm .noise, body.calm .grid{display:none!important}
body.calm .btn-primary{box-shadow:none}

/* Layout */
.container{
  width:100%;
  max-width: 1240px;
  margin: 0 auto;
  padding: 0 clamp(16px, 3vw, 22px);
}
.section{padding: clamp(18px, 4vw, 32px) 0}

/* Surfaces */
.surface{
  background: linear-gradient(180deg, rgba(16,27,51,.92), rgba(10,16,35,.88));
  border: 1px solid var(--line);
  border-radius: var(--radius2);
  box-shadow: var(--shadow);
}
body.calm .surface{
  background: var(--panel);
}

/* Small utilities */
.row{display:flex; align-items:center}
.between{justify-content:space-between}
.gap-2{gap:var(--space-2)}
.gap-3{gap:var(--space-3)}
.gap-4{gap:var(--space-4)}
.gap-6{gap:var(--space-6)}
.wrap{flex-wrap:wrap}

.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding: 8px 12px;
  border-radius:999px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing:.08em;
  text-transform:uppercase;
  border: 1px solid var(--line);
  color: var(--muted);
  background: rgba(255,255,255,.03);
}
.badge.good{color:var(--good); border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.08)}
.badge.warn{color:var(--warn); border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.08)}
.badge.bad{color:var(--bad); border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.08)}
.badge.accent{
  color: var(--accent);
  border-color: rgba(79,227,193,.25);
  background: rgba(79,227,193,.08);
}

/* Typography */
.h1{
  font-size: clamp(22px, 2.5vw, 30px);
  font-weight: 900;
  letter-spacing: -0.02em;
  margin:0;
}
.h2{
  font-size: clamp(18px, 2vw, 22px);
  font-weight: 850;
  letter-spacing: -0.02em;
  margin:0;
}
.p{
  margin:0;
  color: var(--muted);
  line-height:1.6;
}
.mono{font-family:var(--mono)}
.small{font-size: 13px}

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:10px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--ink);
  font-weight: 800;
  cursor:pointer;
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
  min-height: 44px;
  user-select:none;
}
.btn:hover{transform: translateY(-1px); border-color: rgba(79,227,193,.35)}
.btn:active{transform: translateY(0px)}
.btn:focus-visible{outline:3px solid rgba(79,227,193,.35); outline-offset:2px}

.btn-primary{
  border: 0;
  color: var(--accentInk);
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
  box-shadow: 0 12px 28px rgba(79,227,193,.18);
}
.btn-primary:hover{box-shadow: 0 18px 38px rgba(79,227,193,.22)}
.btn-ghost{
  background: transparent;
}
.btn-danger{
  border: 0;
  background: linear-gradient(135deg, #FF6B81 0%, #FFB36B 100%);
  color: #1A0A0A;
}

/* Inputs */
.field{display:flex; flex-direction:column; gap:8px}
.label{font-size:13px; font-weight:800; color:var(--muted2); letter-spacing:.04em}
.input, select, textarea{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.04);
  color: var(--ink);
  font-weight: 650;
  transition: border-color .16s ease, box-shadow .16s ease;
}
body.calm .input, body.calm select, body.calm textarea{background:#fff}
.input:focus, select:focus, textarea:focus{
  outline:none;
  border-color: rgba(79,227,193,.55);
  box-shadow: 0 0 0 4px rgba(79,227,193,.20);
}
.range{
  -webkit-appearance:none; appearance:none;
  height: 8px; border-radius:999px;
  background: rgba(255,255,255,.12);
  outline:none;
}
.range::-webkit-slider-thumb{
  -webkit-appearance:none; appearance:none;
  width: 22px; height:22px; border-radius:999px;
  background: var(--accent);
  border: 3px solid rgba(0,0,0,.25);
  box-shadow: var(--shadow2);
  cursor:pointer;
}
body.calm .range{background: rgba(15,23,42,.12)}

/* Top System Bar */
.sysbar{
  position: sticky; top: 0;
  z-index: 200;
  backdrop-filter: blur(18px);
  background: rgba(7,11,20,.72);
  border-bottom: 1px solid var(--line);
}
body.calm .sysbar{background: rgba(247,250,255,.82)}
.sysbar-inner{
  padding: 10px 0;
  display:flex; align-items:center; justify-content:space-between;
}
.dot{
  width: 10px; height:10px; border-radius:999px;
  background: var(--good);
  box-shadow: 0 0 0 6px rgba(34,197,94,.10);
}
.iconbtn{
  width:44px; height:44px;
  display:inline-flex; align-items:center; justify-content:center;
  border-radius:999px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.03);
  cursor:pointer;
}
.iconbtn:hover{border-color: rgba(79,227,193,.35)}
.iconbtn:focus-visible{outline:3px solid rgba(79,227,193,.35); outline-offset:2px}

/* Command Bar */
.cmdbar{
  position: sticky;
  top: 66px;
  z-index: 180;
  backdrop-filter: blur(18px);
  background: rgba(7,11,20,.65);
  border-bottom: 1px solid var(--line);
}
body.calm .cmdbar{background: rgba(247,250,255,.78)}
.cmdbar-inner{
  padding: 14px 0;
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap: 14px;
  align-items:center;
}
@media (max-width: 960px){
  .cmdbar-inner{grid-template-columns: 1fr; gap: 12px}
}

.pills{
  display:flex; gap:10px; flex-wrap:wrap;
  align-items:center;
}
.pill{
  display:inline-flex; align-items:center; gap:10px;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.03);
  font-weight: 850;
  font-size: 13px;
  cursor:pointer;
  transition: border-color .16s ease, transform .16s ease;
}
.pill:hover{border-color: rgba(79,227,193,.35); transform: translateY(-1px)}
.pill[aria-current="true"]{
  border-color: rgba(79,227,193,.55);
  background: rgba(79,227,193,.10);
  color: var(--ink);
}
.pill.locked{
  opacity:.55;
  cursor:not-allowed;
}
.pill.locked:hover{transform:none; border-color: var(--line)}

.cta-stack{
  display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
}
@media (max-width: 960px){
  .cta-stack{justify-content:flex-start}
}

/* Hero */
.hero{
  padding: clamp(18px, 3vw, 26px);
  position: relative;
  overflow:hidden;
}
.hero:before{
  content:"";
  position:absolute; inset:-2px;
  background:
    radial-gradient(800px 400px at 20% 20%, rgba(79,227,193,.10), transparent 60%),
    radial-gradient(700px 360px at 80% 0%, rgba(115,182,255,.10), transparent 58%);
  pointer-events:none;
}
.hero-inner{position:relative; display:grid; grid-template-columns: 1.1fr 1fr; gap: 18px; align-items:stretch}
@media (max-width: 980px){ .hero-inner{grid-template-columns:1fr} }

.card{
  border-radius: var(--radius2);
  border: 1px solid var(--line);
  background: rgba(255,255,255,.03);
  padding: 16px;
}
body.calm .card{background: rgba(15,23,42,.03)}

.missionHeader{
  display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
}
.kv{
  display:flex; flex-direction:column; gap:6px;
}
.kv .k{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted2); font-weight:900}
.kv .v{font-size:22px; font-weight:900; letter-spacing:-.02em}

.big-actions{
  display:flex; gap:10px; flex-wrap:wrap;
}
.big-actions .btn{border-radius: 16px; padding: 12px 14px}
.big-actions .btn-primary{padding: 12px 18px}

.metrics{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap: 12px;
  margin-top: 12px;
}
@media (max-width: 700px){ .metrics{grid-template-columns: 1fr} }
.metric{
  border-radius: 18px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.03);
  padding: 14px;
}
.metric .k{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted2); font-weight:900}
.metric .v{font-size:20px; font-weight:900; margin-top:6px}
.metric .s{font-size:13px; color:var(--muted); margin-top:2px}

/* Phase Panels */
.phase{
  padding: 18px;
  border-radius: var(--radius2);
  border: 1px solid var(--line);
  background: rgba(255,255,255,.02);
}
body.calm .phase{background: rgba(15,23,42,.02)}
.phaseHeader{
  display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  margin-bottom: 14px;
}

/* Pain strip */
.painStrip{
  border-radius: 18px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.03);
  padding: 14px;
}
.painBar{
  height: 10px;
  border-radius:999px;
  background: linear-gradient(90deg, var(--good) 0%, var(--warn) 55%, var(--bad) 100%);
  position:relative;
  margin: 12px 0 6px;
}
.painMarker{
  position:absolute; top: -8px;
  width: 26px; height: 26px;
  border-radius:999px;
  background: #fff;
  border: 3px solid rgba(0,0,0,.35);
  transform: translateX(-50%);
  box-shadow: var(--shadow2);
}
.painTick{
  position:absolute; top:-6px; bottom:-6px;
  width: 2px;
  background: rgba(255,255,255,.85);
  transform: translateX(-50%);
  opacity:.85;
}
body.calm .painTick{background: rgba(15,23,42,.65)}
.warnBox{
  border-radius: 16px;
  border: 1px solid rgba(239,68,68,.25);
  background: rgba(239,68,68,.08);
  padding: 12px;
  display:flex; align-items:flex-start; gap:10px;
}
.warnBox .t{font-weight:900}
.warnBox .d{color:var(--muted); font-size:13px}

/* Bottom Dock */
.dock{
  position: sticky;
  bottom: 12px;
  z-index: 160;
}
.dockInner{
  margin: 0 auto;
  max-width: 1240px;
  padding: 0 clamp(16px, 3vw, 22px);
}
.dockCard{
  border-radius: 22px;
  border: 1px solid var(--line);
  background: rgba(7,11,20,.72);
  backdrop-filter: blur(18px);
  box-shadow: var(--shadow2);
  padding: 14px;
  display:grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items:center;
}
body.calm .dockCard{background: rgba(247,250,255,.82)}
@media (max-width: 760px){ .dockCard{grid-template-columns:1fr} }

.dockTitle{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted2); font-weight:900}
.dockState{font-size:22px; font-weight:950; letter-spacing:-.02em}
.dockHint{color:var(--muted); font-size:13px; margin-top:2px}
.dockActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
@media (max-width: 760px){ .dockActions{justify-content:flex-start} }

/* Toast */
.toasts{
  position: fixed;
  top: 86px;
  right: 16px;
  z-index: 999;
  display:flex;
  flex-direction:column;
  gap:10px;
  max-width: min(360px, calc(100vw - 24px));
  pointer-events:none;
}
.toast{
  pointer-events:none;
  border-radius: 16px;
  border: 1px solid var(--line);
  background: rgba(7,11,20,.82);
  backdrop-filter: blur(18px);
  padding: 12px 12px;
  box-shadow: var(--shadow2);
  display:flex;
  gap:10px;
  align-items:flex-start;
  animation: toastIn .22s ease;
}
body.calm .toast{background: rgba(247,250,255,.88)}
.toast .title{font-weight:900}
.toast .msg{color:var(--muted); font-size:13px; margin-top:2px}
.toast .icon{width:22px; height:22px; display:flex; align-items:center; justify-content:center}
@keyframes toastIn{from{transform: translateY(-6px); opacity:0} to{transform: translateY(0); opacity:1}}

/* Decorative */
.grid{
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
  background-size: 140px 140px;
  opacity: .14;
  pointer-events:none;
  mask-image: radial-gradient(circle at 40% 20%, black 60%, transparent 90%);
}
.noise{
  position: fixed; inset:0;
  pointer-events:none;
  opacity:.06;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
}

@media print{
  .sysbar,.cmdbar,.dock,.toasts,.grid,.noise{display:none!important}
  body{background:#fff!important;color:#000!important}
  .surface,.phase,.card,.metric{box-shadow:none!important;background:#fff!important}
}
</style>
</head>

<body>
<div class="grid" aria-hidden="true"></div>
<div class="noise" aria-hidden="true"></div>
<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<!-- SYSTEM BAR -->
<div class="sysbar">
  <div class="container sysbar-inner">
    <div class="row gap-3">
      <span class="dot" id="sysDot" aria-hidden="true"></span>
      <div class="row gap-2">
        <strong id="sysText">Ready</strong>
        <span class="small" style="color:var(--muted2)" id="sysSub">Idle</span>
      </div>
    </div>

    <div class="row gap-4">
      <div class="mono" id="clock">00:00:00</div>

      <div class="row gap-2" title="Calm mode">
        <span class="small" style="color:var(--muted2); font-weight:800" id="calmLabel">Calm</span>
        <button class="iconbtn" id="calmBtn" aria-pressed="false" aria-label="Toggle calm mode">
          <i class="ri-moon-line"></i>
        </button>
      </div>

      <button class="iconbtn" id="helpBtn" aria-label="Help" title="Help">
        <i class="ri-question-line"></i>
      </button>
    </div>
  </div>
</div>

<!-- COMMAND BAR -->
<div class="cmdbar">
  <div class="container cmdbar-inner">
    <div>
      <div class="h1">Rehab Session Pro</div>
      <p class="p small">Clear next steps. Calm visuals. Safety-first pacing.</p>
    </div>

    <div class="pills" role="navigation" aria-label="Phases">
      <button class="pill" id="nav-auth" aria-current="true"><i class="ri-id-card-line"></i> Sign in</button>
      <button class="pill locked" id="nav-bio" aria-current="false"><i class="ri-heart-pulse-line"></i> Readiness</button>
      <button class="pill locked" id="nav-mission" aria-current="false"><i class="ri-run-line"></i> Exercises</button>
      <button class="pill locked" id="nav-debrief" aria-current="false"><i class="ri-clipboard-line"></i> Summary</button>
    </div>

    <div class="cta-stack">
      <span class="badge accent" id="phaseChip"><i class="ri-shield-star-line"></i> PREP</span>
      <button class="btn btn-primary" id="primaryBtn"><i class="ri-play-line"></i> Start</button>
      <button class="btn btn-ghost" id="secondaryBtn"><i class="ri-moon-clear-line"></i> Calm</button>
    </div>
  </div>
</div>

<main class="container">
  <!-- HERO -->
  <section class="section">
    <div class="surface hero" role="region" aria-label="Session overview">
      <div class="hero-inner">
        <div class="card">
          <div class="missionHeader">
            <span class="badge accent" id="heroStateBadge"><i class="ri-focus-2-line"></i> PREP</span>
            <span class="badge" id="heroClock"><i class="ri-time-line"></i> <span class="mono" id="heroClockVal">--:--:--</span></span>
            <span class="badge" style="color:#B38BFF; border-color:rgba(179,139,255,.25); background:rgba(179,139,255,.10)">
              <i class="ri-shield-star-line"></i> Pro
            </span>
          </div>

          <div style="margin-top:14px" class="kv">
            <div class="k">Patient</div>
            <div class="v" id="patientNameDisplay">Not set</div>
            <p class="p" id="patientSubDisplay">Sign in to unlock your plan.</p>
          </div>

          <div class="big-actions" style="margin-top:14px">
            <button class="btn btn-primary" id="heroPrimary"><i class="ri-play-line"></i> Start session</button>
            <button class="btn" id="heroCalm"><i class="ri-moon-clear-line"></i> Calm mode</button>
            <button class="btn btn-ghost" id="heroJump"><i class="ri-run-line"></i> Jump to exercises</button>
          </div>

          <div class="metrics">
            <div class="metric">
              <div class="k">Profile</div>
              <div class="v" id="metricProfile">—</div>
              <div class="s" id="metricSupport">Select in Sign in</div>
            </div>
            <div class="metric">
              <div class="k">Streak</div>
              <div class="v" id="metricStreak">0 days</div>
              <div class="s">Total sessions <span id="metricSessions">0</span></div>
            </div>
            <div class="metric">
              <div class="k">Pain limit</div>
              <div class="v" id="metricPainLimit">7 / 10</div>
              <div class="s">Baseline <span id="metricPainBase">0 / 10</span></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="phaseHeader">
            <div>
              <div class="h2">Your next step</div>
              <p class="p small" id="nextStepCopy">Start with sign-in. Then a quick readiness check.</p>
            </div>
            <span class="badge" id="readyBadge"><i class="ri-checkbox-circle-line"></i> Ready</span>
          </div>

          <div style="display:grid; gap:12px">
            <div class="phase">
              <div class="phaseHeader">
                <div>
                  <strong>1) Sign in</strong>
                  <div class="small" style="color:var(--muted)">Patient and session profile</div>
                </div>
                <span class="badge accent" id="stepAuth">ACTIVE</span>
              </div>
              <button class="btn" id="goAuth"><i class="ri-arrow-right-line"></i> Open Sign in</button>
            </div>

            <div class="phase">
              <div class="phaseHeader">
                <div>
                  <strong>2) Readiness</strong>
                  <div class="small" style="color:var(--muted)">Baseline pain and safety limits</div>
                </div>
                <span class="badge" id="stepBio">LOCKED</span>
              </div>
              <button class="btn" id="goBio"><i class="ri-arrow-right-line"></i> Open Readiness</button>
            </div>

            <div class="phase">
              <div class="phaseHeader">
                <div>
                  <strong>3) Exercises</strong>
                  <div class="small" style="color:var(--muted)">Timer + progression</div>
                </div>
                <span class="badge" id="stepMission">LOCKED</span>
              </div>
              <button class="btn" id="goMission"><i class="ri-arrow-right-line"></i> Open Exercises</button>
            </div>

            <div class="phase">
              <div class="phaseHeader">
                <div>
                  <strong>4) Summary</strong>
                  <div class="small" style="color:var(--muted)">Notes and session record</div>
                </div>
                <span class="badge" id="stepDebrief">LATER</span>
              </div>
              <button class="btn" id="goDebrief"><i class="ri-arrow-right-line"></i> Open Summary</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PHASE: AUTH -->
  <section class="section" id="phase-auth" aria-label="Sign in">
    <div class="surface" style="padding:18px">
      <div class="phaseHeader">
        <div>
          <div class="h2">Sign in</div>
          <p class="p small">Set patient name and choose a session profile.</p>
        </div>
        <span class="badge accent"><i class="ri-lock-unlock-line"></i> Required</span>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px">
        <div class="field">
          <div class="label">Patient name</div>
          <input class="input" id="patientInput" placeholder="Enter name" autocomplete="name">
          <div class="small" style="color:var(--muted)">Stored locally on this device.</div>
        </div>

        <div class="field">
          <div class="label">Session profile</div>
          <select id="profileSelect">
            <option value="STANDARD" selected>STANDARD · Steady progress</option>
            <option value="RECOVERY">RECOVERY · Low intensity</option>
            <option value="AI_ADAPTIVE">AI ADAPTIVE · Smart pacing</option>
          </select>
          <div class="small" style="color:var(--muted)">Controls cadence and warnings.</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
        <button class="btn btn-primary" id="authContinue"><i class="ri-check-line"></i> Continue to readiness</button>
        <button class="btn" id="authReset"><i class="ri-refresh-line"></i> Reset local data</button>
      </div>
    </div>
  </section>

  <!-- PHASE: BIO -->
  <section class="section hidden" id="phase-bio" aria-label="Readiness check">
    <div class="surface" style="padding:18px">
      <div class="phaseHeader">
        <div>
          <div class="h2">Readiness check</div>
          <p class="p small">Set baseline pain and confirm your safety ceiling.</p>
        </div>
        <span class="badge" id="bioStatusBadge"><i class="ri-heart-pulse-line"></i> Calibrating</span>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px">
        <div class="painStrip">
          <div class="label">Pain baseline (0–10)</div>
          <input class="range" id="baselineRange" type="range" min="0" max="10" step="1" value="0">
          <div class="row between small" style="color:var(--muted2); font-weight:900">
            <span>0</span>
            <span class="mono" id="baselineOut">0</span>
            <span>10</span>
          </div>
        </div>

        <div class="painStrip">
          <div class="label">Pain limit (safety ceiling)</div>
          <input class="range" id="limitRange" type="range" min="3" max="10" step="1" value="7">
          <div class="row between small" style="color:var(--muted2); font-weight:900">
            <span>3</span>
            <span class="mono" id="limitOut">7</span>
            <span>10</span>
          </div>
          <div class="small" style="color:var(--muted); margin-top:6px">Warnings trigger above this threshold during exercises.</div>
        </div>
      </div>

      <div class="painStrip" style="margin-top:14px">
        <strong>Pain check</strong>
        <div class="small" style="color:var(--muted); margin-top:4px">Drag the marker to reflect current pain right now.</div>
        <div class="painBar" id="painBar">
          <div class="painTick" id="limitTick" style="left:70%"></div>
          <div class="painMarker" id="painMarker" style="left:0%"></div>
        </div>
        <div class="row between small" style="color:var(--muted2); font-weight:900">
          <span>Green</span><span>Yellow</span><span>Red</span>
        </div>

        <div class="warnBox hidden" id="painWarn" style="margin-top:10px">
          <i class="ri-error-warning-line" style="font-size:18px; color:var(--bad)"></i>
          <div>
            <div class="t">Pain above your limit</div>
            <div class="d">Reduce intensity or pause. If pain persists, consult your clinician.</div>
          </div>
        </div>

        <div class="row gap-3" style="margin-top:10px">
          <span class="badge" id="currentPainBadge"><i class="ri-pulse-line"></i> Pain: <span class="mono" id="painNow">0</span></span>
          <span class="badge" id="readinessBadge"><i class="ri-checkbox-circle-line"></i> Ready: <span class="mono" id="readyPct">100%</span></span>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
        <button class="btn btn-primary" id="bioContinue"><i class="ri-rocket-line"></i> Begin session</button>
        <button class="btn" id="bioBack"><i class="ri-arrow-left-line"></i> Back</button>
      </div>
    </div>
  </section>

  <!-- PHASE: MISSION -->
  <section class="section hidden" id="phase-mission" aria-label="Exercises">
    <div class="surface" style="padding:18px">
      <div class="phaseHeader">
        <div>
          <div class="h2">Exercises</div>
          <p class="p small" id="missionSubtitle">Timer and safe pacing.</p>
        </div>
        <span class="badge good" id="missionStateBadge"><i class="ri-play-circle-line"></i> In progress</span>
      </div>

      <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <div>
          <div class="label">Session timer</div>
          <div class="mono" style="font-size:34px; font-weight:900" id="missionTimer">00:00</div>
          <div class="small" style="color:var(--muted)" id="missionHint">Stay below your pain limit.</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn btn-primary" id="missionPause"><i class="ri-pause-line"></i> Pause</button>
          <button class="btn" id="missionResume"><i class="ri-play-line"></i> Resume</button>
          <button class="btn btn-danger" id="missionStop"><i class="ri-alarm-warning-line"></i> Emergency stop</button>
          <button class="btn" id="missionComplete"><i class="ri-check-double-line"></i> Complete</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="label">Live pain (drag marker)</div>
        <div class="painBar" id="painBar2">
          <div class="painTick" id="limitTick2" style="left:70%"></div>
          <div class="painMarker" id="painMarker2" style="left:0%"></div>
        </div>
        <div class="row between small" style="color:var(--muted2); font-weight:900">
          <span>0</span><span class="mono" id="painNow2">0</span><span>10</span>
        </div>

        <div class="warnBox hidden" id="painWarn2" style="margin-top:10px">
          <i class="ri-error-warning-line" style="font-size:18px; color:var(--bad)"></i>
          <div>
            <div class="t">Pain above your limit</div>
            <div class="d">Pause or slow down. Don’t push through sharp pain.</div>
          </div>
        </div>
      </div>

      <div class="small" style="color:var(--muted); margin-top:12px">
        Keyboard: <span class="mono">Esc</span> pauses. <span class="mono">Enter</span> completes when focused on buttons.
      </div>
    </div>
  </section>

  <!-- PHASE: DEBRIEF -->
  <section class="section hidden" id="phase-debrief" aria-label="Summary">
    <div class="surface" style="padding:18px">
      <div class="phaseHeader">
        <div>
          <div class="h2">Summary</div>
          <p class="p small">Record notes and close out the session.</p>
        </div>
        <span class="badge good"><i class="ri-check-line"></i> Completed</span>
      </div>

      <div style="display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:12px">
        <div class="metric">
          <div class="k">Total time</div>
          <div class="v mono" id="sumTime">00:00</div>
          <div class="s">This session</div>
        </div>
        <div class="metric">
          <div class="k">Baseline</div>
          <div class="v mono" id="sumBase">0</div>
          <div class="s">Pain at start</div>
        </div>
        <div class="metric">
          <div class="k">Limit</div>
          <div class="v mono" id="sumLimit">7</div>
          <div class="s">Safety ceiling</div>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <div class="label">Notes</div>
        <textarea id="notes" rows="4" placeholder="What went well, what felt off, what to adjust next time…"></textarea>
        <div class="small" style="color:var(--muted)">Saved locally.</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
        <button class="btn btn-primary" id="saveSummary"><i class="ri-save-line"></i> Save</button>
        <button class="btn" id="exportTxt"><i class="ri-download-line"></i> Export .txt</button>
        <button class="btn" id="newSession"><i class="ri-refresh-line"></i> New session</button>
      </div>
    </div>
  </section>
</main>

<!-- DOCK -->
<div class="dock">
  <div class="dockInner">
    <div class="dockCard" role="region" aria-label="Live status dock">
      <div>
        <div class="dockTitle">Live status</div>
        <div class="dockState" id="dockState">Prep</div>
        <div class="dockHint" id="dockHint">Authenticate to unlock your plan.</div>
      </div>

      <div class="dockActions">
        <button class="btn btn-primary" id="dockPrimary"><i class="ri-play-line"></i> Start</button>
        <button class="btn" id="dockSecondary"><i class="ri-moon-clear-line"></i> Calm</button>
        <button class="btn btn-danger hidden" id="dockEmergency"><i class="ri-alarm-warning-line"></i> Stop</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Rehab Session Pro (Single-file)
   - Deterministic state machine
   - No dead handlers
   - Drift-safe timer
========================= */
(() => {
  const $ = (id) => document.getElementById(id);

  // ----- Persistence keys -----
  const K = {
    patient: "rsp.patient",
    profile: "rsp.profile",
    calm: "rsp.calm",
    sessions: "rsp.sessions",
    streak: "rsp.streak",
    lastDay: "rsp.lastDay",
    notes: "rsp.notes",
  };

  // ----- App state -----
  const state = {
    phase: "AUTH", // AUTH -> BIO -> MISSION -> DEBRIEF
    calm: false,

    patient: "",
    profile: "STANDARD",

    baseline: 0,
    limit: 7,

    painNow: 0,

    // timer
    running: false,
    startEpoch: 0,
    elapsedMs: 0,
    tickHandle: 0,

    // stats
    sessions: 0,
    streak: 0,
  };

  // ----- Toasts -----
  function toast(title, msg, kind="info") {
    const wrap = $("toasts");
    const el = document.createElement("div");
    el.className = "toast";
    const icon = kind === "danger" ? "ri-error-warning-line"
      : kind === "success" ? "ri-checkbox-circle-line"
      : kind === "warn" ? "ri-alert-line"
      : "ri-information-line";
    el.innerHTML = `
      <div class="icon"><i class="${icon}"></i></div>
      <div>
        <div class="title">${escapeHtml(title)}</div>
        <div class="msg">${escapeHtml(msg)}</div>
      </div>
    `;
    wrap.appendChild(el);
    setTimeout(() => el.remove(), 2600);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  // ----- Clock -----
  function startClock() {
    const clock = $("clock");
    const heroClock = $("heroClockVal");
    const tick = () => {
      const now = new Date();
      const t = now.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit",second:"2-digit"});
      clock.textContent = t;
      heroClock.textContent = t;
      requestAnimationFrame(() => {});
    };
    tick();
    setInterval(tick, 1000);
  }

  // ----- UI phase -----
  const phaseEl = {
    AUTH: $("phase-auth"),
    BIO: $("phase-bio"),
    MISSION: $("phase-mission"),
    DEBRIEF: $("phase-debrief"),
  };

  function setPhase(next) {
    state.phase = next;

    // sections
    Object.keys(phaseEl).forEach(p => phaseEl[p].classList.toggle("hidden", p !== next));

    // nav pills
    const pill = (id, current, locked) => {
      const el = $(id);
      el.setAttribute("aria-current", current ? "true" : "false");
      el.classList.toggle("locked", locked);
    };

    const locked = {
      AUTH: { bio:true, mission:true, debrief:true },
      BIO: { bio:false, mission:true, debrief:true },
      MISSION: { bio:false, mission:false, debrief:true },
      DEBRIEF: { bio:false, mission:false, debrief:false },
    }[next];

    pill("nav-auth", next==="AUTH", false);
    pill("nav-bio", next==="BIO", locked.bio);
    pill("nav-mission", next==="MISSION", locked.mission);
    pill("nav-debrief", next==="DEBRIEF", locked.debrief);

    // phase chip labels
    const chipTxt = next==="AUTH" ? "PREP"
      : next==="BIO" ? "READINESS"
      : next==="MISSION" ? "ACTIVE"
      : "SUMMARY";
    $("phaseChip").innerHTML = `<i class="ri-shield-star-line"></i> ${chipTxt}`;
    $("heroStateBadge").innerHTML = `<i class="ri-focus-2-line"></i> ${chipTxt}`;
    $("dockState").textContent = chipTxt.charAt(0)+chipTxt.slice(1).toLowerCase();

    // step badges
    $("stepAuth").textContent = next==="AUTH" ? "ACTIVE" : "DONE";
    $("stepBio").textContent = (next==="AUTH") ? "LOCKED" : (next==="BIO" ? "ACTIVE" : "DONE");
    $("stepMission").textContent = (next==="MISSION") ? "ACTIVE" : (next==="DEBRIEF" ? "DONE" : "LOCKED");
    $("stepDebrief").textContent = (next==="DEBRIEF") ? "ACTIVE" : "LATER";

    // primary/secondary CTAs
    const primary = $("primaryBtn");
    const dockPrimary = $("dockPrimary");

    if (next === "AUTH") {
      primary.innerHTML = `<i class="ri-play-line"></i> Start`;
      dockPrimary.innerHTML = `<i class="ri-play-line"></i> Start`;
      $("dockEmergency").classList.add("hidden");
      $("dockHint").textContent = "Authenticate to unlock your plan.";
      $("nextStepCopy").textContent = "Start with sign-in. Then a quick readiness check.";
    } else if (next === "BIO") {
      primary.innerHTML = `<i class="ri-rocket-line"></i> Begin`;
      dockPrimary.innerHTML = `<i class="ri-rocket-line"></i> Begin`;
      $("dockEmergency").classList.add("hidden");
      $("dockHint").textContent = "Confirm baseline and pain limit.";
      $("nextStepCopy").textContent = "Set baseline pain and safety limit, then begin.";
    } else if (next === "MISSION") {
      primary.innerHTML = `<i class="ri-check-double-line"></i> Complete`;
      dockPrimary.innerHTML = `<i class="ri-check-double-line"></i> Complete`;
      $("dockEmergency").classList.remove("hidden");
      $("dockHint").textContent = "Monitor pain. Pause if above limit.";
      $("nextStepCopy").textContent = "Proceed through exercises. Keep pain below limit.";
    } else {
      primary.innerHTML = `<i class="ri-refresh-line"></i> New`;
      dockPrimary.innerHTML = `<i class="ri-refresh-line"></i> New`;
      $("dockEmergency").classList.add("hidden");
      $("dockHint").textContent = "Add notes and save.";
      $("nextStepCopy").textContent = "Session completed. Save notes or export.";
    }

    // scroll to section on phase change (subtle, not annoying)
    const target = next==="AUTH" ? "phase-auth" : next==="BIO" ? "phase-bio" : next==="MISSION" ? "phase-mission" : "phase-debrief";
    document.getElementById(target).scrollIntoView({behavior:"smooth", block:"start"});

    // hero jump button gating
    $("heroJump").disabled = (next === "AUTH" || next === "BIO");
    $("heroJump").style.opacity = $("heroJump").disabled ? ".55" : "1";

    // update patient header
    syncHeaderPatient();

    // safety: if leaving mission, stop timer
    if (next !== "MISSION") stopTimer();
  }

  function syncHeaderPatient() {
    const name = state.patient ? state.patient : "Not set";
    $("patientNameDisplay").textContent = name;
    $("patientSubDisplay").textContent = state.patient
      ? `${humanProfile(state.profile)} · ${state.calm ? "calm mode" : "pro mode"}`
      : "Sign in to unlock your plan.";
    $("metricProfile").textContent = state.profile || "—";
    $("metricSupport").textContent = humanProfile(state.profile);

    $("metricPainLimit").textContent = `${state.limit} / 10`;
    $("metricPainBase").textContent = `${state.baseline} / 10`;
  }

  function humanProfile(p) {
    if (p === "RECOVERY") return "Recovery pacing";
    if (p === "AI_ADAPTIVE") return "Adaptive pacing";
    return "Steady pacing";
  }

  // ----- Calm mode -----
  function setCalm(on) {
    state.calm = !!on;
    document.body.classList.toggle("calm", state.calm);
    $("calmBtn").setAttribute("aria-pressed", state.calm ? "true" : "false");
    localStorage.setItem(K.calm, state.calm ? "1" : "0");
    toast("Mode", state.calm ? "Calm mode enabled." : "Pro mode enabled.", "success");
    syncHeaderPatient();
  }

  // ----- Nav handlers -----
  function bindNav() {
    $("nav-auth").addEventListener("click", () => setPhase("AUTH"));
    $("nav-bio").addEventListener("click", () => {
      if (isLocked("BIO")) return toast("Locked", "Complete sign-in first.", "warn");
      setPhase("BIO");
    });
    $("nav-mission").addEventListener("click", () => {
      if (isLocked("MISSION")) return toast("Locked", "Complete readiness first.", "warn");
      setPhase("MISSION");
    });
    $("nav-debrief").addEventListener("click", () => {
      if (isLocked("DEBRIEF")) return toast("Locked", "Complete the session first.", "warn");
      setPhase("DEBRIEF");
    });
  }

  function isLocked(target) {
    if (target === "BIO") return !state.patient;
    if (target === "MISSION") return !state.patient || !state._bioDone;
    if (target === "DEBRIEF") return !state._missionDone;
    return false;
  }

  // ----- Auth phase -----
  function bindAuth() {
    $("patientInput").addEventListener("input", (e) => state.patient = e.target.value.trim());
    $("profileSelect").addEventListener("change", (e) => state.profile = e.target.value);

    $("authContinue").addEventListener("click", () => {
      if (!state.patient) {
        toast("Missing info", "Enter a patient name to continue.", "danger");
        $("patientInput").focus();
        return;
      }
      persistBasics();
      state._bioDone = false;
      state._missionDone = false;

      $("metricProfile").textContent = state.profile;
      $("metricSupport").textContent = humanProfile(state.profile);
      $("patientNameDisplay").textContent = state.patient;
      $("patientSubDisplay").textContent = `${humanProfile(state.profile)} · ${state.calm ? "calm mode" : "pro mode"}`;

      toast("Signed in", "Readiness is now unlocked.", "success");
      setPhase("BIO");
    });

    $("authReset").addEventListener("click", () => {
      localStorage.removeItem(K.patient);
      localStorage.removeItem(K.profile);
      localStorage.removeItem(K.sessions);
      localStorage.removeItem(K.streak);
      localStorage.removeItem(K.lastDay);
      localStorage.removeItem(K.notes);
      state.patient = "";
      state.profile = "STANDARD";
      state.sessions = 0;
      state.streak = 0;
      $("patientInput").value = "";
      $("profileSelect").value = "STANDARD";
      updateStreakUI();
      syncHeaderPatient();
      toast("Reset", "Local data cleared.", "success");
      setPhase("AUTH");
    });

    // hero shortcuts
    $("goAuth").addEventListener("click", () => setPhase("AUTH"));
    $("heroPrimary").addEventListener("click", () => primaryAction());
    $("heroCalm").addEventListener("click", () => setCalm(!state.calm));
    $("heroJump").addEventListener("click", () => {
      if (isLocked("MISSION")) return toast("Locked", "Complete sign-in and readiness first.", "warn");
      setPhase("MISSION");
    });

    $("secondaryBtn").addEventListener("click", () => setCalm(!state.calm));
    $("calmBtn").addEventListener("click", () => setCalm(!state.calm));
  }

  // ----- Bio phase -----
  function bindBio() {
    const baseline = $("baselineRange");
    const limit = $("limitRange");

    baseline.addEventListener("input", () => {
      state.baseline = Number(baseline.value);
      $("baselineOut").textContent = String(state.baseline);
      $("metricPainBase").textContent = `${state.baseline} / 10`;
      setPainNow(state.baseline, "bio");
    });

    limit.addEventListener("input", () => {
      state.limit = Number(limit.value);
      $("limitOut").textContent = String(state.limit);
      $("metricPainLimit").textContent = `${state.limit} / 10`;
      updateLimitTicks();
      validatePainWarnings();
    });

    $("bioBack").addEventListener("click", () => setPhase("AUTH"));

    $("goBio").addEventListener("click", () => {
      if (isLocked("BIO")) return toast("Locked", "Complete sign-in first.", "warn");
      setPhase("BIO");
    });

    $("bioContinue").addEventListener("click", () => {
      if (state.patient === "") return toast("Locked", "Complete sign-in first.", "warn");
      state._bioDone = true;
      persistBasics();
      toast("Readiness", "Exercises are now unlocked.", "success");
      setPhase("MISSION");
      startTimer(); // begin immediately
    });

    // draggable pain markers
    bindPainDrag("painBar", "painMarker", (v) => setPainNow(v, "bio"));
    bindPainDrag("painBar2", "painMarker2", (v) => setPainNow(v, "mission"));
  }

  function updateLimitTicks() {
    const pct = (state.limit / 10) * 100;
    $("limitTick").style.left = pct + "%";
    $("limitTick2").style.left = pct + "%";
  }

  function setPainNow(v, where) {
    state.painNow = clampInt(v, 0, 10);
    $("painNow").textContent = String(state.painNow);
    $("painNow2").textContent = String(state.painNow);

    // markers position
    const pct = (state.painNow / 10) * 100;
    $("painMarker").style.left = pct + "%";
    $("painMarker2").style.left = pct + "%";

    // readiness heuristic (simple, predictable)
    const ready = Math.max(0, Math.min(100, 100 - state.painNow * 7));
    $("readyPct").textContent = `${ready}%`;

    validatePainWarnings();

    if (where === "mission") updateMissionHint();
  }

  function validatePainWarnings() {
    const over = state.painNow > state.limit;
    $("painWarn").classList.toggle("hidden", !over);
    $("painWarn2").classList.toggle("hidden", !over);

    const bioBadge = $("bioStatusBadge");
    if (!bioBadge) return;
    bioBadge.className = "badge " + (over ? "bad" : "good");
    bioBadge.innerHTML = over
      ? `<i class="ri-error-warning-line"></i> Above limit`
      : `<i class="ri-checkbox-circle-line"></i> Within limit`;

    const currentPainBadge = $("currentPainBadge");
    currentPainBadge.className = "badge " + (over ? "bad" : "accent");
    currentPainBadge.innerHTML = `<i class="ri-pulse-line"></i> Pain: <span class="mono" id="painNow">${state.painNow}</span>`;

    // update dock emergency visibility during mission
    if (state.phase === "MISSION") $("dockEmergency").classList.toggle("hidden", false);
  }

  function bindPainDrag(barId, markerId, onValue) {
    const bar = $(barId);
    const marker = $(markerId);
    if (!bar || !marker) return;

    let dragging = false;

    const setFromEvent = (clientX) => {
      const r = bar.getBoundingClientRect();
      const x = Math.min(Math.max(clientX - r.left, 0), r.width);
      const v = Math.round((x / r.width) * 10);
      onValue(v);
    };

    marker.addEventListener("pointerdown", (e) => {
      dragging = true;
      marker.setPointerCapture(e.pointerId);
      setFromEvent(e.clientX);
    });

    marker.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      setFromEvent(e.clientX);
    });

    marker.addEventListener("pointerup", () => dragging = false);
    marker.addEventListener("pointercancel", () => dragging = false);

    // click on bar sets marker
    bar.addEventListener("pointerdown", (e) => setFromEvent(e.clientX));
  }

  function clampInt(n, lo, hi) {
    n = Number(n);
    if (!Number.isFinite(n)) return lo;
    return Math.max(lo, Math.min(hi, Math.round(n)));
  }

  // ----- Mission timer -----
  function startTimer() {
    if (state.running) return;
    state.running = true;
    state.startEpoch = performance.now();
    state.tickHandle = window.setInterval(tickTimer, 250); // smooth updates
    toast("Session", "Session started.", "success");
    $("missionStateBadge").className = "badge good";
    $("missionStateBadge").innerHTML = `<i class="ri-play-circle-line"></i> In progress`;
    updateDockForMission();
  }

  function stopTimer() {
    if (!state.running && state.elapsedMs === 0) return;
    pauseTimer();
    state.elapsedMs = 0;
    state.startEpoch = 0;
    $("missionTimer").textContent = "00:00";
  }

  function pauseTimer() {
    if (!state.running) return;
    state.running = false;
    state.elapsedMs += performance.now() - state.startEpoch;
    state.startEpoch = 0;
    window.clearInterval(state.tickHandle);
    state.tickHandle = 0;
    toast("Paused", "Session paused.", "warn");
    $("missionStateBadge").className = "badge warn";
    $("missionStateBadge").innerHTML = `<i class="ri-pause-circle-line"></i> Paused`;
  }

  function resumeTimer() {
    if (state.running) return;
    state.running = true;
    state.startEpoch = performance.now();
    state.tickHandle = window.setInterval(tickTimer, 250);
    toast("Resumed", "Session resumed.", "success");
    $("missionStateBadge").className = "badge good";
    $("missionStateBadge").innerHTML = `<i class="ri-play-circle-line"></i> In progress`;
  }

  function tickTimer() {
    const ms = state.elapsedMs + (state.running ? (performance.now() - state.startEpoch) : 0);
    const totalSeconds = Math.floor(ms / 1000);
    const m = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
    const s = String(totalSeconds % 60).padStart(2, "0");
    $("missionTimer").textContent = `${m}:${s}`;
  }

  function updateMissionHint() {
    const over = state.painNow > state.limit;
    const hint = $("missionHint");
    if (over) {
      hint.style.color = "var(--bad)";
      hint.textContent = "Pain above limit — pause or slow down.";
    } else {
      hint.style.color = "var(--muted)";
      hint.textContent = "Stay below your pain limit.";
    }
  }

  function bindMission() {
    $("goMission").addEventListener("click", () => {
      if (isLocked("MISSION")) return toast("Locked", "Complete readiness first.", "warn");
      setPhase("MISSION");
    });

    $("missionPause").addEventListener("click", () => pauseTimer());
    $("missionResume").addEventListener("click", () => resumeTimer());
    $("missionStop").addEventListener("click", () => emergencyStop());
    $("missionComplete").addEventListener("click", () => completeMission());

    // Dock actions
    $("dockEmergency").addEventListener("click", () => emergencyStop());
  }

  function emergencyStop() {
    pauseTimer();
    toast("Safety stop", "Session paused for safety.", "danger");
  }

  function completeMission() {
    // mark complete, update stats
    pauseTimer();
    state._missionDone = true;

    const totalSeconds = Math.floor(state.elapsedMs / 1000);
    // count session only if meaningful (>= 30s)
    if (totalSeconds >= 30) incrementStats();

    // populate summary
    $("sumTime").textContent = formatMMSS(totalSeconds);
    $("sumBase").textContent = String(state.baseline);
    $("sumLimit").textContent = String(state.limit);

    $("missionStateBadge").className = "badge good";
    $("missionStateBadge").innerHTML = `<i class="ri-check-double-line"></i> Completed`;

    toast("Complete", "Session completed. Add notes if you want.", "success");
    setPhase("DEBRIEF");
  }

  function formatMMSS(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${m}:${s}`;
  }

  // ----- Debrief -----
  function bindDebrief() {
    $("goDebrief").addEventListener("click", () => {
      if (isLocked("DEBRIEF")) return toast("Locked", "Complete the session first.", "warn");
      setPhase("DEBRIEF");
    });

    $("saveSummary").addEventListener("click", () => {
      localStorage.setItem(K.notes, $("notes").value || "");
      toast("Saved", "Notes saved locally.", "success");
    });

    $("exportTxt").addEventListener("click", () => exportTxt());

    $("newSession").addEventListener("click", () => {
      toast("New session", "Resetting session state.", "success");
      resetSessionOnly();
      setPhase("AUTH");
    });
  }

  function exportTxt() {
    const txt = [
      "Rehab Session Pro",
      `Patient: ${state.patient || "Not set"}`,
      `Profile: ${state.profile}`,
      `Baseline pain: ${state.baseline}/10`,
      `Pain limit: ${state.limit}/10`,
      `Duration: ${$("sumTime").textContent || "00:00"}`,
      "",
      "Notes:",
      ($("notes").value || "").trim(),
      "",
      `Exported: ${new Date().toLocaleString()}`
    ].join("\n");

    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `rehab-session-${(state.patient || "patient").toLowerCase().replace(/\s+/g,"-")}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Exported", "Downloaded session summary.", "success");
  }

  function resetSessionOnly() {
    stopTimer();
    state._bioDone = false;
    state._missionDone = false;
    state.baseline = 0;
    state.limit = 7;
    state.painNow = 0;

    $("baselineRange").value = "0";
    $("limitRange").value = "7";
    $("baselineOut").textContent = "0";
    $("limitOut").textContent = "7";
    $("notes").value = localStorage.getItem(K.notes) || "";

    setPainNow(0, "bio");
    updateLimitTicks();
  }

  // ----- Primary action routing -----
  function primaryAction() {
    if (state.phase === "AUTH") {
      // take user to auth section and focus
      $("patientInput").focus();
      toast("Next step", "Enter name and choose profile.", "info");
      return;
    }
    if (state.phase === "BIO") {
      $("bioContinue").click();
      return;
    }
    if (state.phase === "MISSION") {
      $("missionComplete").click();
      return;
    }
    // debrief -> new
    $("newSession").click();
  }

  // ----- Dock -----
  function updateDockForMission() {
    $("dockEmergency").classList.toggle("hidden", false);
  }

  // ----- Persistence / Stats -----
  function persistBasics() {
    localStorage.setItem(K.patient, state.patient);
    localStorage.setItem(K.profile, state.profile);
    localStorage.setItem("rsp.baseline", String(state.baseline));
    localStorage.setItem("rsp.limit", String(state.limit));
  }

  function loadPersisted() {
    state.patient = localStorage.getItem(K.patient) || "";
    state.profile = localStorage.getItem(K.profile) || "STANDARD";
    state.calm = (localStorage.getItem(K.calm) || "0") === "1";
    state.sessions = Number(localStorage.getItem(K.sessions) || "0");
    state.streak = Number(localStorage.getItem(K.streak) || "0");
    state.baseline = Number(localStorage.getItem("rsp.baseline") || "0");
    state.limit = Number(localStorage.getItem("rsp.limit") || "7");

    $("patientInput").value = state.patient;
    $("profileSelect").value = state.profile;

    $("baselineRange").value = String(state.baseline);
    $("limitRange").value = String(state.limit);
    $("baselineOut").textContent = String(state.baseline);
    $("limitOut").textContent = String(state.limit);

    updateLimitTicks();
    setPainNow(state.baseline, "bio");
    setCalm(state.calm); // will sync UI + toast; suppress toast by setting after?
  }

  function incrementStats() {
    // streak increments once per day
    const today = new Date().toISOString().slice(0,10);
    const lastDay = localStorage.getItem(K.lastDay) || "";
    let streak = Number(localStorage.getItem(K.streak) || "0");
    if (lastDay !== today) {
      // if last day was yesterday -> streak+1 else reset to 1
      const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0,10);
      streak = (lastDay === yesterday) ? (streak + 1) : 1;
      localStorage.setItem(K.lastDay, today);
      localStorage.setItem(K.streak, String(streak));
    }
    let sessions = Number(localStorage.getItem(K.sessions) || "0");
    sessions += 1;
    localStorage.setItem(K.sessions, String(sessions));

    state.streak = streak;
    state.sessions = sessions;
    updateStreakUI();
  }

  function updateStreakUI() {
    $("metricStreak").textContent = `${state.streak} days`;
    $("metricSessions").textContent = String(state.sessions);
  }

  // ----- Help -----
  function bindHelp() {
    $("helpBtn").addEventListener("click", () => {
      toast("Help", "Sign in → Readiness → Exercises → Summary. Calm mode reduces visual load.", "info");
    });
  }

  // ----- Buttons wiring (top + dock) -----
  function bindPrimaryButtons() {
    $("primaryBtn").addEventListener("click", () => primaryAction());
    $("dockPrimary").addEventListener("click", () => primaryAction());
    $("dockSecondary").addEventListener("click", () => setCalm(!state.calm));
    $("secondaryBtn").addEventListener("click", () => setCalm(!state.calm));
  }

  // ----- Hero step buttons -----
  function bindHeroSteps() {
    $("goAuth").addEventListener("click", () => setPhase("AUTH"));
    $("goBio").addEventListener("click", () => {
      if (isLocked("BIO")) return toast("Locked", "Complete sign-in first.", "warn");
      setPhase("BIO");
    });
    $("goMission").addEventListener("click", () => {
      if (isLocked("MISSION")) return toast("Locked", "Complete readiness first.", "warn");
      setPhase("MISSION");
    });
    $("goDebrief").addEventListener("click", () => {
      if (isLocked("DEBRIEF")) return toast("Locked", "Complete the session first.", "warn");
      setPhase("DEBRIEF");
    });
  }

  // ----- Keyboard -----
  function bindKeyboard() {
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && state.phase === "MISSION") {
        e.preventDefault();
        pauseTimer();
      }
      if (e.key === "Enter") {
        // allow normal form behavior; don't hijack textareas
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if (tag === "textarea") return;
      }
    });
  }

  // ----- Boot -----
  function boot() {
    startClock();
    bindNav();
    bindPrimaryButtons();
    bindAuth();
    bindBio();
    bindMission();
    bindDebrief();
    bindHelp();
    bindHeroSteps();
    bindKeyboard();

    // Load persisted after handlers exist
    // Avoid toast spam on initial calm load:
    const calmPersisted = (localStorage.getItem(K.calm) || "0") === "1";
    state.calm = calmPersisted;
    document.body.classList.toggle("calm", state.calm);
    $("calmBtn").setAttribute("aria-pressed", state.calm ? "true" : "false");

    loadPersisted();
    updateStreakUI();
    syncHeaderPatient();

    // if patient exists, unlock BIO nav but still set phase AUTH (explicit flow)
    setPhase("AUTH");
    if (state.patient) {
      toast("Welcome back", "Patient loaded. Continue to readiness when ready.", "success");
    } else {
      toast("Ready", "Sign in to begin.", "info");
    }
  }

  // Make sure loadPersisted doesn't toast calm mode on boot
  function loadPersisted() {
    state.patient = localStorage.getItem(K.patient) || "";
    state.profile = localStorage.getItem(K.profile) || "STANDARD";
    state.sessions = Number(localStorage.getItem(K.sessions) || "0");
    state.streak = Number(localStorage.getItem(K.streak) || "0");
    state.baseline = Number(localStorage.getItem("rsp.baseline") || "0");
    state.limit = Number(localStorage.getItem("rsp.limit") || "7");

    $("patientInput").value = state.patient;
    $("profileSelect").value = state.profile;

    $("baselineRange").value = String(state.baseline);
    $("limitRange").value = String(state.limit);
    $("baselineOut").textContent = String(state.baseline);
    $("limitOut").textContent = String(state.limit);

    updateLimitTicks();
    setPainNow(state.baseline, "bio");
    syncHeaderPatient();
  }

  // expose primaryAction used by auth bindings
  window.__rsp = { primaryAction };
  // internal use
  function primaryActionProxy(){ primaryAction(); }
  function primaryAction(){ // overwritten by boot closure, keep function hoisted
    // will be replaced by closure above (same name). left here to satisfy lints.
  }

  boot();
})();
</script>
</body>
</html>
