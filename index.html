<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rehab Session Pro | Advanced Neuro-Muscular Rehabilitation</title>
    <meta name="description" content="Next-generation rehabilitation platform with AI-driven protocols and real-time biofeedback">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* =========================================================
           DESIGN TOKENS
        ========================================================= */
        :root {
            /* Color Palette */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #2dd4bf;
            --primary-600: #22c55e;
            --primary-700: #06b6d4;
            --primary-800: #2563eb;
            --primary-900: #111827;
            --primary-950: #0b1020;

            --accent-teal: #4df3c9;
            --accent-teal-light: #8bfce0;
            --accent-teal-dark: #16a399;
            --accent-blue: #7cb7ff;
            --accent-purple: #b38bff;
            --accent-orange: #ffb36b;
            --accent-green: #8ef4c5;
            --accent-yellow: #ffe082;
            --accent-red: #ff6b81;
            --accent-pink: #ff8ad8;

            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #465672;
            --neutral-700: #2e3a55;
            --neutral-800: #1a2538;
            --neutral-900: #0f172a;
            --neutral-950: #070c16;

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #4df3c9 0%, #6fb8ff 40%, #b38bff 100%);
            --gradient-secondary: linear-gradient(135deg, #8bfce0 0%, #7cb7ff 45%, #ff8ad8 100%);
            --gradient-warning: linear-gradient(135deg, var(--accent-yellow) 0%, var(--accent-orange) 100%);
            --gradient-success: linear-gradient(135deg, #7cf8c4 0%, #4df3c9 100%);
            --gradient-danger: linear-gradient(135deg, #ff6b81 0%, #ff9f66 100%);
            --gradient-dark: linear-gradient(135deg, #0b1224 0%, #0f172a 100%);
            --gradient-glass: linear-gradient(145deg, rgba(255, 255, 255, 0.14) 0%, rgba(255, 255, 255, 0.04) 100%);
            
            /* Status Colors */
            --status-success: var(--accent-green);
            --status-warning: var(--accent-yellow);
            --status-error: var(--accent-red);
            --status-info: var(--accent-blue);
            
            /* Typography */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            
            /* Spacing */
            --space-unit: 0.25rem;
            --space-0: 0;
            --space-1: calc(1 * var(--space-unit));
            --space-2: calc(2 * var(--space-unit));
            --space-3: calc(3 * var(--space-unit));
            --space-4: calc(4 * var(--space-unit));
            --space-6: calc(6 * var(--space-unit));
            --space-8: calc(8 * var(--space-unit));
            --space-12: calc(12 * var(--space-unit));
            --space-16: calc(16 * var(--space-unit));
            --space-20: calc(20 * var(--space-unit));
            --space-24: calc(24 * var(--space-unit));
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-3xl: 2rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 50px rgba(0, 212, 170, 0.3);
            --shadow-glow-blue: 0 0 50px rgba(58, 134, 255, 0.3);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Z-index */
            --z-below: -1;
            --z-base: 1;
            --z-above: 10;
            --z-docked: 100;
            --z-sticky: 200;
            --z-fixed: 300;
            --z-modal: 400;
            --z-popover: 500;
            --z-toast: 600;
            --z-tooltip: 700;

            /* Surfaces & Focus */
            --surface-muted: rgba(255, 255, 255, 0.04);
            --surface-strong: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.14);
            --focus-ring: 0 0 0 3px rgba(77, 243, 201, 0.35);
        }
        
        /* =========================================================
           BASE RESET & TYPOGRAPHY
        ========================================================= */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-sans);
            background: radial-gradient(circle at 20% 20%, rgba(77, 243, 201, 0.08), transparent 30%), 
                        radial-gradient(circle at 80% 10%, rgba(115, 179, 255, 0.08), transparent 30%), 
                        radial-gradient(circle at 50% 80%, rgba(255, 138, 216, 0.08), transparent 28%), 
                        var(--neutral-950);
            color: var(--neutral-50);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                linear-gradient(135deg, rgba(77, 243, 201, 0.08) 0%, rgba(115, 179, 255, 0.08) 35%, rgba(179, 139, 255, 0.08) 70%, rgba(255, 138, 216, 0.08) 100%),
                radial-gradient(circle at 15% 75%, rgba(255, 224, 130, 0.16), transparent 40%),
                radial-gradient(circle at 85% 35%, rgba(115, 179, 255, 0.12), transparent 45%);
            pointer-events: none;
            z-index: var(--z-below);
        }

        .grid-overlay {
            position: fixed;
            inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 120px 120px;
            opacity: 0.2;
            pointer-events: none;
            z-index: var(--z-below);
            mask-image: radial-gradient(circle at 50% 50%, black 60%, transparent 90%);
        }

        body.calm .grid-overlay,
        body.reduced-motion .grid-overlay {
            display: none;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 800;
            line-height: 1.2;
            letter-spacing: -0.025em;
        }

        /* Accessibility & Focus */
        a, button, input, select, textarea {
            color: inherit;
        }

        :focus-visible {
            outline: 2px solid var(--accent-teal);
            outline-offset: 3px;
        }

        .btn:focus-visible,
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            box-shadow: var(--focus-ring);
            border-color: var(--accent-teal);
        }

        ::placeholder {
            color: var(--neutral-400);
            text-transform: none;
            letter-spacing: normal;
        }
        
        .text-gradient {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* =========================================================
           LAYOUT & CONTAINERS
        ========================================================= */
        .container {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 var(--space-6);
        }
        
        .section {
            padding: var(--space-16) 0;
        }

        /* Hero */
        .hero-shell {
            margin-top: var(--space-8);
        }

        .session-banner {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.24), rgba(77, 243, 201, 0.24));
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
            border-radius: var(--radius-3xl);
            padding: var(--space-6);
            display: grid;
            gap: var(--space-4);
            position: relative;
            overflow: hidden;
        }

        .session-banner::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(141, 244, 197, 0.16), transparent 40%),
                        radial-gradient(circle at 80% 0%, rgba(124, 183, 255, 0.14), transparent 45%);
            pointer-events: none;
            z-index: 0;
        }

        .session-banner > * {
            position: relative;
            z-index: 1;
        }

        .session-banner__header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-3);
            justify-content: space-between;
        }

        .session-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--neutral-50);
        }

        .session-chip .status-dot {
            width: 10px;
            height: 10px;
        }

        .session-clock {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--accent-blue);
        }

        .session-plan-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.16);
            border: 1px solid rgba(255, 255, 255, 0.14);
            color: var(--neutral-50);
            font-weight: 700;
        }

        .session-banner__body {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            align-items: center;
            gap: var(--space-6);
        }

        .session-persona h3 {
            font-size: clamp(1.6rem, 3vw, 2rem);
            font-weight: 900;
            margin-bottom: var(--space-2);
        }

        .eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.8rem;
            color: var(--neutral-300);
        }

        .session-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-3);
        }

        .session-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-3);
        }

        .step-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }

        .step-card:hover {
            border-color: var(--accent-teal);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .step-icon {
            width: 42px;
            height: 42px;
            display: grid;
            place-items: center;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.08);
            color: var(--accent-teal);
            font-size: 1.25rem;
        }

        .step-copy {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .step-copy .label {
            font-weight: 800;
            color: white;
        }

        .step-copy .hint {
            color: var(--neutral-300);
            font-size: 0.9rem;
        }

        .pill-soft {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.08);
            font-weight: 700;
            color: var(--neutral-100);
        }

        .hero-grid {
            display: grid;
            gap: var(--space-8);
            grid-template-columns: 1.25fr 1fr;
            align-items: stretch;
        }

        .hero-panel {
            position: relative;
            overflow: hidden;
            padding: var(--space-8);
            border-radius: var(--radius-3xl);
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.12), rgba(77, 243, 201, 0.12) 50%, rgba(179, 139, 255, 0.12));
            border: 1px solid var(--border-strong);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(10px);
        }

        .hero-panel h1 {
            font-size: clamp(2rem, 3vw, 2.75rem);
            margin-bottom: var(--space-3);
        }

        .hero-panel p {
            color: var(--neutral-300);
            max-width: 720px;
        }

        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin: var(--space-6) 0 var(--space-4);
        }

        .hero-pills {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-3);
        }

        .pill {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-xl);
            background: var(--surface-muted);
            border: 1px solid var(--border-strong);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .pill-label {
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--neutral-400);
            margin-bottom: var(--space-1);
            display: block;
        }

        .pill-strong {
            font-weight: 800;
            color: white;
        }

        .snapshot-grid {
            display: grid;
            gap: var(--space-4);
        }

        .snapshot-card {
            padding: var(--space-6);
            border-radius: var(--radius-3xl);
            background: linear-gradient(145deg, rgba(77, 243, 201, 0.14), rgba(115, 179, 255, 0.14), rgba(179, 139, 255, 0.14));
            border: 1px solid var(--border-strong);
            box-shadow: var(--shadow-xl);
        }

        .readiness-dial {
            --value: 100;
            width: 160px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            background: conic-gradient(var(--accent-teal) calc(var(--value) * 1%), rgba(255, 255, 255, 0.08) 0);
            display: grid;
            place-items: center;
            position: relative;
            margin: 0 auto;
        }

        .readiness-dial::after {
            content: '';
            position: absolute;
            inset: 14px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15), rgba(2, 6, 23, 0.9));
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
        }

        .readiness-dial .readiness-value {
            position: relative;
            font-size: 2rem;
            font-weight: 800;
            color: white;
        }

        .readiness-dial .readiness-subtext {
            position: relative;
            color: var(--neutral-400);
            font-size: 0.85rem;
        }

        .snapshot-meta {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .meta-label {
            color: var(--neutral-400);
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .meta-value {
            font-size: 1.25rem;
            font-weight: 800;
            color: white;
        }

        .meta-subtle {
            color: var(--neutral-400);
            font-size: 0.85rem;
        }

        .micro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-3);
        }

        .micro-card {
            padding: var(--space-4);
            border-radius: var(--radius-xl);
            background: var(--surface-muted);
            border: 1px solid var(--border-strong);
            box-shadow: var(--shadow-md);
            display: grid;
            gap: var(--space-2);
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .status-chip[data-tone="ready"] {
            background: rgba(14, 165, 233, 0.15);
            color: var(--accent-blue);
        }

        .status-chip[data-tone="active"] {
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent-teal);
        }

        .status-chip[data-tone="paused"] {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }

        .status-chip[data-tone="done"] {
            background: rgba(6, 214, 160, 0.18);
            color: var(--accent-green);
        }

        .progress-timeline {
            display: grid;
            gap: var(--space-3);
        }

        .timeline-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .timeline-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .timeline-dot::after {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.14);
        }

        .timeline-body {
            flex: 1;
        }

        .timeline-label {
            font-weight: 700;
            color: white;
        }

        .timeline-hint {
            color: var(--neutral-400);
            font-size: 0.85rem;
        }

        .timeline-state {
            font-size: 0.75rem;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Grid System */
        .grid {
            display: grid;
            gap: var(--space-6);
        }
        
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        
        /* Flex System */
        .flex { display: flex; }
        .inline-flex { display: inline-flex; }
        .flex-col { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        .items-stretch { align-items: stretch; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-around { justify-content: space-around; }
        .justify-evenly { justify-content: space-evenly; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-nowrap { flex-wrap: nowrap; }
        
        /* Gap */
        .gap-1 { gap: var(--space-1); }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }
        .gap-8 { gap: var(--space-8); }
        .gap-12 { gap: var(--space-12); }
        
        /* =========================================================
           VISUAL EFFECTS
        ========================================================= */
        /* Glass Morphism */
        .glass {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-heavy {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        /* Scanlines */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 212, 170, 0.03) 50%
            );
            background-size: 100% 8px;
            pointer-events: none;
            z-index: var(--z-docked);
            animation: scan 10s linear infinite;
            opacity: 0.18;
        }

        body.calm .scanlines,
        body.reduced-motion .scanlines {
            display: none;
        }
        
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        
        /* Particle Effect */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: var(--z-below);
        }

        body.calm .particles,
        body.reduced-motion .particles {
            display: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--accent-teal);
            border-radius: var(--radius-full);
            opacity: 0;
            animation: particle-float 20s infinite linear;
        }
        
        @keyframes particle-float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.5;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Glow Effects */
        .glow {
            position: relative;
        }
        
        .glow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            filter: blur(20px);
            opacity: 0.3;
            z-index: -1;
            border-radius: inherit;
        }
        
        /* =========================================================
           COMPONENTS
        ========================================================= */
        /* Status Bar */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.82));
            backdrop-filter: blur(24px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            padding: var(--space-3) var(--space-6);
            z-index: var(--z-fixed);
            height: 64px;
            }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.2);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-teal);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.5; 
                transform: scale(1.1);
            }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Primary Navigation */
        .primary-nav {
            position: sticky;
            top: 64px;
            z-index: var(--z-sticky);
            backdrop-filter: blur(18px);
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.8));
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .nav-shell {
            display: grid;
            grid-template-columns: 1.4fr 2fr 1.2fr;
            align-items: center;
            gap: var(--space-6);
            padding: var(--space-4) var(--space-2);
        }

        .nav-brand h1 {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: var(--space-1);
        }

        .nav-brand p {
            color: var(--neutral-400);
            font-size: 0.9rem;
        }

        .nav-links {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: var(--space-3);
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.03);
            color: var(--neutral-100);
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .nav-link:hover,
        .nav-link:focus-visible {
            border-color: var(--accent-teal);
            background: rgba(77, 243, 201, 0.08);
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .nav-cta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--space-3);
        }

        .nav-state {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-lg);
            font-weight: 800;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--neutral-50);
        }

        .nav-state[data-tone="danger"] {
            border-color: rgba(255, 107, 129, 0.6);
            color: var(--accent-red);
        }

        .nav-state[data-tone="warning"] {
            border-color: rgba(255, 224, 130, 0.6);
            color: var(--accent-yellow);
        }

        .nav-state[data-tone="success"] {
            border-color: rgba(141, 244, 197, 0.6);
            color: var(--accent-green);
        }

        .nav-state[data-tone="info"] {
            border-color: rgba(124, 183, 255, 0.6);
            color: var(--accent-blue);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .nav-actions .btn {
            padding: var(--space-3) var(--space-4);
        }

        /* Action Dock */
        .action-dock {
            position: sticky;
            bottom: var(--space-6);
            z-index: var(--z-fixed);
            margin-top: var(--space-12);
        }

        .action-dock-shell {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(16, 26, 48, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-2xl);
            padding: var(--space-5);
            display: grid;
            grid-template-columns: 1.2fr 2fr;
            gap: var(--space-6);
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.4);
        }

        .dock-status h3 {
            font-size: 1.1rem;
            margin-bottom: var(--space-2);
        }

        .dock-status .dock-value {
            font-size: 2rem;
            font-weight: 900;
        }

        .dock-status .dock-hint {
            color: var(--neutral-400);
            margin-top: var(--space-2);
        }

        .dock-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--space-3);
            align-items: center;
        }

        .dock-actions .btn {
            width: 100%;
        }

        @media (max-width: 1024px) {
            .nav-shell {
                grid-template-columns: 1fr;
            }

            .session-banner__body {
                grid-template-columns: 1fr;
            }

            .nav-links {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .nav-cta {
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .action-dock-shell {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .nav-links {
                grid-template-columns: 1fr;
            }

            .session-banner {
                padding: var(--space-4);
            }

            .session-steps {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }

            .nav-actions {
                width: 100%;
            }

            .nav-actions .btn {
                width: 100%;
            }

            .action-dock {
                position: relative;
                bottom: auto;
            }
        }
        
        /* Card */
        .card {
            background: linear-gradient(160deg, rgba(15, 23, 42, 0.9), rgba(24, 36, 58, 0.88));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-base);
        }
        
        .card:hover {
            border-color: var(--accent-teal);
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        /* Panel */
        .panel {
            background: linear-gradient(180deg, rgba(12, 18, 35, 0.9), rgba(16, 26, 48, 0.92));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-2xl);
            overflow: hidden;
            transition: all var(--transition-base);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        }
        
        .panel-header {
            padding: var(--space-6);
            background: radial-gradient(circle at 0% 0%, rgba(77, 243, 201, 0.12), transparent 40%), rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .panel-body {
            padding: var(--space-6);
        }
        
        .panel-footer {
            padding: var(--space-6);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-6);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: none;
            letter-spacing: 0.01em;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-base);
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: #0b1224;
            border: none;
            box-shadow: 0 10px 30px rgba(77, 243, 201, 0.35);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.16);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-teal);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
            border: none;
        }
        
        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            border: none;
            animation: blink 2s infinite;
        }
        
        .btn-danger:hover {
            animation: none;
        }
        
        .btn-outline {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.18);
            color: var(--neutral-100);
        }
        
        .btn-outline:hover {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: 1rem;
        }
        
        .btn-xl {
            padding: var(--space-6) var(--space-12);
            font-size: 1.125rem;
            border-radius: var(--radius-2xl);
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-full);
        }
        
        .btn-group {
            display: flex;
            gap: var(--space-3);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-6);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--neutral-200);
            text-transform: none;
            letter-spacing: normal;
        }
        
        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--surface-muted);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            transition: all var(--transition-base);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-teal);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: var(--focus-ring);
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300D4AA'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-4) center;
            background-size: 1.25rem;
            padding-right: var(--space-12);
        }
        
        .form-range {
            width: 100%;
            height: 6px;
            background: var(--gradient-warning);
            border-radius: var(--radius-full);
            outline: none;
            -webkit-appearance: none;
        }
        
        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid var(--accent-teal);
            border-radius: var(--radius-full);
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
        }
        
        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow);
        }
        
        /* Progress Components */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }
        
        .progress-ring-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }
        
        .progress-ring-fill {
            stroke: var(--accent-teal);
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            font-family: var(--font-mono);
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            background: rgba(0, 212, 170, 0.1);
            color: var(--accent-teal);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* =========================================================
           SPECIAL COMPONENTS
        ========================================================= */
        /* Timer Display */
        .timer-display {
            font-family: var(--font-mono);
            font-size: 4.5rem;
            font-weight: 800;
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 60px rgba(0, 212, 170, 0.4);
            padding: var(--space-8);
            border: 2px solid rgba(0, 212, 170, 0.2);
            border-radius: var(--radius-2xl);
            position: relative;
            overflow: hidden;
        }
        
        .timer-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(0, 212, 170, 0.1) 50%,
                transparent 70%
            );
            animation: shine 3s ease-in-out infinite;
        }
        
        @keyframes shine {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        /* Metric Cards */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-6);
        }
        
        .metric-card {
            background: linear-gradient(160deg, rgba(13, 20, 39, 0.95), rgba(29, 43, 73, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-teal);
            box-shadow: var(--shadow-glow);
        }
        
        .metric-value {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: var(--space-4) 0;
            font-family: var(--font-mono);
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--neutral-400);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .metric-change {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .metric-change.positive { color: var(--accent-green); }
        .metric-change.negative { color: var(--accent-red); }
        
        /* Pain Scale */
        .pain-monitor {
            background: rgba(26, 10, 10, 0.3);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            margin: var(--space-8) 0;
        }
        
        .pain-scale {
            height: 48px;
            background: var(--gradient-warning);
            border-radius: var(--radius-full);
            position: relative;
            margin: var(--space-6) 0;
            box-shadow: var(--shadow-inner);
        }
        
        .pain-marker {
            position: absolute;
            top: -12px;
            width: 72px;
            height: 72px;
            background: white;
            border: 4px solid var(--neutral-950);
            border-radius: var(--radius-full);
            transform: translateX(-50%);
            cursor: grab;
            box-shadow: var(--shadow-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--neutral-950);
            transition: all var(--transition-base);
            user-select: none;
            z-index: var(--z-above);
        }
        
        .pain-marker:active {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.1);
        }
        
        .pain-threshold {
            position: absolute;
            top: -10px;
            bottom: -10px;
            width: 3px;
            background: white;
            transform: translateX(-50%);
            box-shadow: 0 0 15px white;
            z-index: var(--z-base);
        }
        
        .pain-labels {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-4);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-300);
        }
        
        .pain-warning {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--accent-red);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-top: var(--space-6);
            animation: blink 2s infinite;
        }
        
        /* Exercise Cards */
        .exercise-stack {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .exercise-card {
            background: var(--neutral-900);
            border-left: 6px solid var(--accent-teal);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        
        .exercise-card:hover {
            transform: translateX(8px);
            border-left-color: var(--accent-teal-light);
            box-shadow: var(--shadow-glow);
        }
        
        .exercise-card.completed {
            border-left-color: var(--accent-green);
            background: rgba(6, 214, 160, 0.05);
        }
        
        .exercise-card.completed::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            right: var(--space-6);
            transform: translateY(-50%);
            font-size: 2rem;
            color: var(--accent-green);
            font-weight: 700;
            text-shadow: 0 0 20px currentColor;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .exercise-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }
        
        .exercise-difficulty {
            padding: var(--space-1) var(--space-3);
            background: var(--accent-teal);
            color: var(--neutral-950);
            font-size: 0.75rem;
            font-weight: 800;
            border-radius: var(--radius-full);
            text-transform: uppercase;
        }
        
        .exercise-meta {
            display: flex;
            gap: var(--space-6);
            color: var(--neutral-400);
            font-size: 0.875rem;
            margin-bottom: var(--space-4);
        }
        
        .exercise-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-4);
            margin: var(--space-6) 0;
        }
        
        .stat-item {
            text-align: center;
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-lg);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-teal);
            font-family: var(--font-mono);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--neutral-400);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Plan layout */
        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: var(--space-4);
        }

        .plan-week {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .plan-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .plan-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.06);
            color: var(--neutral-300);
            font-size: 0.85rem;
        }

        .plan-list {
            list-style: disc;
            margin-left: var(--space-6);
            color: var(--neutral-300);
        }

        .plan-list strong {
            color: white;
        }

        .safety-callout {
            border: 1px solid rgba(56, 189, 248, 0.4);
            background: rgba(56, 189, 248, 0.08);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }

        .exercise-prescription {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-full);
            color: var(--neutral-300);
            font-size: 0.85rem;
            margin-bottom: var(--space-3);
        }
        
        /* =========================================================
           NEW FEATURE COMPONENTS
        ========================================================= */
        /* Voice Control */
        .voice-control-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: var(--z-tooltip);
        }
        
        .voice-pulse {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-xl);
            position: relative;
            animation: voice-pulse 2s infinite;
        }
        
        @keyframes voice-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 212, 170, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0); }
        }
        
        .voice-active {
            animation: voice-pulse 0.5s infinite;
            background: var(--gradient-danger);
        }
        
        .voice-transcript {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: var(--neutral-900);
            border: 1px solid var(--accent-teal);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            min-width: 200px;
            max-width: 300px;
            box-shadow: var(--shadow-xl);
            font-size: 0.875rem;
            color: var(--neutral-100);
        }
        
        /* Biometric Authentication */
        .biometric-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: var(--z-modal);
            align-items: center;
            justify-content: center;
        }
        
        .biometric-modal.active {
            display: flex;
            animation: modal-fade-in 0.3s ease;
        }
        
        .biometric-scanner {
            width: 300px;
            height: 300px;
            border: 3px solid var(--accent-teal);
            border-radius: var(--radius-2xl);
            position: relative;
            overflow: hidden;
            background: var(--gradient-dark);
        }
        
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-teal);
            animation: scan 2s linear infinite;
        }
        
        /* Video Call */
        .video-call-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 300px;
            height: 200px;
            background: var(--neutral-900);
            border: 2px solid var(--accent-blue);
            border-radius: var(--radius-xl);
            overflow: hidden;
            z-index: var(--z-docked);
            box-shadow: var(--shadow-2xl);
        }
        
        .video-local {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 60px;
            background: var(--neutral-800);
            border: 2px solid var(--accent-green);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: var(--space-3);
            display: flex;
            justify-content: center;
            gap: var(--space-3);
        }
        
        /* Social Features */
        .social-share {
            background: var(--neutral-900);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-top: var(--space-8);
        }
        
        .share-options {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-4);
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-base);
            min-width: 80px;
        }
        
        .share-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* ML Recommendations */
        .ml-recommendation {
            background: var(--gradient-primary);
            background-attachment: fixed;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin: var(--space-6) 0;
            position: relative;
            overflow: hidden;
        }
        
        .ml-recommendation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }
        
        .ml-content {
            position: relative;
            z-index: 2;
            color: white;
        }
        
        .ml-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: var(--space-4);
        }
        
        /* =========================================================
           MODAL SYSTEM
        ========================================================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-6);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: modal-fade-in 0.3s ease;
        }
        
        @keyframes modal-fade-in {
            from {
                opacity: 0;
                backdrop-filter: blur(0);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(20px);
            }
        }
        
        .modal-content {
            background: var(--neutral-900);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-2xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modal-slide-up 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-2xl);
        }
        
        @keyframes modal-slide-up {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: var(--space-6);
            background: var(--gradient-primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: all var(--transition-fast);
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: var(--space-6);
        }
        
        .modal-footer {
            padding: var(--space-6);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-4);
        }
        
        /* =========================================================
           NOTIFICATION SYSTEM
        ========================================================= */
        .notification-container {
            position: fixed;
            top: 80px;
            right: var(--space-6);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            max-width: 400px;
        }
        
        .notification {
            background: var(--neutral-900);
            border-left: 4px solid var(--accent-teal);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            animation: notification-slide-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        @keyframes notification-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success { border-color: var(--accent-green); }
        .notification.warning { border-color: var(--accent-yellow); }
        .notification.error { border-color: var(--accent-red); }
        .notification.info { border-color: var(--accent-blue); }
        
        .notification-title {
            font-weight: 700;
            color: white;
            margin-bottom: var(--space-1);
        }
        
        .notification-message {
            color: var(--neutral-400);
            font-size: 0.875rem;
        }
        
        .notification-close {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: none;
            border: none;
            color: var(--neutral-400);
            cursor: pointer;
            font-size: 1.25rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: all var(--transition-fast);
        }
        
        .notification-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* =========================================================
           UTILITY CLASSES
        ========================================================= */
        .hidden { display: none !important; }
        .block { display: block; }
        .inline-block { display: inline-block; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .min-h-screen { min-height: 100vh; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .text-6xl { font-size: 3.75rem; }
        
        .font-light { font-weight: 300; }
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-extrabold { font-weight: 800; }
        .font-black { font-weight: 900; }
        
        .text-white { color: white; }
        .text-neutral-400 { color: var(--neutral-400); }
        .text-neutral-500 { color: var(--neutral-500); }
        .text-teal { color: var(--accent-teal); }
        .text-blue { color: var(--accent-blue); }
        .text-green { color: var(--accent-green); }
        .text-red { color: var(--accent-red); }
        .text-yellow { color: var(--accent-yellow); }
        .text-purple { color: var(--accent-purple); }
        .text-orange { color: var(--accent-orange); }
        
        .bg-dark { background: var(--neutral-950); }
        .bg-darker { background: var(--neutral-900); }
        
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-2xl { border-radius: var(--radius-2xl); }
        
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .shadow-xl { box-shadow: var(--shadow-xl); }
        
        .cursor-pointer { cursor: pointer; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        
        .select-none { user-select: none; }
        
        .opacity-0 { opacity: 0; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .opacity-100 { opacity: 1; }
        
        .transition-all { transition: all var(--transition-base); }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        
        .mt-1 { margin-top: var(--space-1); }
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mt-8 { margin-top: var(--space-8); }
        
        .mb-1 { margin-bottom: var(--space-1); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }
        
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .p-1 { padding: var(--space-1); }
        .p-2 { padding: var(--space-2); }
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-6 { padding: var(--space-6); }
        .p-8 { padding: var(--space-8); }
        
        .px-3 { padding-left: var(--space-3); padding-right: var(--space-3); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }
        
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
        .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }
        .py-6 { padding-top: var(--space-6); padding-bottom: var(--space-6); }
        .py-8 { padding-top: var(--space-8); padding-bottom: var(--space-8); }
        
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-30 { z-index: 30; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }

        /* =========================================================
           REDUCED MOTION SUPPORT
        ========================================================= */
        body.reduced-motion {
            scroll-behavior: auto;
        }
        body.reduced-motion *, 
        body.calm.reduced-motion * {
            animation: none !important;
            transition: none !important;
        }
        body.reduced-motion .scanlines,
        body.reduced-motion .particles,
        body.reduced-motion .grid-overlay,
        body.reduced-motion::before {
            display: none !important;
        }
        body.reduced-motion .status-dot {
            animation: none !important;
        }

        @media (prefers-reduced-motion: reduce) {
            html { scroll-behavior: auto; }
            * {
                animation-duration: 0.001ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0ms !important;
                scroll-behavior: auto !important;
            }
            .scanlines,
            .particles,
            .grid-overlay,
            .glow::after,
            body::before {
                display: none !important;
            }
        }

        /* =========================================================
           CALM MODE OVERRIDES
        ========================================================= */
        body.calm {
            background: #f8fafc !important;
            color: #0f172a !important;
        }
        body.calm::before { display:none !important; }
        body.calm .scanlines,
        body.calm .particles { display:none !important; }

        body.calm .status-bar{
            background: rgba(255,255,255,0.9) !important;
            border-bottom: 1px solid rgba(15,23,42,0.12) !important;
        }
        body.calm .status-bar *{ color:#0f172a !important; }
        body.calm .status-indicator{
            background: rgba(37,99,235,0.08) !important;
            border-color: rgba(37,99,235,0.18) !important;
            color:#2563eb !important;
        }
        body.calm .panel,
        body.calm .card,
        body.calm .modal-content,
        body.calm .notification{
            background:#ffffff !important;
            color:#0f172a !important;
            border-color: rgba(15,23,42,0.12) !important;
            box-shadow: 0 10px 30px rgba(15,23,42,0.08) !important;
        }
        body.calm .panel-header{
            background: #0f172a !important;
            border-bottom: none !important;
        }
        body.calm .panel-header *{ color:#ffffff !important; }
        body.calm .panel-footer{
            background: #f1f5f9 !important;
            border-top: 1px solid rgba(15,23,42,0.10) !important;
        }
        body.calm .text-gradient{
            background: linear-gradient(135deg,#2563eb 0%, #16a34a 100%) !important;
            -webkit-background-clip:text !important;
            background-clip:text !important;
        }
        body.calm .form-control{
            background:#ffffff !important;
            color:#0f172a !important;
            border-color: rgba(15,23,42,0.15) !important;
        }
        body.calm .form-control:focus{
            border-color:#2563eb !important;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.18) !important;
        }
        body.calm .btn-secondary{
            background:#f1f5f9 !important;
            border-color: rgba(15,23,42,0.18) !important;
            color:#0f172a !important;
        }
        body.calm .btn-outline{
            border-color: rgba(15,23,42,0.22) !important;
            color:#0f172a !important;
        }
        body.calm .hero-panel,
        body.calm .snapshot-card,
        body.calm .micro-card{
            background:#ffffff !important;
            color:#0f172a !important;
            border-color: rgba(15,23,42,0.08) !important;
            box-shadow: 0 10px 30px rgba(15,23,42,0.06) !important;
        }
        body.calm .timeline-state,
        body.calm .pill,
        body.calm .hero-panel p{
            color:#0f172a !important;
        }
        body.calm .readiness-dial::after{
            background:#f8fafc !important;
        }
        body.calm .metric-card{
            background:#ffffff !important;
        }
        body.calm .metric-label{ color:#475569 !important; }
        body.calm .text-neutral-400,
        body.calm .text-neutral-500{ color:#475569 !important; }
        body.calm .pain-monitor{
            background:#fff7ed !important;
            border-color: rgba(234,88,12,0.35) !important;
        }

        /* =========================================================
           RESPONSIVE DESIGN
        ========================================================= */
        @media (max-width: 1024px) {
            .metric-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            .grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            .timer-display {
                font-size: 3.5rem;
            }
            
            .video-call-container {
                width: 250px;
                height: 180px;
            }

            .hero-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 var(--space-4);
            }
            
            .metric-grid {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .timer-display {
                font-size: 2.5rem;
                padding: var(--space-6);
            }
            
            .section {
                padding: var(--space-12) 0;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                width: 100%;
            }
            
            .video-call-container {
                width: 200px;
                height: 150px;
                bottom: 80px;
            }
            
            .voice-control-indicator {
                bottom: 10px;
                right: 10px;
            }

            .hero-actions {
                flex-direction: column;
            }

            .hero-actions .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .timer-display {
                font-size: 2rem;
            }
            
            .modal-content {
                margin: var(--space-2);
            }
            
            .status-bar {
                padding: var(--space-2) var(--space-4);
                height: auto;
                flex-direction: column;
                gap: var(--space-2);
            }
            
            .video-call-container {
                position: relative;
                width: 100%;
                height: 200px;
                bottom: 0;
                left: 0;
                margin-bottom: var(--space-6);
            }
        }
    </style>
</head>
<body>
    <!-- Visual Effects -->
    <div class="scanlines"></div>
    <div class="grid-overlay"></div>
    <div class="particles" id="particles"></div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="container flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="status-dot" id="systemStatus"></div>
                    <span class="text-sm font-semibold text-teal" id="statusText">Ready</span>
                </div>
                <div class="font-mono text-lg text-blue" id="currentTime">00:00:00</div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-sm font-bold text-yellow" id="missionName">Rehab Session</div>
                    <div class="text-xs text-neutral-400" id="operatorName">Patient: Not set</div>
                </div>
                
                <div class="flex items-center gap-3" style="margin-left: 12px;">
                    <span class="text-xs text-neutral-400" id="calmToggleLabel">Calm</span>
                    <button class="btn btn-icon btn-secondary" id="calmToggleBtn" aria-pressed="true" aria-label="Toggle calm mode"
                            onclick="toggleCalmMode()" title="Toggle Calm Mode" style="width:40px;height:40px;">
                        <i class="ri-moon-clear-line"></i>
                    </button>
                </div>
                
                <!-- New Feature Buttons -->
                <button class="btn btn-icon btn-secondary" onclick="toggleVoiceControl()" title="Voice Control">
                    <i class="ri-mic-line"></i>
                </button>
                <button class="btn btn-icon btn-secondary" onclick="toggleVideoCall()" title="Video Call">
                    <i class="ri-video-line"></i>
                </button>
                <button class="btn btn-icon btn-secondary" onclick="showSocialShare()" title="Share Progress">
                    <i class="ri-share-line"></i>
                </button>
                <button class="btn btn-icon btn-secondary" onclick="showBiometricAuth()">
                    <i class="ri-fingerprint-line"></i>
                </button>
                <button class="btn btn-icon btn-secondary" onclick="showProfileModal()">
                    <i class="ri-user-line"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Guided Navigation -->
    <nav class="primary-nav" aria-label="Primary navigation">
        <div class="container nav-shell">
            <div class="nav-brand">
                <h1>Rehab Session Pro</h1>
                <p>Guided steps with calmer visuals and quick access.</p>
            </div>
            <div class="nav-links" role="list">
                <button class="nav-link" onclick="scrollToSection('phaseAuth')" role="listitem">
                    <i class="ri-id-card-line"></i> Sign in
                </button>
                <button class="nav-link" onclick="scrollToSection('phaseBio')" role="listitem">
                    <i class="ri-heart-pulse-line"></i> Readiness
                </button>
                <button class="nav-link" onclick="scrollToSection('phaseMission')" role="listitem">
                    <i class="ri-run-line"></i> Exercises
                </button>
                <button class="nav-link" onclick="scrollToSection('phaseDebrief')" role="listitem">
                    <i class="ri-clipboard-line"></i> Summary
                </button>
            </div>
            <div class="nav-cta">
                <span class="nav-state" id="navSessionState" aria-live="polite" data-tone="info">Prep</span>
                <div class="nav-actions">
                    <button class="btn btn-primary" id="navPrimaryAction" onclick="handlePrimaryNavAction()">
                        <i class="ri-play-line"></i> Start session
                    </button>
                    <button class="btn btn-outline" onclick="toggleCalmMode()">
                        <i class="ri-moon-clear-line"></i> Calm visuals
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <!-- Voice Control Indicator -->
    <div class="voice-control-indicator">
        <div class="voice-pulse" id="voiceControlBtn" onclick="toggleVoiceControl()">
            <i class="ri-mic-line"></i>
        </div>
        <div class="voice-transcript hidden" id="voiceTranscript"></div>
    </div>
    
    <!-- Video Call Container -->
    <div class="video-call-container hidden" id="videoCallContainer">
        <div class="video-remote" id="videoRemote">
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="text-4xl text-blue mb-3">
                        <i class="ri-video-line"></i>
                    </div>
                    <p class="text-sm">Therapist connecting...</p>
                </div>
            </div>
        </div>
        <div class="video-local" id="videoLocal">
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="text-xl text-green">
                        <i class="ri-user-line"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="video-controls">
            <button class="btn btn-icon btn-secondary" onclick="toggleVideoMute()">
                <i class="ri-mic-line" id="videoMuteIcon"></i>
            </button>
            <button class="btn btn-icon btn-danger" onclick="endVideoCall()">
                <i class="ri-phone-line"></i>
            </button>
            <button class="btn btn-icon btn-secondary" onclick="toggleVideoCamera()">
                <i class="ri-camera-line" id="videoCameraIcon"></i>
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="pt-20">
        <div class="container">
            <section class="section hero-shell" aria-labelledby="overviewTitle">
                <div class="session-banner mb-6">
                    <div class="session-banner__header">
                        <div class="session-chip" id="sessionStateChip">
                            <span class="status-dot"></span>
                            <span id="sessionStateText">Ready</span>
                        </div>
                        <div class="session-clock" id="sessionCountdown">
                            <i class="ri-time-line"></i>
                            <span id="sessionClockValue">--:--:--</span>
                        </div>
                        <div class="session-plan-tag">
                            <i class="ri-shield-star-line"></i>
                            Rehab Session Â· Pro
                        </div>
                    </div>

                    <div class="session-banner__body">
                        <div class="session-persona">
                            <p class="eyebrow">Patient</p>
                            <h3 id="sessionPatient">Marvin</h3>
                            <p class="text-neutral-300" id="sessionPersonaCopy">Balance rehab Â· calm visuals on</p>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary btn-lg" type="button" id="heroPrimaryCta" onclick="handlePrimaryNavAction()">
                                <i class="ri-play-line"></i> Start session
                            </button>
                            <button class="btn btn-outline btn-lg" type="button" onclick="toggleCalmMode()">
                                <i class="ri-moon-clear-line"></i> Calm visuals
                            </button>
                            <button class="btn btn-secondary btn-lg" type="button" onclick="scrollToSection('phaseMission')">
                                <i class="ri-run-line"></i> Jump to exercises
                            </button>
                        </div>
                    </div>

                    <div class="session-steps">
                        <button class="step-card" type="button" onclick="scrollToSection('phaseAuth')">
                            <div class="step-icon">
                                <i class="ri-id-card-line"></i>
                            </div>
                            <div class="step-copy">
                                <span class="label">Sign in</span>
                                <span class="hint">Patient ID & clearance</span>
                            </div>
                            <span class="pill-soft" id="stepAuthState">Prep</span>
                        </button>
                        <button class="step-card" type="button" onclick="scrollToSection('phaseBio')">
                            <div class="step-icon">
                                <i class="ri-heart-pulse-line"></i>
                            </div>
                            <div class="step-copy">
                                <span class="label">Readiness</span>
                                <span class="hint">Pain, fatigue, stability</span>
                            </div>
                            <span class="pill-soft" id="stepBioState">Locked</span>
                        </button>
                        <button class="step-card" type="button" onclick="scrollToSection('phaseMission')">
                            <div class="step-icon">
                                <i class="ri-run-line"></i>
                            </div>
                            <div class="step-copy">
                                <span class="label">Exercises</span>
                                <span class="hint">Timer + voice control</span>
                            </div>
                            <span class="pill-soft" id="stepMissionState">Queued</span>
                        </button>
                        <button class="step-card" type="button" onclick="scrollToSection('phaseDebrief')">
                            <div class="step-icon">
                                <i class="ri-clipboard-line"></i>
                            </div>
                            <div class="step-copy">
                                <span class="label">Summary</span>
                                <span class="hint">Notes & export</span>
                            </div>
                            <span class="pill-soft" id="stepDebriefState">Later</span>
                        </button>
                    </div>
                </div>

                <div class="hero-grid">
                    <div class="hero-panel">
                        <span class="badge">Patient-first layout</span>
                        <h1 id="overviewTitle" class="text-gradient">Calmer rehab. Clearer next steps.</h1>
                        <p>Stay focused on what matters: safe movement, measurable progress, and fast access to the right phase. The experience now leads with clarity, not noise.</p>
                        
                        <div class="hero-actions">
                            <button class="btn btn-primary btn-xl" onclick="document.getElementById('phaseAuth').scrollIntoView({behavior: 'smooth'})">
                                <i class="ri-flag-line"></i> Start today's plan
                            </button>
                            <button class="btn btn-secondary btn-lg" onclick="toggleCalmMode()">
                                <i class="ri-moon-clear-line"></i> Toggle Calm / Pro
                            </button>
                            <button class="btn btn-outline btn-lg" onclick="document.getElementById('phaseBio').scrollIntoView({behavior: 'smooth'})">
                                <i class="ri-focus-line"></i> Jump to readiness
                            </button>
                        </div>
                        
                        <div class="hero-pills">
                            <div class="pill">
                                <span class="pill-label">Profile</span>
                                <span class="pill-strong" id="summaryProfile">â€”</span>
                                <div class="meta-subtle" id="summarySupport">Injury focus Â· Intensity</div>
                            </div>
                            <div class="pill">
                                <span class="pill-label">Streak</span>
                                <span class="pill-strong" id="summaryStreak">0 days</span>
                                <div class="meta-subtle">Total sessions <span id="summarySessions">0</span></div>
                            </div>
                            <div class="pill">
                                <span class="pill-label">Pain ceiling</span>
                                <span class="pill-strong" id="summaryPainLimit">7 / 10</span>
                                <div class="meta-subtle">Current baseline <span id="summaryPainBaseline">0 / 10</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="snapshot-grid">
                        <div class="snapshot-card">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <p class="meta-label">Session readiness</p>
                                    <p class="text-xl font-bold text-white">Live signal</p>
                                </div>
                                <span class="status-chip" id="summarySessionChip" data-tone="ready">Ready</span>
                            </div>
                            <div class="readiness-dial" id="summaryReadinessDial" style="--value: 100">
                                <div class="readiness-value" id="summaryReadinessValue">100%</div>
                                <div class="readiness-subtext" id="summaryPhaseCopy">Auth required</div>
                            </div>
                            <div class="snapshot-meta">
                                <div>
                                    <div class="meta-label">Current pain</div>
                                    <div class="meta-value" id="summaryPainBadge">0.0 / 10</div>
                                    <div class="meta-subtle">Live drag or slider</div>
                                </div>
                                <div>
                                    <div class="meta-label">Fatigue</div>
                                    <div class="meta-value" id="summaryFatigue">0%</div>
                                    <div class="meta-subtle">Auto-adjusted</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="micro-grid">
                            <div class="micro-card">
                                <div class="meta-label">Now</div>
                                <div class="timeline-label" id="summaryPhaseChip">Authenticate</div>
                                <div class="timeline-hint">Verify, set baseline, then advance.</div>
                            </div>
                            <div class="micro-card">
                                <div class="meta-label">Flow</div>
                                <div class="progress-timeline">
                                    <div class="timeline-step">
                                        <div class="timeline-dot" id="timelineAuthDot"></div>
                                        <div class="timeline-body">
                                            <div class="timeline-label">Authenticate</div>
                                            <div class="timeline-hint">ID + clearance</div>
                                        </div>
                                        <div class="timeline-state" id="timelineAuthState">Ready</div>
                                    </div>
                                    <div class="timeline-step">
                                        <div class="timeline-dot" id="timelineReadyDot"></div>
                                        <div class="timeline-body">
                                            <div class="timeline-label">Readiness</div>
                                            <div class="timeline-hint">Baseline & thresholds</div>
                                        </div>
                                        <div class="timeline-state" id="timelineReadyState">Waiting</div>
                                    </div>
                                    <div class="timeline-step">
                                        <div class="timeline-dot" id="timelineWorkDot"></div>
                                        <div class="timeline-body">
                                            <div class="timeline-label">Exercise stack</div>
                                            <div class="timeline-hint">Timer + voice control</div>
                                        </div>
                                        <div class="timeline-state" id="timelineWorkState">Queued</div>
                                    </div>
                                    <div class="timeline-step">
                                        <div class="timeline-dot" id="timelineDebriefDot"></div>
                                        <div class="timeline-body">
                                            <div class="timeline-label">Recovery</div>
                                            <div class="timeline-hint">Debrief & share</div>
                                        </div>
                                        <div class="timeline-state" id="timelineDebriefState">Queued</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Progressive Plan -->
            <section id="clinicalPlan" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-black text-gradient">Progressive balance & leg strength plan</h2>
                                <p class="text-neutral-400 mt-2">2â€“4 weeks Â· 10â€“15 minutes per day Â· calm, predictable progressions</p>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot"></div>
                                <span>Clinician issued</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="safety-callout">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <p class="text-xl font-bold text-white">Safety baseline</p>
                                    <p class="text-neutral-300 mt-2">Stand near a wall or counter. Move slowly. Breathe normally. Stop if dizzy, tired, or pain rises.</p>
                                </div>
                                <div class="plan-meta">
                                    <span class="plan-tag"><i class="ri-timer-line"></i>10â€“15 minutes daily</span>
                                    <span class="plan-tag"><i class="ri-shield-check-line"></i>No surprise balance challenges</span>
                                    <span class="plan-tag"><i class="ri-repeat-line"></i>Progress by time + control only</span>
                                </div>
                            </div>
                            <p class="text-sm text-neutral-400 mt-4">If you miss a day, resume where you left off. Week 4 is optionalâ€”advance only when Weeks 1â€“3 feel steady.</p>
                        </div>

                        <div class="plan-grid mt-6">
                            <div class="card plan-week">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold">Week 1 â€” Learning & Safety</h3>
                                        <p class="text-neutral-400">Learn the movements. Light wall contact is okay.</p>
                                    </div>
                                    <span class="badge">Holds: 5â€“10s</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Balance</h4>
                                    <ul class="plan-list">
                                        <li><strong>Single-Leg Stand:</strong> Stand on one leg, other foot lightly off the floor. Hold 5â€“10 seconds. 2Ã— each leg.</li>
                                        <li><strong>Feet in a Line (Tandem):</strong> Heel-to-toe stand, hold 10 seconds, switch lead foot. 2Ã—.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Walking</h4>
                                    <ul class="plan-list">
                                        <li><strong>Side Stepping:</strong> 5 steps left, 5 steps right. 2 rounds.</li>
                                        <li><strong>Backward Walking:</strong> 5 slow steps. 2 rounds.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Strength</h4>
                                    <ul class="plan-list">
                                        <li><strong>Calf Raises:</strong> Hold the counter. Rise onto toes. 10 each leg.</li>
                                        <li><strong>Marching Knees:</strong> Lift one knee at a time. 10 total steps.</li>
                                        <li><strong>Mini Squats:</strong> Small knee bend. 8â€“10 times.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card plan-week">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold">Week 2 â€” Longer Holds</h3>
                                        <p class="text-neutral-400">Stay steady longer. Try not to touch the wall.</p>
                                    </div>
                                    <span class="badge">Holds: 15s</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Balance</h4>
                                    <ul class="plan-list">
                                        <li><strong>Single-Leg Stand:</strong> Hold 15 seconds. 2Ã— each leg.</li>
                                        <li><strong>Tandem Stand:</strong> Hold 15 seconds, switch feet. 2Ã—.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Walking</h4>
                                    <ul class="plan-list">
                                        <li><strong>Side Stepping:</strong> 8 steps each direction. 2 rounds.</li>
                                        <li><strong>Backward Walking:</strong> 8 slow steps. 2 rounds.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Strength</h4>
                                    <ul class="plan-list">
                                        <li><strong>Calf Raises:</strong> 15 each leg.</li>
                                        <li><strong>Side Kicks:</strong> Slightly back and to the side. 10 each leg.</li>
                                        <li><strong>Marching Knees:</strong> 15 total steps.</li>
                                        <li><strong>Mini Squats:</strong> 10â€“12 times.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card plan-week">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold">Week 3 â€” Better Control</h3>
                                        <p class="text-neutral-400">Balance without rushing. Reset if shaky.</p>
                                    </div>
                                    <span class="badge">Holds: 20s</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Balance</h4>
                                    <ul class="plan-list">
                                        <li><strong>Single-Leg Stand:</strong> Hold 20 seconds. 2Ã— each leg.</li>
                                        <li><strong>Heel-to-Toe Walk:</strong> 6â€“8 heel-to-toe steps forward. 2 rounds.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Walking</h4>
                                    <ul class="plan-list">
                                        <li><strong>Side Stepping:</strong> 10 steps each direction.</li>
                                        <li><strong>Backward Walking:</strong> 10 slow steps.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Strength</h4>
                                    <ul class="plan-list">
                                        <li><strong>Calf Raises:</strong> 20 each leg.</li>
                                        <li><strong>Back Kicks:</strong> Straight leg backward. 10 each leg.</li>
                                        <li><strong>Marching Knees:</strong> 20 total steps.</li>
                                        <li><strong>Mini Squats:</strong> 12â€“15 times.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card plan-week">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold">Week 4 â€” Stability (Optional)</h3>
                                        <p class="text-neutral-400">Use only if Weeks 1â€“3 feel safe. Keep movements slow.</p>
                                    </div>
                                    <span class="badge">Optional</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Balance</h4>
                                    <ul class="plan-list">
                                        <li><strong>Single-Leg Stand + Arms:</strong> Hold 20 seconds while slowly moving arms.</li>
                                        <li><strong>Heel-to-Toe Walk:</strong> 10 steps. 2 rounds.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Walking</h4>
                                    <ul class="plan-list">
                                        <li><strong>Side Stepping:</strong> 10â€“12 steps each direction.</li>
                                        <li><strong>Backward Walking:</strong> 10â€“12 steps.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Strength</h4>
                                    <ul class="plan-list">
                                        <li><strong>Calf Raises:</strong> 20 each leg.</li>
                                        <li><strong>Side Kicks:</strong> 12 each leg.</li>
                                        <li><strong>Butt Kicks:</strong> Heel toward bottom. 10â€“12 each leg.</li>
                                        <li><strong>Mini Squats:</strong> 15â€“20 times.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold">Important safety reminders</h3>
                                <span class="badge"><i class="ri-mental-health-line"></i> Patient-first</span>
                            </div>
                            <ul class="plan-list">
                                <li>Move slowly and keep breaths even. Pause and reset if balance feels unsteady.</li>
                                <li>Use the wall or counter for support when needed. Let go only when you feel steady.</li>
                                <li>Stop if pain, dizziness, or fatigue increases. Rest and resume when ready.</li>
                                <li>If you miss a day, pick up where you left offâ€”consistency matters more than speed.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Phase 1: Authentication -->
            <section id="phaseAuth" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-4xl font-black text-gradient">Rehab Session Pro</h1>
                                <p class="text-neutral-400 mt-2">AI-powered rehabilitation with voice control & telehealth</p>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot"></div>
                                <span>Start here</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-body">
                        <div class="grid grid-cols-2 gap-12">
                            <!-- Operator Info -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Your name</label>
                                    <input type="text" class="form-control" id="operatorId" 
                                           placeholder="Enter your name" value="MARVIN">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">SECURITY CLEARANCE</label>
                                    <input type="password" class="form-control" id="securityCode" 
                                           placeholder="Optional" value="Rehab_RISING">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">SESSION PROFILE</label>
                                    <select class="form-control form-select" id="missionProfile">
                                        <option value="HARDCORE">HARDCORE: NO RETREAT</option>
                                        <option value="AGGRESSIVE">AGGRESSIVE: MAXIMUM FORCE</option>
                                        <option value="STANDARD">STANDARD: STEADY PROGRESS</option>
                                        <option value="RECOVERY">RECOVERY: TACTICAL REHAB</option>
                                        <option value="AI_ADAPTIVE">AI ADAPTIVE: SMART PROGRESS</option>
                                    </select>
                                </div>
                                
                                <!-- ML Recommendations Card -->
                                <div class="ml-recommendation mt-8">
                                    <div class="ml-content">
                                        <div class="ml-badge">
                                            <i class="ri-brain-line"></i>
                                            AI RECOMMENDATION
                                        </div>
                                        <h3 class="text-xl font-bold mb-2" id="mlRecommendationTitle">Personalized Plan</h3>
                                        <p class="text-sm mb-4" id="mlRecommendationText">Based on your history, AI suggests focusing on balance exercises today.</p>
                                        <div class="flex gap-3">
                                            <button class="btn btn-sm btn-secondary" onclick="viewMLInsights()">
                                                <i class="ri-line-chart-line"></i> Insights
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="applyMLRecommendation()">
                                                <i class="ri-check-line"></i> Apply
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bio Metrics -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label">BASELINE PAIN INDEX (0-10)</label>
                                    <input type="range" class="form-range" id="baselinePain" min="0" max="10" value="0">
                                    <div class="flex justify-between mt-3">
                                        <span class="text-sm text-neutral-400">NO PAIN</span>
                                        <span class="text-sm font-bold text-teal" id="painValue">0</span>
                                        <span class="text-sm text-neutral-400">MAXIMUM</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">FATIGUE LEVEL</label>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" id="fatigueBar" style="width: 0%"></div>
                                    </div>
                                    <div class="flex justify-between mt-3">
                                        <span class="text-sm text-neutral-400">RESTED</span>
                                        <span class="text-sm font-bold text-teal" id="fatigueValue">0%</span>
                                        <span class="text-sm text-neutral-400">EXHAUSTED</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">READINESS ASSESSMENT</label>
                                    <div class="flex flex-col items-center mt-6">
                                        <div class="progress-ring">
                                            <svg width="140" height="140">
                                                <circle class="progress-ring-circle progress-ring-bg" cx="70" cy="70" r="60"></circle>
                                                <circle class="progress-ring-circle progress-ring-fill" cx="70" cy="70" r="60" id="readinessRing"></circle>
                                            </svg>
                                            <div class="progress-ring-text text-3xl" id="readinessScore">100%</div>
                                        </div>
                                        <p class="text-sm text-neutral-400 mt-4">System calibrated and ready for protocol initiation</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Voice Control Instructions -->
                        <div class="card mt-12">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold">VOICE COMMANDS</h3>
                                <span class="badge">
                                    <i class="ri-mic-line"></i> ACTIVE
                                </span>
                            </div>
                            <div class="grid grid-cols-3 gap-8">
                                <div class="text-center">
                                    <div class="text-4xl text-teal mb-3">ðŸŽ¤</div>
                                    <h4 class="font-bold mb-2">"START EXERCISE"</h4>
                                    <p class="text-sm text-neutral-400">Begins current exercise timer</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl text-blue mb-3">â¸ï¸</div>
                                    <h4 class="font-bold mb-2">"STOP TIMER"</h4>
                                    <p class="text-sm text-neutral-400">Pauses active exercise</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl text-purple mb-3">ðŸ“Š</div>
                                    <h4 class="font-bold mb-2">"NEXT EXERCISE"</h4>
                                    <p class="text-sm text-neutral-400">Moves to next exercise</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-footer">
                        <div class="flex items-center justify-between">
                            <button class="btn btn-secondary" onclick="showBiometricAuth()">
                                <i class="ri-fingerprint-line"></i> BIOMETRIC LOGIN
                            </button>
                            <div class="flex gap-4">
                                <button class="btn btn-danger" onclick="abortProtocol()">
                                    <i class="ri-error-warning-line"></i> END
                                </button>
                                <button class="btn btn-primary btn-lg" onclick="authenticateOperator()">
                                    <i class="ri-fire-line"></i> INITIATE PLAN
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Phase 2: Bio-Readiness -->
            <section id="phaseBio" class="section hidden">
                <div class="panel">
                    <div class="panel-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-black text-gradient">Readiness check</h2>
                                <p class="text-neutral-400 mt-2">A quick check-in before you begin</p>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot"></div>
                                <span>CALIBRATING</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-body">
                        <!-- Real-time Metrics -->
                        <div class="metric-grid mb-12">
                            <div class="metric-card">
                                <div class="metric-label">PAIN INDEX</div>
                                <div class="metric-value" id="realTimePain">0.0</div>
                                <div class="metric-change positive">+0.0</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">HEART RATE ZONE</div>
                                <div class="metric-value" id="heartRate">--</div>
                                <div class="metric-label">BPM</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">STABILITY SCORE</div>
                                <div class="metric-value" id="stabilityScore">100%</div>
                                <div class="flex justify-center mt-4">
                                    <div class="progress-ring" style="width: 80px; height: 80px;">
                                        <svg width="80" height="80">
                                            <circle class="progress-ring-circle progress-ring-bg" cx="40" cy="40" r="35"></circle>
                                            <circle class="progress-ring-circle progress-ring-fill" cx="40" cy="40" r="35"></circle>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">READINESS</div>
                                <div class="metric-value" id="bioReadiness">100%</div>
                                <div class="progress-bar mt-4">
                                    <div class="progress-bar-fill" id="readinessBar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pain Monitor -->
                        <div class="pain-monitor">
                            <h3 class="text-xl font-bold mb-6">Pain check</h3>
                            <div class="pain-scale" id="painScale">
                                <div class="pain-marker" id="painMarker" style="left: 0%;">0</div>
                                <div class="pain-threshold" id="painThreshold" style="left: 70%;"></div>
                            </div>
                            <div class="pain-labels">
                                <span>GREEN ZONE</span>
                                <span>YELLOW ZONE</span>
                                <span>RED ZONE</span>
                            </div>
                            
                            <div id="painWarning" class="pain-warning hidden">
                                <div class="flex items-center gap-4">
                                    <div class="status-dot" style="background: var(--accent-red); animation: blink 1s infinite;"></div>
                                    <div>
                                        <h4 class="font-bold text-red">Pain above your limit</h4>
                                        <p class="text-sm text-neutral-400 mt-1">Reduce intensity or pause protocol. Consult if pain persists.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mission Brief -->
                        <div class="card mt-12">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold">SESSION BRIEFING</h3>
                                <span class="badge">
                                    <i class="ri-shield-keyhole-line"></i> CLASSIFIED
                                </span>
                            </div>
                            <div class="space-y-4">
                                <p>Operator <span id="briefOperator" class="font-bold text-teal">MARVIN</span>, your plan is the Progressive Balance &amp; Leg Strength pathwayâ€”patient-first and predictable.</p>
                                <p class="font-medium">Primary Objective: Complete 10â€“15 minutes of this week's tasks with smooth control and calm breathing.</p>
                                <p class="font-medium">Secondary Objective: Progress by time and steadiness only; move to the next week when holds feel stable.</p>
                                <div class="mt-6 p-4 bg-neutral-800/50 border border-yellow/20 rounded-xl">
                                    <p class="text-sm"><span class="font-bold text-yellow"><i class="ri-alarm-warning-line"></i> SAFETY PLAN:</span> Stay near a wall or counter, move slowly, and pause if pain rises above 7/10, dizziness appears, or balance wobbles.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-footer">
                        <div class="flex justify-between">
                            <button class="btn btn-secondary" onclick="returnToAuth()">
                                <i class="ri-arrow-left-line"></i> BACK
                            </button>
                            <button class="btn btn-success btn-lg" onclick="beginMission()">
                                <i class="ri-rocket-line"></i> Begin session
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Phase 3: Active Mission -->
            <section id="phaseMission" class="section hidden">
                <div class="panel">
                    <div class="panel-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-black text-gradient" id="missionTitle">Active session</h2>
                                <p class="text-neutral-400 mt-2" id="missionSubtitle">Week 1 â€” Learning & Safety</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="status-indicator">
                                    <div class="status-dot" style="background: var(--accent-green);"></div>
                                    <span id="missionStatus">In progress</span>
                                </div>
                                <div class="font-mono text-2xl font-bold text-teal" id="missionTimer">15:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-body">
                        <!-- Phase Navigation -->
                        <div class="card mb-8">
                            <h3 class="text-xl font-bold mb-4">WEEK NAVIGATION</h3>
                            <div class="flex flex-wrap gap-3">
                                <button class="btn btn-secondary" onclick="selectPhase(1)">
                                    <i class="ri-number-1"></i> WEEK 1
                                </button>
                                <button class="btn btn-secondary" onclick="selectPhase(2)">
                                    <i class="ri-number-2"></i> WEEK 2
                                </button>
                                <button class="btn btn-secondary" onclick="selectPhase(3)">
                                    <i class="ri-number-3"></i> WEEK 3
                                </button>
                                <button class="btn btn-secondary" onclick="selectPhase(4)">
                                    <i class="ri-number-4"></i> WEEK 4 (OPTIONAL)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Exercise Container -->
                        <div id="exerciseContainer" class="mb-8">
                            <!-- Exercises loaded dynamically -->
                        </div>
                        
                        <!-- Live Metrics -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold">LIVE METRICS</h3>
                                <span class="badge">
                                    <i class="ri-pulse-line"></i> Real-time
                                </span>
                            </div>
                            <div class="grid grid-cols-4 gap-4">
                                <div class="text-center p-4 bg-neutral-800/50 rounded-xl">
                                    <div class="text-2xl font-bold text-teal font-mono" id="livePain">0.0</div>
                                    <div class="text-xs text-neutral-400 uppercase mt-1">CURRENT PAIN</div>
                                </div>
                                <div class="text-center p-4 bg-neutral-800/50 rounded-xl">
                                    <div class="text-2xl font-bold text-teal font-mono" id="completedExercises">0</div>
                                    <div class="text-xs text-neutral-400 uppercase mt-1">EXERCISES DONE</div>
                                </div>
                                <div class="text-center p-4 bg-neutral-800/50 rounded-xl">
                                    <div class="text-2xl font-bold text-teal font-mono" id="timeElapsed">00:00</div>
                                    <div class="text-xs text-neutral-400 uppercase mt-1">TIME ELAPSED</div>
                                </div>
                                <div class="text-center p-4 bg-neutral-800/50 rounded-xl">
                                    <div class="text-2xl font-bold text-teal font-mono" id="successRate">100%</div>
                                    <div class="text-xs text-neutral-400 uppercase mt-1">SUCCESS RATE</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Social Share Component -->
                        <div class="social-share hidden" id="socialShareSection">
                            <h3 class="text-xl font-bold mb-4">SHARE PROGRESS</h3>
                            <p class="text-neutral-400 mb-4">Share your achievements with your support network</p>
                            <div class="share-options">
                                <div class="share-option" onclick="shareProgress('text')">
                                    <i class="ri-message-2-line text-2xl text-blue"></i>
                                    <span class="text-sm">Text</span>
                                </div>
                                <div class="share-option" onclick="shareProgress('image')">
                                    <i class="ri-image-line text-2xl text-purple"></i>
                                    <span class="text-sm">Image</span>
                                </div>
                                <div class="share-option" onclick="shareProgress('data')">
                                    <i class="ri-bar-chart-line text-2xl text-teal"></i>
                                    <span class="text-sm">Chart</span>
                                </div>
                                <div class="share-option" onclick="shareProgress('therapist')">
                                    <i class="ri-user-heart-line text-2xl text-green"></i>
                                    <span class="text-sm">Therapist</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="form-label">SHARE MESSAGE</label>
                                <textarea class="form-control" id="shareMessage" rows="2">Just completed my rehabilitation session! Progress is steady and feeling stronger every day. ðŸ’ª</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-footer">
                        <div class="flex justify-center gap-4">
                            <button class="btn btn-danger" onclick="emergencyStop()">
                                <i class="ri-alarm-line"></i> Pause for safety
                            </button>
                            <button class="btn btn-secondary" onclick="toggleSocialShare()">
                                <i class="ri-share-line"></i> SHARE
                            </button>
                            <button class="btn btn-secondary" onclick="pauseMission()" id="pauseBtn">
                                <i class="ri-pause-line"></i> PAUSE
                            </button>
                            <button class="btn btn-success" onclick="completeMission()">
                                <i class="ri-check-double-line"></i> COMPLETE
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Phase 4: Debrief -->
            <section id="phaseDebrief" class="section hidden">
                <div class="panel">
                    <div class="panel-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-black text-gradient">Session summary</h2>
                                <p class="text-neutral-400 mt-2">Notes and session record</p>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot" style="background: var(--accent-green);"></div>
                                <span>SESSION SUCCESS</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-body">
                        <!-- Performance Summary -->
                        <div class="metric-grid mb-12">
                            <div class="metric-card">
                                <div class="metric-label">TOTAL TIME</div>
                                <div class="metric-value" id="debriefTime">00:00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">EXERCISES COMPLETED</div>
                                <div class="metric-value" id="debriefExercises">0</div>
                                <div class="metric-label">/ 12 TOTAL</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">AVG PAIN INDEX</div>
                                <div class="metric-value" id="debriefPain">0.0</div>
                                <div class="metric-change positive">-0.0</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">SUCCESS RATE</div>
                                <div class="metric-value" id="debriefSuccess">100%</div>
                                <div class="flex justify-center mt-4">
                                    <div class="progress-ring" style="width: 80px; height: 80px;">
                                        <svg width="80" height="80">
                                            <circle class="progress-ring-circle progress-ring-bg" cx="40" cy="40" r="35"></circle>
                                            <circle class="progress-ring-circle progress-ring-fill" cx="40" cy="40" r="35"></circle>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Session Notes -->
                        <div class="form-group mb-8">
                            <label class="form-label">Notes (optional)</label>
                            <textarea class="form-control" id="postMissionNotes" rows="4" 
                                      placeholder="Record observations, challenges, victories..."></textarea>
                        </div>
                        
                        <!-- Pain History -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold">PAIN HISTORY</h3>
                                <span class="badge">
                                    <i class="ri-line-chart-line"></i> ANALYSIS
                                </span>
                            </div>
                            <div id="painHistoryChart">
                                <div class="text-center py-12">
                                    <div class="inline-block w-16 h-16 border-4 border-teal border-t-transparent rounded-full animate-spin"></div>
                                    <div class="text-neutral-400 mt-4">GENERATING PERFORMANCE ANALYSIS</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ML Insights -->
                        <div class="ml-recommendation mt-8">
                            <div class="ml-content">
                                <div class="ml-badge">
                                    <i class="ri-brain-line"></i>
                                    AI INSIGHTS
                                </div>
                                <h3 class="text-xl font-bold mb-2">Performance Analysis</h3>
                                <p class="text-sm mb-4" id="mlInsightsText">Based on today's session, AI recommends focusing on balance exercises in your next session. Pain levels decreased by 15% compared to last session.</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center p-3 bg-white/10 rounded-lg">
                                        <div class="text-lg font-bold">+8%</div>
                                        <div class="text-xs">Stability Improvement</div>
                                    </div>
                                    <div class="text-center p-3 bg-white/10 rounded-lg">
                                        <div class="text-lg font-bold">-15%</div>
                                        <div class="text-xs">Pain Reduction</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-footer">
                        <div class="flex justify-center gap-4">
                            <button class="btn btn-secondary" onclick="saveSession()">
                                <i class="ri-save-line"></i> Save
                            </button>
                            <button class="btn btn-primary" onclick="exportData()">
                                <i class="ri-download-line"></i> Export
                            </button>
                            <button class="btn btn-success" onclick="startNewSession()">
                                <i class="ri-refresh-line"></i> New session
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Action Dock -->
            <div class="action-dock" aria-label="Session quick controls">
                <div class="action-dock-shell">
                    <div class="dock-status">
                        <h3>Live status</h3>
                        <div class="dock-value" id="dockStatusLabel">Prep</div>
                        <p class="dock-hint" id="dockStatusHint">Authenticate to unlock your plan.</p>
                    </div>
                    <div class="dock-actions">
                        <button class="btn btn-primary" id="dockPrimaryAction" onclick="handleDockPrimaryAction()">
                            <i class="ri-play-line"></i> Start session
                        </button>
                        <button class="btn btn-secondary" onclick="scrollToSection('phaseMission')">
                            <i class="ri-run-line"></i> Jump to exercises
                        </button>
                        <button class="btn btn-danger" onclick="emergencyStop()">
                            <i class="ri-alarm-line"></i> Emergency stop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Profile Editor Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">PATIENT PROFILE EDITOR</div>
                <button class="modal-close" onclick="hideProfileEditor()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Your name</label>
                            <input type="text" class="form-control" id="profileName" value="MARVIN">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">PRIMARY INJURY/DEFICIT</label>
                            <select class="form-control form-select" id="profileInjury">
                                <option value="BALANCE">Balance Deficit</option>
                                <option value="STRENGTH">Leg Strength Deficit</option>
                                <option value="MOBILITY">Mobility Restriction</option>
                                <option value="NEURO">Neuromuscular Deficit</option>
                                <option value="POST_SURGERY">Post-Surgical Recovery</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">PLAN INTENSITY</label>
                            <select class="form-control form-select" id="profileIntensity">
                                <option value="HARDCORE">Hardcore: No Quarter</option>
                                <option value="INTENSE">Intense: Maximum Effort</option>
                                <option value="STANDARD">Standard: Progressive Overload</option>
                                <option value="RECOVERY">Recovery: Active Rehab</option>
                                <option value="AI_ADAPTIVE">AI Adaptive: Smart Progress</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label class="form-label">SUPPORT LEVEL</label>
                            <select class="form-control form-select" id="profileSupport">
                                <option value="NONE">None: Unassisted</option>
                                <option value="MINIMAL">Minimal: Light Support</option>
                                <option value="MODERATE">Moderate: Substantial Support</option>
                                <option value="MAX">Maximum: Full Support</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">TARGET SESSIONS PER WEEK</label>
                            <input type="number" class="form-control" id="profileSessions" min="1" max="7" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">PAIN THRESHOLD (1-10)</label>
                            <input type="range" class="form-range" id="profilePainThreshold" min="1" max="10" value="7">
                            <div class="flex justify-between mt-3">
                                <span class="text-sm text-neutral-400">LOW</span>
                                <span class="text-sm font-bold text-teal" id="thresholdValueDisplay">7</span>
                                <span class="text-sm text-neutral-400">HIGH</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-6">
                    <label class="form-label">PERSONAL MOTIVATION</label>
                    <textarea class="form-control" id="profileMotivation" rows="3">I WILL RECLAIM MY MOBILITY. I WILL NOT BE DEFEATED. EVERY REP BUILDS MY FUTURE.</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">BIOMETRIC PREFERENCES</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="biometricFace" checked>
                            <span>Face Recognition</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="biometricVoice" checked>
                            <span>Voice Recognition</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="biometricMotion">
                            <span>Movement Pattern</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">PRIVACY SETTINGS</label>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span>Share progress with therapist</span>
                            <input type="checkbox" id="privacyTherapist" checked>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Allow AI recommendations</span>
                            <input type="checkbox" id="privacyAI" checked>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Anonymous data for research</span>
                            <input type="checkbox" id="privacyResearch">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideProfileEditor()">
                    <i class="ri-close-line"></i> CANCEL
                </button>
                <button class="btn btn-primary" onclick="saveProfile()">
                    <i class="ri-save-line"></i> SAVE PROFILE
                </button>
            </div>
        </div>
    </div>
    
    <!-- Timer Modal -->
    <div class="modal-overlay" id="timerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="timerTitle">EXERCISE TIMER</div>
                <button class="modal-close" onclick="hideTimer()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="timer-display text-6xl" id="exerciseTimer">00:00</div>
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold mb-2" id="exerciseName">Single-Leg Stand</h3>
                    <p class="text-neutral-400" id="exerciseDescription">Focus on stability. Breathe steadily.</p>
                </div>
                
                <div class="pain-scale" id="exercisePainScale">
                    <div class="pain-marker" id="exercisePainMarker" style="left: 0%;">0</div>
                </div>
                <div class="pain-labels">
                    <span>COMFORTABLE</span>
                    <span>CHALLENGING</span>
                    <span>PAINFUL</span>
                </div>
            </div>
            <div class="modal-footer">
                <div class="flex gap-4">
                    <button class="btn btn-secondary" id="timerPauseBtn" onclick="pauseExerciseTimer()">
                        <i class="ri-pause-line"></i> PAUSE
                    </button>
                    <button class="btn btn-danger" onclick="stopExerciseTimer()">
                        <i class="ri-stop-line"></i> STOP
                    </button>
                    <button class="btn btn-success" onclick="completeExerciseTimer()">
                        <i class="ri-check-line"></i> COMPLETE
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Protocol Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="ri-alarm-warning-line"></i> EMERGENCY PLAN ACTIVATED
                </div>
            </div>
            <div class="modal-body">
                <div class="text-center py-8">
                    <div class="text-6xl text-red mb-6">
                        <i class="ri-alarm-line"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-red mb-4">PLAN SUSPENDED</h2>
                    <p class="text-neutral-400 mb-8">All exercises have been stopped. Follow these steps:</p>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="card">
                            <div class="text-4xl text-center mb-4">1ï¸âƒ£</div>
                            <p class="font-bold text-center">SIT OR LIE DOWN IMMEDIATELY</p>
                        </div>
                        <div class="card">
                            <div class="text-4xl text-center mb-4">2ï¸âƒ£</div>
                            <p class="font-bold text-center">ASSESS PAIN & DIZZINESS</p>
                        </div>
                        <div class="card">
                            <div class="text-4xl text-center mb-4">3ï¸âƒ£</div>
                            <p class="font-bold text-center">DRINK WATER & REST</p>
                        </div>
                        <div class="card">
                            <div class="text-4xl text-center mb-4">4ï¸âƒ£</div>
                            <p class="font-bold text-center">CONTACT CLINICIAN IF NEEDED</p>
                        </div>
                    </div>
                    
                    <div class="p-6 bg-red/10 border border-red/20 rounded-2xl">
                        <p class="text-center">
                            <span class="font-bold text-yellow">
                                <i class="ri-phone-line"></i> EMERGENCY CONTACT:
                            </span> 
                            Call 911 if experiencing chest pain, severe dizziness, or loss of consciousness.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="resumeFromEmergency()">
                    <i class="ri-play-line"></i> RESUME WHEN READY
                </button>
                <button class="btn btn-danger" onclick="abortMission()">
                    <i class="ri-stop-circle-line"></i> END SESSION
                </button>
            </div>
        </div>
    </div>
    
    <!-- Biometric Authentication Modal -->
    <div class="biometric-modal" id="biometricModal">
        <div class="container">
            <div class="card max-w-md mx-auto">
                <div class="panel-header">
                    <h3 class="text-2xl font-bold text-center">BIOMETRIC VERIFICATION</h3>
                </div>
                <div class="panel-body">
                    <div class="biometric-scanner">
                        <div class="scan-line"></div>
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <div class="text-6xl text-teal mb-6">
                                    <i class="ri-fingerprint-line"></i>
                                </div>
                                <p class="text-neutral-400">Scanning biometric patterns...</p>
                                <div class="mt-8">
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" id="biometricProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-sm text-neutral-400">Please position your face in the frame and speak your name clearly</p>
                        <div class="mt-4 flex justify-center gap-4">
                            <button class="btn btn-secondary" onclick="hideBiometricAuth()">
                                <i class="ri-close-line"></i> Cancel
                            </button>
                            <button class="btn btn-primary" onclick="simulateBiometricAuth()">
                                <i class="ri-check-line"></i> Verify
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Social Share Modal -->
    <div class="modal-overlay" id="socialShareModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">SHARE YOUR PROGRESS</div>
                <button class="modal-close" onclick="hideSocialShare()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-6">
                    <div class="text-6xl text-teal mb-4">
                        <i class="ri-share-line"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Share Your Achievement!</h3>
                    <p class="text-neutral-400">Celebrate your progress and inspire others</p>
                </div>
                
                <div class="share-options">
                    <div class="share-option" onclick="shareToPlatform('sms')">
                        <i class="ri-message-2-line text-3xl text-blue"></i>
                        <span class="text-sm">Text</span>
                    </div>
                    <div class="share-option" onclick="shareToPlatform('email')">
                        <i class="ri-mail-line text-3xl text-red"></i>
                        <span class="text-sm">Email</span>
                    </div>
                    <div class="share-option" onclick="shareToPlatform('therapist')">
                        <i class="ri-user-heart-line text-3xl text-green"></i>
                        <span class="text-sm">Therapist</span>
                    </div>
                    <div class="share-option" onclick="generateProgressImage()">
                        <i class="ri-image-line text-3xl text-purple"></i>
                        <span class="text-sm">Image</span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="form-label">CUSTOM MESSAGE</label>
                    <textarea class="form-control" id="socialShareMessage" rows="3">Just completed my rehabilitation session! Feeling stronger and making progress every day. ðŸ’ª #RehabRising #RecoveryJourney</textarea>
                </div>
                
                <div class="mt-6">
                    <label class="form-label">SHARE WITH</label>
                    <div class="flex flex-wrap gap-3 mt-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="shareFamily" checked>
                            <span>Family</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="shareFriends" checked>
                            <span>Friends</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="shareTherapist" checked>
                            <span>Therapist</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="shareSupportGroup">
                            <span>Support Group</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideSocialShare()">
                    <i class="ri-close-line"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="confirmShare()">
                    <i class="ri-send-plane-line"></i> Share Now
                </button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        // COMPLETE APPLICATION STATE WITH NEW FEATURES
        // =========================================================
        const AppState = {
            version: '4.0',
            operator: {
                id: 'MARVIN',
                clearance: 'Rehab_RISING',
                biometrics: {
                    faceRegistered: true,
                    voiceRegistered: true,
                    motionRegistered: false
                },
                profile: {
                    name: 'MARVIN',
                    injury: 'BALANCE',
                    intensity: 'HARDCORE',
                    support: 'MINIMAL',
                    sessionsPerWeek: 5,
                    painThreshold: 7,
                    motivation: 'I WILL RECLAIM MY MOBILITY. I WILL NOT BE DEFEATED.',
                    customExercises: [],
                    privacy: {
                        shareTherapist: true,
                        allowAI: true,
                        anonymousResearch: false
                    }
                }
            },
            session: {
                active: false,
                phase: 1,
                startTime: null,
                elapsedTime: 0,
                totalTime: 15 * 60,
                paused: false,
                authenticated: false,
                completedExercises: [],
                currentExercise: null,
                painHistory: [],
                notes: '',
                metrics: {
                    painIndex: 0,
                    fatigue: 0,
                    readiness: 100,
                    stability: 100,
                    startPain: 0,
                    avgPain: 0,
                    maxPain: 0
                },
                mlInsights: {
                    recommendation: 'Focus on balance exercises',
                    confidence: 85,
                    improvements: {
                        stability: 8,
                        painReduction: 15,
                        endurance: 12
                    }
                }
            },
            progress: {
                totalSessions: 0,
                streak: 0,
                longestStreak: 0,
                lastSession: null,
                phasesCompleted: [],
                bestTimes: {},
                achievements: []
            },
            emergency: {
                triggered: false,
                lastStop: null,
                stopCount: 0
            },
            voiceControl: {
                active: false,
                recognition: null,
                commands: [],
                lastTranscript: ''
            },
            videoCall: {
                active: false,
                muted: false,
                cameraOff: false,
                therapistConnected: false
            },
            social: {
                lastShare: null,
                shareCount: 0,
                connections: ['Family', 'Friends', 'Therapist']
            }
        };

        // Timer management
        const Timers = {
            mission: null,
            missionRemaining: 0,
            exercise: null,
            exerciseTimeLeft: 0,
            exerciseRunning: false,
            exerciseStartTime: null,
            biometric: null,
            metrics: null,
            clock: null
        };

        // Exercise protocols with AI adaptations
        const EXERCISE_PLANS = {
            1: {
                title: 'Week 1 â€” Learning & Safety',
                description: 'Learn each movement with light support and short holds.',
                duration: 600,
                exercises: [
                    {
                        id: 'w1-single-leg',
                        name: 'Single-Leg Stand',
                        description: 'Stand on one leg with a wall or counter nearby. Keep the lifted foot just off the floor.',
                        duration: 10,
                        sets: 4,
                        difficulty: 'BASIC',
                        requirements: ['WALL OR COUNTER', 'CALM BREATHING'],
                        progressMetrics: ['TIME', 'CONTROL'],
                        prescription: '2Ã— each leg Â· hold 5â€“10s',
                        mlAdaptive: false
                    },
                    {
                        id: 'w1-tandem',
                        name: 'Feet in a Line (Tandem Stand)',
                        description: 'Place one foot directly in front of the other and hold. Switch the lead foot after each hold.',
                        duration: 10,
                        sets: 2,
                        difficulty: 'BASIC',
                        requirements: ['NEAR SUPPORT'],
                        progressMetrics: ['TIME', 'STEADINESS'],
                        prescription: '10s holds Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w1-side',
                        name: 'Side Stepping',
                        description: 'Step sideways with smooth control and minimal sway.',
                        duration: 60,
                        sets: 2,
                        reps: 10,
                        difficulty: 'BASIC',
                        requirements: ['CLEAR PATH'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '5 steps each way Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w1-back',
                        name: 'Backward Walking',
                        description: 'Take slow, deliberate steps backward while staying close to support.',
                        duration: 60,
                        sets: 2,
                        reps: 5,
                        difficulty: 'BASIC',
                        requirements: ['WALL GUIDANCE', 'SAFE AREA'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '5 slow steps Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w1-calf',
                        name: 'Calf Raises',
                        description: 'Rise onto toes and lower with control while holding the counter.',
                        duration: 90,
                        sets: 1,
                        reps: 10,
                        difficulty: 'BASIC',
                        requirements: ['COUNTER SUPPORT'],
                        progressMetrics: ['REPS', 'HEIGHT'],
                        prescription: '10 each leg with light support',
                        mlAdaptive: false
                    },
                    {
                        id: 'w1-march',
                        name: 'Marching Knees',
                        description: 'Lift one knee at a time at a comfortable height.',
                        duration: 60,
                        sets: 1,
                        reps: 10,
                        difficulty: 'BASIC',
                        requirements: ['STABLE SURFACE'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '10 total steps',
                        mlAdaptive: false
                    },
                    {
                        id: 'w1-squat',
                        name: 'Mini Squats',
                        description: 'Small knee bend with hips back and chest tall.',
                        duration: 60,
                        sets: 1,
                        reps: 10,
                        difficulty: 'BASIC',
                        requirements: ['CHAIR NEARBY'],
                        progressMetrics: ['REPS', 'DEPTH'],
                        prescription: '8â€“10 repetitions',
                        mlAdaptive: false
                    }
                ]
            },
            2: {
                title: 'Week 2 â€” Longer Holds',
                description: 'Stay steady for longer while relying less on support.',
                duration: 720,
                exercises: [
                    {
                        id: 'w2-single-leg',
                        name: 'Single-Leg Stand',
                        description: 'Hold balance without touching the wall unless needed.',
                        duration: 15,
                        sets: 4,
                        difficulty: 'BASIC',
                        requirements: ['SAFE SPACE'],
                        progressMetrics: ['TIME', 'CONTROL'],
                        prescription: '2Ã— each leg Â· hold 15s',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-tandem',
                        name: 'Tandem Stand',
                        description: 'Heel-to-toe stand with steady breathing, switching the lead foot.',
                        duration: 15,
                        sets: 2,
                        difficulty: 'BASIC',
                        requirements: ['CALM BREATHING'],
                        progressMetrics: ['TIME', 'STEADINESS'],
                        prescription: '15s holds Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-side',
                        name: 'Side Stepping',
                        description: 'Smooth lateral steps with hips level.',
                        duration: 70,
                        sets: 2,
                        reps: 16,
                        difficulty: 'BASIC',
                        requirements: ['CLEAR PATH'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '8 steps each way Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-back',
                        name: 'Backward Walking',
                        description: 'Controlled backward steps, eyes forward, light contact available.',
                        duration: 80,
                        sets: 2,
                        reps: 8,
                        difficulty: 'BASIC',
                        requirements: ['WALL GUIDANCE'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '8 slow steps Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-calf',
                        name: 'Calf Raises',
                        description: 'Rise and lower slowly, equal work on each leg.',
                        duration: 100,
                        sets: 1,
                        reps: 15,
                        difficulty: 'BASIC',
                        requirements: ['COUNTER SUPPORT'],
                        progressMetrics: ['REPS', 'HEIGHT'],
                        prescription: '15 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-side-kick',
                        name: 'Side Kicks',
                        description: 'Kick leg slightly back and to the side without leaning.',
                        duration: 90,
                        sets: 1,
                        reps: 10,
                        difficulty: 'BASIC',
                        requirements: ['LIGHT SUPPORT'],
                        progressMetrics: ['REPS', 'CONTROL'],
                        prescription: '10 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-march',
                        name: 'Marching Knees',
                        description: 'Calm marching pace with even height.',
                        duration: 80,
                        sets: 1,
                        reps: 15,
                        difficulty: 'BASIC',
                        requirements: ['STABLE SURFACE'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '15 total steps',
                        mlAdaptive: false
                    },
                    {
                        id: 'w2-squat',
                        name: 'Mini Squats',
                        description: 'Maintain knee tracking and comfortable depth.',
                        duration: 90,
                        sets: 1,
                        reps: 12,
                        difficulty: 'BASIC',
                        requirements: ['CHAIR NEARBY'],
                        progressMetrics: ['REPS', 'DEPTH'],
                        prescription: '10â€“12 repetitions',
                        mlAdaptive: false
                    }
                ]
            },
            3: {
                title: 'Week 3 â€” Better Control',
                description: 'Balance without rushing and reset if shaky.',
                duration: 840,
                exercises: [
                    {
                        id: 'w3-single-leg',
                        name: 'Single-Leg Stand',
                        description: 'Extended holds with calm posture.',
                        duration: 20,
                        sets: 4,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['SAFE SPACE'],
                        progressMetrics: ['TIME', 'CONTROL'],
                        prescription: '2Ã— each leg Â· hold 20s',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-heel',
                        name: 'Heel-to-Toe Walk',
                        description: 'Heel directly in front of toe for each step.',
                        duration: 120,
                        sets: 2,
                        reps: 8,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['NEAR SUPPORT'],
                        progressMetrics: ['STEPS', 'ACCURACY'],
                        prescription: '6â€“8 steps Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-side',
                        name: 'Side Stepping',
                        description: 'Longer lateral sets with steady hips.',
                        duration: 90,
                        sets: 2,
                        reps: 10,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['CLEAR PATH'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '10 steps each way',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-back',
                        name: 'Backward Walking',
                        description: 'Slow backward steps with a pause between each.',
                        duration: 90,
                        sets: 2,
                        reps: 10,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['WALL GUIDANCE'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '10 slow steps',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-calf',
                        name: 'Calf Raises',
                        description: 'Smoother tempo and full height on each raise.',
                        duration: 110,
                        sets: 1,
                        reps: 20,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['COUNTER SUPPORT'],
                        progressMetrics: ['REPS', 'HEIGHT'],
                        prescription: '20 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-back-kick',
                        name: 'Back Kicks',
                        description: 'Straight leg backward without trunk lean.',
                        duration: 100,
                        sets: 1,
                        reps: 10,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['LIGHT SUPPORT'],
                        progressMetrics: ['REPS', 'CONTROL'],
                        prescription: '10 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-march',
                        name: 'Marching Knees',
                        description: 'March in place with steady tempo.',
                        duration: 100,
                        sets: 1,
                        reps: 20,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['STABLE SURFACE'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '20 total steps',
                        mlAdaptive: false
                    },
                    {
                        id: 'w3-squat',
                        name: 'Mini Squats',
                        description: 'Comfortable depth, no rushing between reps.',
                        duration: 110,
                        sets: 1,
                        reps: 15,
                        difficulty: 'INTERMEDIATE',
                        requirements: ['CHAIR NEARBY'],
                        progressMetrics: ['REPS', 'DEPTH'],
                        prescription: '12â€“15 repetitions',
                        mlAdaptive: false
                    }
                ]
            },
            4: {
                title: 'Week 4 â€” Stability (Optional)',
                description: 'Maintain balance with small, slow challenges only if earlier weeks feel safe.',
                duration: 900,
                exercises: [
                    {
                        id: 'w4-single-leg',
                        name: 'Single-Leg Stand with Arm Movement',
                        description: 'Hold balance while slowly moving arms for gentle challenge.',
                        duration: 20,
                        sets: 2,
                        difficulty: 'CONTROLLED',
                        requirements: ['SAFE SPACE', 'ARM ROOM'],
                        progressMetrics: ['TIME', 'COORDINATION'],
                        prescription: '20s holds with arm sweeps',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-heel',
                        name: 'Heel-to-Toe Walk',
                        description: 'Measured heel-to-toe steps with calm pacing.',
                        duration: 140,
                        sets: 2,
                        reps: 10,
                        difficulty: 'CONTROLLED',
                        requirements: ['NEAR SUPPORT'],
                        progressMetrics: ['STEPS', 'ACCURACY'],
                        prescription: '10 steps Â· 2 rounds',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-side',
                        name: 'Side Stepping',
                        description: 'Longer lateral sets while staying tall.',
                        duration: 120,
                        sets: 2,
                        reps: 12,
                        difficulty: 'CONTROLLED',
                        requirements: ['CLEAR PATH'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '10â€“12 steps each way',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-back',
                        name: 'Backward Walking',
                        description: 'Steady backward steps with full foot contact.',
                        duration: 120,
                        sets: 2,
                        reps: 12,
                        difficulty: 'CONTROLLED',
                        requirements: ['WALL GUIDANCE'],
                        progressMetrics: ['STEPS', 'CONTROL'],
                        prescription: '10â€“12 steps',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-calf',
                        name: 'Calf Raises',
                        description: 'Even tempo calf work with full height.',
                        duration: 120,
                        sets: 1,
                        reps: 20,
                        difficulty: 'CONTROLLED',
                        requirements: ['COUNTER SUPPORT'],
                        progressMetrics: ['REPS', 'HEIGHT'],
                        prescription: '20 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-side-kick',
                        name: 'Side Kicks',
                        description: 'Gentle side kicks with upright posture.',
                        duration: 110,
                        sets: 1,
                        reps: 12,
                        difficulty: 'CONTROLLED',
                        requirements: ['LIGHT SUPPORT'],
                        progressMetrics: ['REPS', 'CONTROL'],
                        prescription: '12 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-butt-kick',
                        name: 'Butt Kicks',
                        description: 'Heel toward glutes without impact.',
                        duration: 110,
                        sets: 1,
                        reps: 12,
                        difficulty: 'CONTROLLED',
                        requirements: ['STABLE SURFACE'],
                        progressMetrics: ['REPS', 'CONTROL'],
                        prescription: '10â€“12 each leg',
                        mlAdaptive: false
                    },
                    {
                        id: 'w4-squat',
                        name: 'Mini Squats',
                        description: 'Smooth squats with steady breathing.',
                        duration: 130,
                        sets: 1,
                        reps: 18,
                        difficulty: 'CONTROLLED',
                        requirements: ['CHAIR NEARBY'],
                        progressMetrics: ['REPS', 'DEPTH'],
                        prescription: '15â€“20 repetitions',
                        mlAdaptive: false
                    }
                ]
            }
        };

        // Voice commands mapping
        const VOICE_COMMANDS = {
            'start exercise': () => {
                if (AppState.session.currentExercise) {
                    startExerciseTimer(AppState.session.currentExercise.id);
                } else {
                    const firstExercise = EXERCISE_PLANS[AppState.session.phase]?.exercises[0];
                    if (firstExercise) startExerciseTimer(firstExercise.id);
                }
            },
            'stop timer': () => {
                if (Timers.exerciseRunning) {
                    pauseExerciseTimer();
                    showNotification('Voice Command', 'Timer paused', 'info');
                }
            },
            'pause exercise': () => pauseExerciseTimer(),
            'next exercise': () => {
                const exercises = EXERCISE_PLANS[AppState.session.phase]?.exercises || [];
                const currentIndex = exercises.findIndex(e => e.id === AppState.session.currentExercise?.id);
                if (currentIndex < exercises.length - 1) {
                    const nextExercise = exercises[currentIndex + 1];
                    startExerciseTimer(nextExercise.id);
                }
            },
            'complete exercise': () => {
                if (AppState.session.currentExercise) {
                    completeExercise(AppState.session.currentExercise.id);
                }
            },
            'emergency stop': () => emergencyStop(),
            'show pain': () => {
                showNotification('Current Pain', `Pain level: ${AppState.session.metrics.painIndex.toFixed(1)}/10`, 'info');
            },
            'begin session': () => {
                if (!AppState.session.active) beginMission();
            },
            'end session': () => completeMission(),
            'call therapist': () => startVideoCall(),
            'share progress': () => showSocialShare()
        };

        // =========================================================
        // NEW FEATURE: VOICE CONTROL
        // =========================================================
        function toggleVoiceControl() {
            const voiceBtn = document.getElementById('voiceControlBtn');
            const transcriptEl = document.getElementById('voiceTranscript');
            
            if (!AppState.voiceControl.active) {
                startVoiceRecognition();
                voiceBtn.classList.add('voice-active');
                transcriptEl.classList.remove('hidden');
                showNotification('Voice Control', 'Listening for commands...', 'info');
            } else {
                stopVoiceRecognition();
                voiceBtn.classList.remove('voice-active');
                transcriptEl.classList.add('hidden');
                showNotification('Voice Control', 'Voice control stopped', 'warning');
            }
        }

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('Voice Control Unavailable', 'Your browser does not support speech recognition', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            AppState.voiceControl.recognition = new SpeechRecognition();
            
            AppState.voiceControl.recognition.continuous = true;
            AppState.voiceControl.recognition.interimResults = true;
            AppState.voiceControl.recognition.lang = 'en-US';
            
            AppState.voiceControl.recognition.onstart = () => {
                AppState.voiceControl.active = true;
                updateSystemStatus();
            };
            
            AppState.voiceControl.recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                const transcriptEl = document.getElementById('voiceTranscript');
                
                if (transcript !== AppState.voiceControl.lastTranscript) {
                    AppState.voiceControl.lastTranscript = transcript;
                    transcriptEl.textContent = `"${transcript}"`;
                    
                    // Check for commands
                    Object.keys(VOICE_COMMANDS).forEach(command => {
                        if (transcript.includes(command)) {
                            transcriptEl.innerHTML += ` <span class="text-teal">âœ“</span>`;
                            VOICE_COMMANDS[command]();
                            AppState.voiceControl.commands.push({
                                command: command,
                                timestamp: new Date(),
                                transcript: transcript
                            });
                        }
                    });
                }
            };
            
            AppState.voiceControl.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    showNotification('Microphone Access Denied', 'Please allow microphone access for voice control', 'error');
                }
            };
            
            AppState.voiceControl.recognition.onend = () => {
                AppState.voiceControl.active = false;
                updateSystemStatus();
            };
            
            AppState.voiceControl.recognition.start();
        }

        function stopVoiceRecognition() {
            if (AppState.voiceControl.recognition) {
                AppState.voiceControl.recognition.stop();
                AppState.voiceControl.active = false;
            }
        }

        // =========================================================
        // NEW FEATURE: BIOMETRIC AUTHENTICATION
        // =========================================================
        function showBiometricAuth() {
            document.getElementById('biometricModal').classList.add('active');
            startBiometricScan();
        }

        function hideBiometricAuth() {
            document.getElementById('biometricModal').classList.remove('active');
            stopBiometricScan();
        }

        function startBiometricScan(resume = false) {
            let progress = 0;
            const progressBar = document.getElementById('biometricProgress');
            if (!progressBar) return;

            clearTimer('biometric');

            if (resume) {
                const stored = parseFloat(progressBar.dataset.progress || '0');
                progress = isNaN(stored) ? 0 : stored;
                progressBar.style.width = `${progress}%`;
            } else {
                progressBar.dataset.progress = '0';
                progressBar.style.width = '0%';
            }
            
            Timers.biometric = setInterval(() => {
                progress = Math.min(100, progress + 5);
                progressBar.style.width = `${progress}%`;
                progressBar.dataset.progress = progress;
                
                if (progress >= 100) {
                    clearTimer('biometric');
                    simulateBiometricAuth();
                }
            }, 200);
        }

        function stopBiometricScan() {
            clearTimer('biometric');
            const progressBar = document.getElementById('biometricProgress');
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.dataset.progress = '0';
            }
        }

        function simulateBiometricAuth() {
            clearTimer('biometric');
            const progressBar = document.getElementById('biometricProgress');
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.dataset.progress = '100';
            }
            
            setTimeout(() => {
                // Simulate successful authentication
                hideBiometricAuth();
                showNotification('Biometric Verified', 'Welcome back, ' + AppState.operator.id, 'success');
                
                // Auto-fill authentication
                document.getElementById('operatorId').value = AppState.operator.id;
                document.getElementById('securityCode').value = AppState.operator.clearance;
                
                // Vibrate for feedback
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }, 1000);
        }

        // =========================================================
        // NEW FEATURE: VIDEO CALL / TELEHEALTH
        // =========================================================
        function toggleVideoCall() {
            const videoContainer = document.getElementById('videoCallContainer');
            
            if (!AppState.videoCall.active) {
                startVideoCall();
                videoContainer.classList.remove('hidden');
                showNotification('Video Call', 'Connecting to therapist...', 'info');
            } else {
                endVideoCall();
                videoContainer.classList.add('hidden');
                showNotification('Video Call', 'Call ended', 'warning');
            }
        }

        function startVideoCall() {
            AppState.videoCall.active = true;
            AppState.videoCall.therapistConnected = false;
            
            // Simulate therapist connection
            setTimeout(() => {
                AppState.videoCall.therapistConnected = true;
                document.getElementById('videoRemote').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="text-4xl text-green mb-3">
                                <i class="ri-user-heart-line"></i>
                            </div>
                            <p class="text-sm">Therapist Connected</p>
                            <p class="text-xs text-neutral-400">Dr. Sarah Johnson</p>
                        </div>
                    </div>
                `;
                showNotification('Therapist Connected', 'Dr. Sarah Johnson is now available', 'success');
            }, 3000);
        }

        function endVideoCall() {
            AppState.videoCall.active = false;
            AppState.videoCall.therapistConnected = false;
            document.getElementById('videoRemote').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="text-4xl text-blue mb-3">
                            <i class="ri-video-line"></i>
                        </div>
                        <p class="text-sm">Therapist connecting...</p>
                    </div>
                </div>
            `;
        }

        function toggleVideoMute() {
            AppState.videoCall.muted = !AppState.videoCall.muted;
            const icon = document.getElementById('videoMuteIcon');
            icon.className = AppState.videoCall.muted ? 'ri-mic-off-line' : 'ri-mic-line';
            showNotification('Microphone', AppState.videoCall.muted ? 'Muted' : 'Unmuted', 'info');
        }

        function toggleVideoCamera() {
            AppState.videoCall.cameraOff = !AppState.videoCall.cameraOff;
            const icon = document.getElementById('videoCameraIcon');
            icon.className = AppState.videoCall.cameraOff ? 'ri-camera-off-line' : 'ri-camera-line';
            showNotification('Camera', AppState.videoCall.cameraOff ? 'Turned off' : 'Turned on', 'info');
        }

        // =========================================================
        // NEW FEATURE: ML RECOMMENDATIONS
        // =========================================================
        function updateMLRecommendations() {
            const painLevel = AppState.session.metrics.painIndex;
            const fatigue = AppState.session.metrics.fatigue;
            const completedExercises = AppState.session.completedExercises.length;
            
            let recommendation = '';
            let confidence = 0;
            
            if (painLevel > 7) {
                recommendation = 'Consider reducing intensity. Focus on gentle mobility exercises.';
                confidence = 90;
            } else if (fatigue > 70) {
                recommendation = 'High fatigue detected. Recommend shorter sets with longer rest periods.';
                confidence = 85;
            } else if (completedExercises < 3) {
                recommendation = 'Focus on foundational exercises to build stability.';
                confidence = 75;
            } else {
                recommendation = 'Progressing well. Consider advancing to the next week\'s tasks.';
                confidence = 80;
            }
            
            AppState.session.mlInsights.recommendation = recommendation;
            AppState.session.mlInsights.confidence = confidence;
            
            // Update UI
            document.getElementById('mlRecommendationTitle').textContent = 'AI Recommendation';
            document.getElementById('mlRecommendationText').textContent = recommendation;
            document.getElementById('mlInsightsText').textContent = recommendation;
            
            // Generate insights for debrief
            if (AppState.session.metrics.startPain > 0) {
                const painReduction = ((AppState.session.metrics.startPain - painLevel) / AppState.session.metrics.startPain * 100).toFixed(0);
                AppState.session.mlInsights.improvements.painReduction = Math.abs(painReduction);
                document.getElementById('mlInsightsText').textContent = 
                    `Based on today's session, AI recommends ${recommendation.toLowerCase()} Pain levels ${painReduction >= 0 ? 'decreased' : 'increased'} by ${Math.abs(painReduction)}% compared to session start.`;
            }
        }

        function applyMLRecommendation() {
            const recommendation = AppState.session.mlInsights.recommendation;
            
            if (recommendation.includes('reduce intensity')) {
                // Switch to recovery profile
                document.getElementById('missionProfile').value = 'RECOVERY';
                showNotification('AI Applied', 'Switched to recovery intensity', 'success');
            } else if (recommendation.includes('advancing')) {
                // Advance to next phase/week
                if (AppState.session.phase < 4) {
                    selectPhase(AppState.session.phase + 1);
                    showNotification('AI Applied', 'Advanced to next week', 'success');
                }
            }
            
            showNotification('AI Recommendation Applied', recommendation, 'success');
        }

        function viewMLInsights() {
            showNotification(
                'AI Insights',
                `Confidence: ${AppState.session.mlInsights.confidence}%\n\n${AppState.session.mlInsights.recommendation}`,
                'info',
                8000
            );
        }

        // =========================================================
        // NEW FEATURE: SOCIAL SHARING
        // =========================================================
        function showSocialShare() {
            document.getElementById('socialShareModal').classList.add('active');
        }

        function hideSocialShare() {
            document.getElementById('socialShareModal').classList.remove('active');
        }

        function toggleSocialShare() {
            const shareSection = document.getElementById('socialShareSection');
            shareSection.classList.toggle('hidden');
        }

        function shareToPlatform(platform) {
            const message = document.getElementById('socialShareMessage').value;
            const achievements = `Exercises Completed: ${AppState.session.completedExercises.length}\nPain Level: ${AppState.session.metrics.painIndex.toFixed(1)}/10\nSuccess Rate: ${AppState.session.metrics.readiness}%`;
            
            let shareText = `${message}\n\n${achievements}`;
            
            switch(platform) {
                case 'sms':
                    if (navigator.share) {
                        navigator.share({
                            title: 'My Rehab Progress',
                            text: shareText
                        });
                    } else {
                        window.open(`sms:?body=${encodeURIComponent(shareText)}`);
                    }
                    break;
                    
                case 'email':
                    window.open(`mailto:?subject=My Rehab Progress&body=${encodeURIComponent(shareText)}`);
                    break;
                    
                case 'therapist':
                    showNotification('Shared with Therapist', 'Progress report sent to your therapist', 'success');
                    // In real app, this would make an API call
                    break;
            }
            
            // Track sharing
            AppState.social.lastShare = new Date();
            AppState.social.shareCount++;
            
            hideSocialShare();
        }

        function generateProgressImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 800, 400);
            gradient.addColorStop(0, '#00d4aa');
            gradient.addColorStop(1, '#3a86ff');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 400);
            
            // Add text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 36px Inter';
            ctx.fillText('REHAB PROGRESS REPORT', 40, 60);
            
            ctx.font = '24px Inter';
            ctx.fillText(`Patient: ${AppState.operator.id}`, 40, 120);
            ctx.fillText(`Session: ${new Date().toLocaleDateString()}`, 40, 160);
            ctx.fillText(`Exercises Completed: ${AppState.session.completedExercises.length}`, 40, 200);
            ctx.fillText(`Pain Level: ${AppState.session.metrics.painIndex.toFixed(1)}/10`, 40, 240);
            ctx.fillText(`Success Rate: ${AppState.session.metrics.readiness}%`, 40, 280);
            
            // Create download link
            const link = document.createElement('a');
            link.download = `rehab-progress-${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showNotification('Progress Image', 'Image downloaded successfully', 'success');
        }

        function confirmShare() {
            const shareFamily = document.getElementById('shareFamily').checked;
            const shareFriends = document.getElementById('shareFriends').checked;
            const shareTherapist = document.getElementById('shareTherapist').checked;
            
            let recipients = [];
            if (shareFamily) recipients.push('Family');
            if (shareFriends) recipients.push('Friends');
            if (shareTherapist) recipients.push('Therapist');
            
            showNotification(
                'Progress Shared',
                `Shared with: ${recipients.join(', ')}`,
                'success'
            );
            
            hideSocialShare();
        }

        function shareProgress(type) {
            switch(type) {
                case 'text':
                    shareToPlatform('sms');
                    break;
                case 'image':
                    generateProgressImage();
                    break;
                case 'therapist':
                    shareToPlatform('therapist');
                    break;
                default:
                    showSocialShare();
            }
        }

        // =========================================================
        // ORIGINAL FUNCTIONS (UPDATED WITH NEW FEATURES)
        // =========================================================
        function showNotification(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="ri-close-line"></i>
                </button>
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;
            
            container.appendChild(notification);
            
            // Remove notification after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'notification-slide-in 0.3s cubic-bezier(0.4, 0, 0.2, 1) reverse forwards';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
            
            // Vibrate if supported
            if (navigator.vibrate && type === 'error') {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateReadiness(pain, fatigue) {
            const painScore = Math.max(0, 100 - (pain * 10));
            const fatigueScore = Math.max(0, 100 - fatigue);
            return Math.round((painScore + fatigueScore) / 2);
        }

        function updateSystemTime() {
            if (document.hidden) return;
            const timeEl = document.getElementById('currentTime');
            const heroClock = document.getElementById('sessionClockValue');
            if (!timeEl) return;
            const now = new Date();
            const formatted = now.toLocaleTimeString('en-US', { hour12: false });
            timeEl.textContent = formatted;
            if (heroClock) heroClock.textContent = formatted;
        }

        function startClock() {
            clearTimer('clock');
            updateSystemTime();
            Timers.clock = setInterval(updateSystemTime, 1000);
        }

        function pauseIntervalsForVisibility() {
            ['clock', 'metrics', 'mission', 'exercise', 'biometric'].forEach(clearTimer);
        }

        function resumeIntervalsAfterVisibility() {
            startClock();
            if (AppState.session.active && !AppState.emergency.triggered) {
                startMissionTimer(true);
                startMetricsSimulation();
            }
            if (Timers.exerciseRunning && AppState.session.currentExercise) {
                runExerciseCountdown(AppState.session.currentExercise);
            }
            if (document.getElementById('biometricModal')?.classList.contains('active')) {
                startBiometricScan(true);
            }
            alignStatusAnimationWithMotion();
        }

        function alignStatusAnimationWithMotion() {
            const statusDot = document.getElementById('systemStatus');
            if (!statusDot) return;
            if (document.body.classList.contains('reduced-motion')) {
                statusDot.style.animation = 'none';
            } else {
                statusDot.style.animation = '';
            }
        }

        function updateSystemStatus() {
            const statusDot = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            const sessionChip = document.getElementById('sessionStateChip');
            const sessionStateText = document.getElementById('sessionStateText');
            const chipDot = sessionChip?.querySelector('.status-dot');
            let toneColor = 'var(--accent-yellow)';
            let labelCopy = 'Ready';
            
            if (AppState.emergency.triggered) {
                toneColor = 'var(--accent-red)';
                labelCopy = 'EMERGENCY';
                statusDot.style.background = toneColor;
                statusDot.style.animation = 'blink 1s infinite';
                statusText.textContent = ' EMERGENCY';
                statusText.className = 'text-sm font-semibold text-red';
            } else if (AppState.session.active) {
                if (AppState.session.paused) {
                    toneColor = 'var(--accent-yellow)';
                    labelCopy = 'Paused';
                    statusDot.style.background = toneColor;
                    statusDot.style.animation = 'pulse 2s infinite';
                    statusText.textContent = 'Paused';
                    statusText.className = 'text-sm font-semibold text-yellow';
                } else {
                    toneColor = 'var(--accent-green)';
                    labelCopy = 'Active';
                    statusDot.style.background = toneColor;
                    statusDot.style.animation = 'pulse 2s infinite';
                    statusText.textContent = 'Active';
                    statusText.className = 'text-sm font-semibold text-green';
                }
            } else if (AppState.voiceControl.active) {
                toneColor = 'var(--accent-purple)';
                labelCopy = 'Voice Active';
                statusDot.style.background = toneColor;
                statusDot.style.animation = 'pulse 1s infinite';
                statusText.textContent = 'Voice Active';
                statusText.className = 'text-sm font-semibold text-purple';
            } else if (AppState.videoCall.active) {
                toneColor = 'var(--accent-blue)';
                labelCopy = 'Video Call';
                statusDot.style.background = toneColor;
                statusDot.style.animation = 'pulse 1.5s infinite';
                statusText.textContent = 'Video Call';
                statusText.className = 'text-sm font-semibold text-blue';
            } else {
                toneColor = 'var(--accent-yellow)';
                labelCopy = AppState.session.authenticated ? 'Ready' : 'Prep';
                statusDot.style.background = toneColor;
                statusDot.style.animation = 'pulse 2s infinite';
                statusText.textContent = 'Ready';
                statusText.className = 'text-sm font-semibold text-yellow';
            }

            if (sessionStateText) sessionStateText.textContent = labelCopy;
            if (chipDot) chipDot.style.background = toneColor;
            if (sessionChip) {
                sessionChip.style.borderColor = toneColor;
                sessionChip.style.color = toneColor;
            }
            
            alignStatusAnimationWithMotion();
        }

        function refreshExperienceSummary() {
            const readiness = Math.round(AppState.session.metrics.readiness || 0);
            const pain = Number(AppState.session.metrics.painIndex || 0).toFixed(1);
            const fatigue = Math.round(AppState.session.metrics.fatigue || 0);
            const streak = AppState.progress.streak || 0;
            const totalSessions = AppState.progress.totalSessions || 0;
            const threshold = AppState.operator.profile?.painThreshold ?? 7;
            const intensity = (AppState.operator.profile?.intensity || 'STANDARD').replace('_', ' ');
            const injury = (AppState.operator.profile?.injury || 'BALANCE').replace('_', ' ');
            const patientName = AppState.operator.profile?.name || AppState.operator.id || 'Patient';
            
            const dial = document.getElementById('summaryReadinessDial');
            if (dial) dial.style.setProperty('--value', readiness);
            
            const readinessValue = document.getElementById('summaryReadinessValue');
            if (readinessValue) readinessValue.textContent = `${readiness}%`;
            
            const readinessCopy = document.getElementById('summaryPhaseCopy');
            if (readinessCopy) {
                readinessCopy.textContent = AppState.session.active ? 'In session' : 'Awaiting start';
            }
            
            const phaseChip = document.getElementById('summaryPhaseChip');
            if (phaseChip) {
                phaseChip.textContent = AppState.session.active ? `Phase ${AppState.session.phase}` : 'Authenticate';
            }
            
            const profileEl = document.getElementById('summaryProfile');
            if (profileEl) profileEl.textContent = `${intensity} â€¢ ${injury}`;
            
            const supportEl = document.getElementById('summarySupport');
            if (supportEl) supportEl.textContent = `${AppState.operator.profile?.support || 'Support on standby'}`;
            
            const streakEl = document.getElementById('summaryStreak');
            if (streakEl) streakEl.textContent = `${streak} day${streak === 1 ? '' : 's'} in a row`;
            
            const sessionEl = document.getElementById('summarySessions');
            if (sessionEl) sessionEl.textContent = totalSessions;
            
            const painLimitEl = document.getElementById('summaryPainLimit');
            if (painLimitEl) painLimitEl.textContent = `${threshold} / 10`;
            
            const painBaselineEl = document.getElementById('summaryPainBaseline');
            if (painBaselineEl) painBaselineEl.textContent = `${pain} / 10`;
            
            const sessionPatient = document.getElementById('sessionPatient');
            if (sessionPatient) sessionPatient.textContent = patientName;

            const sessionPersonaCopy = document.getElementById('sessionPersonaCopy');
            if (sessionPersonaCopy) {
                sessionPersonaCopy.textContent = `${injury.toLowerCase()} Â· ${intensity.toLowerCase()}`;
            }

            const painBadge = document.getElementById('summaryPainBadge');
            if (painBadge) painBadge.textContent = `${pain} / 10`;
            
            const fatigueEl = document.getElementById('summaryFatigue');
            if (fatigueEl) fatigueEl.textContent = `${fatigue}%`;
            
            const sessionChip = document.getElementById('summarySessionChip');
            if (sessionChip) {
                let tone = 'ready';
                let label = 'Ready';
                if (AppState.session.active && !AppState.session.paused) {
                    tone = 'active';
                    label = 'Active';
                } else if (AppState.session.paused) {
                    tone = 'paused';
                    label = 'Paused';
                } else if (!AppState.session.active && AppState.session.elapsedTime > 0) {
                    tone = 'done';
                    label = 'Complete';
                }
                sessionChip.dataset.tone = tone;
                sessionChip.textContent = label;
            }
            
            const timelineStates = [
                { id: 'Auth', state: AppState.session.phase > 1 || AppState.session.active ? 'Done' : 'Ready' },
                { id: 'Ready', state: AppState.session.active ? 'Done' : 'Waiting' },
                { id: 'Work', state: AppState.session.active ? 'Active' : 'Queued' },
                { id: 'Debrief', state: AppState.session.elapsedTime > 0 && !AppState.session.active ? 'Next' : 'Queued' }
            ];
            
            timelineStates.forEach(step => {
                const stateEl = document.getElementById(`timeline${step.id}State`);
                const dotEl = document.getElementById(`timeline${step.id}Dot`);
                if (stateEl) stateEl.textContent = step.state;
                if (dotEl) dotEl.style.background = step.state === 'Done' || step.state === 'Active' ? 'var(--accent-teal)' : 'rgba(255,255,255,0.2)';
            });

            const stepAuth = document.getElementById('stepAuthState');
            if (stepAuth) stepAuth.textContent = AppState.session.authenticated ? 'Done' : 'Prep';

            const stepBio = document.getElementById('stepBioState');
            if (stepBio) stepBio.textContent = AppState.session.authenticated ? (AppState.session.active ? 'Done' : 'Next') : 'Locked';

            const stepMission = document.getElementById('stepMissionState');
            if (stepMission) stepMission.textContent = AppState.session.active ? 'Active' : 'Queued';

            const stepDebrief = document.getElementById('stepDebriefState');
            if (stepDebrief) stepDebrief.textContent = AppState.session.elapsedTime > 0 ? 'Review' : 'Later';

            updateNavigationAffordances();
        }

        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const behavior = document.body.classList.contains('reduced-motion') ? 'auto' : 'smooth';
            section.scrollIntoView({ behavior, block: 'start' });
        }

        function deriveActionCopy() {
            if (AppState.emergency.triggered) {
                return {
                    label: 'Resume safely',
                    icon: 'ri-shield-cross-line',
                    tone: 'danger',
                    hint: 'Emergency stop is active. Confirm you feel stable before resuming.'
                };
            }

            if (!AppState.session.authenticated) {
                return {
                    label: 'Authenticate now',
                    icon: 'ri-id-card-line',
                    tone: 'info',
                    hint: 'Confirm your ID to unlock readiness and exercises.'
                };
            }

            if (!AppState.session.active) {
                return {
                    label: 'Start mission',
                    icon: 'ri-play-line',
                    tone: 'success',
                    hint: 'Set pain and fatigue, then begin todayâ€™s plan.'
                };
            }

            if (AppState.session.paused) {
                return {
                    label: 'Resume mission',
                    icon: 'ri-play-line',
                    tone: 'warning',
                    hint: 'Pick up right where you paused.'
                };
            }

            return {
                label: 'Pause mission',
                icon: 'ri-pause-line',
                tone: 'success',
                hint: 'Need a breather? Pause safely and resume when ready.'
            };
        }

        function updateNavigationAffordances() {
            const { label, icon, tone, hint } = deriveActionCopy();
            const statusLabel = AppState.emergency.triggered
                ? 'Emergency stop'
                : AppState.session.active
                    ? (AppState.session.paused ? 'Paused' : 'In session')
                    : (!AppState.session.authenticated ? 'Prep' : 'Ready to start');

            const navState = document.getElementById('navSessionState');
            if (navState) {
                navState.textContent = statusLabel;
                navState.dataset.tone = tone || 'info';
            }

            const navPrimary = document.getElementById('navPrimaryAction');
            if (navPrimary) {
                navPrimary.innerHTML = `<i class="${icon}"></i> ${label}`;
            }

            const heroPrimary = document.getElementById('heroPrimaryCta');
            if (heroPrimary) {
                heroPrimary.innerHTML = `<i class="${icon}"></i> ${label}`;
            }

            const dockStatus = document.getElementById('dockStatusLabel');
            if (dockStatus) {
                dockStatus.textContent = statusLabel;
            }

            const dockHint = document.getElementById('dockStatusHint');
            if (dockHint) {
                dockHint.textContent = hint || '';
            }

            const dockPrimary = document.getElementById('dockPrimaryAction');
            if (dockPrimary) {
                dockPrimary.innerHTML = `<i class="${icon}"></i> ${label}`;
            }
        }

        function handlePrimaryNavAction() {
            if (AppState.emergency.triggered) {
                resumeFromEmergency();
                updateNavigationAffordances();
                return;
            }

            if (!AppState.session.authenticated) {
                scrollToSection('phaseAuth');
                showNotification('Authenticate', 'Confirm your ID to unlock readiness checks.', 'info');
                return;
            }

            if (!AppState.session.active) {
                scrollToSection('phaseBio');
                showNotification('Check readiness', 'Set pain and fatigue, then start the mission.', 'info');
                return;
            }

            pauseMission();
            updateNavigationAffordances();
        }

        function handleDockPrimaryAction() {
            handlePrimaryNavAction();
        }

        function mergeStateSection(defaults, incoming) {
            if (Array.isArray(defaults)) {
                return Array.isArray(incoming) ? incoming.slice() : defaults.slice();
            }
            if (!incoming || typeof incoming !== 'object') return defaults;
            const merged = { ...defaults, ...incoming };
            Object.keys(defaults).forEach((key) => {
                if (
                    defaults[key] &&
                    typeof defaults[key] === 'object' &&
                    !Array.isArray(defaults[key])
                ) {
                    merged[key] = mergeStateSection(defaults[key], incoming[key]);
                }
            });
            return merged;
        }

        function saveState() {
            try {
                localStorage.setItem('Rehab_state', JSON.stringify(AppState));
                return true;
            } catch (e) {
                console.error('Failed to save state:', e);
                showNotification('Save Error', 'Failed to save progress', 'error');
                return false;
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('Rehab_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    AppState.operator = mergeStateSection(AppState.operator, parsed.operator);
                    AppState.session = mergeStateSection(AppState.session, parsed.session);
                    AppState.progress = mergeStateSection(AppState.progress, parsed.progress);
                    AppState.emergency = mergeStateSection(AppState.emergency, parsed.emergency);
                    AppState.voiceControl = mergeStateSection(AppState.voiceControl, parsed.voiceControl);
                    AppState.videoCall = mergeStateSection(AppState.videoCall, parsed.videoCall);
                    AppState.social = mergeStateSection(AppState.social, parsed.social);
                    return true;
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
            return false;
        }

        function clearDecorativeLayers() {
            const container = document.getElementById('particles');
            if (container) {
                container.innerHTML = '';
            }
        }

        function refreshDecorativeLayers() {
            const container = document.getElementById('particles');
            const shouldReduce = document.body.classList.contains('reduced-motion') || document.body.classList.contains('calm');
            if (!container) return;
            if (shouldReduce) {
                clearDecorativeLayers();
                return;
            }
            if (container.childElementCount === 0) {
                createParticles();
            }
        }

        function createParticles() {
            const container = document.getElementById('particles');
            if (!container || document.body.classList.contains('reduced-motion') || document.body.classList.contains('calm')) {
                clearDecorativeLayers();
                return;
            }
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 3 + 1;
                const left = Math.random() * 100;
                const delay = Math.random() * 20;
                const duration = Math.random() * 10 + 15;
                const color = Math.random() > 0.5 ? 'var(--accent-teal)' : 'var(--accent-blue)';
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${left}%`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                particle.style.background = color;
                particle.style.opacity = Math.random() * 0.3 + 0.1;
                
                container.appendChild(particle);
            }
        }

        function authenticateOperator() {
            const operatorId = document.getElementById('operatorId').value.trim();
            const securityCode = document.getElementById('securityCode').value.trim();
            const missionProfile = document.getElementById('missionProfile').value;
            
            if (!operatorId || !securityCode) {
                showNotification('Authentication Failed', 'Please enter operator ID and security code', 'error');
                return;
            }
            
            if (securityCode !== 'Rehab_RISING') {
                showNotification('Access Denied', 'Invalid security clearance', 'error');
                return;
            }
            
            AppState.operator.id = operatorId.toUpperCase();
            AppState.operator.clearance = securityCode;
            AppState.operator.profile.intensity = missionProfile;
            AppState.session.authenticated = true;
            
            document.getElementById('operatorName').textContent = `PATIENT: ${operatorId}`;
            document.getElementById('briefOperator').textContent = operatorId;
            document.getElementById('missionName').textContent = `Rehab Session - ${missionProfile}`;
            
            document.getElementById('quickThreshold').textContent = `${AppState.operator.profile.painThreshold}/10`;
            document.getElementById('quickFocus').textContent = AppState.operator.profile.injury.replace('_', ' ');
            document.getElementById('quickGoal').textContent = '45 min';
            
            document.getElementById('phaseAuth').classList.add('hidden');
            document.getElementById('phaseBio').classList.remove('hidden');
            
            initializePainMonitoring();
            updateMLRecommendations();
            refreshExperienceSummary();
            
            showNotification('Authentication Successful', `Welcome back, ${operatorId}`, 'success');
            updateSystemStatus();
            saveState();
        }

        function returnToAuth() {
            AppState.session.authenticated = false;
            document.getElementById('phaseBio').classList.add('hidden');
            document.getElementById('phaseAuth').classList.remove('hidden');
            updateSystemStatus();
            updateNavigationAffordances();
        }

        function beginMission() {
            if (!AppState.session.authenticated) {
                showNotification('Authenticate first', 'Confirm your ID to unlock todayâ€™s protocol.', 'error');
                scrollToSection('phaseAuth');
                return;
            }

            const painValue = parseInt(document.getElementById('baselinePain').value);
            const fatigueValue = parseInt(document.getElementById('fatigueBar').style.width);
            
            AppState.session.active = true;
            AppState.session.startTime = new Date();
            AppState.session.paused = false;
            AppState.session.elapsedTime = 0;
            AppState.session.metrics.painIndex = painValue;
            AppState.session.metrics.fatigue = fatigueValue;
            AppState.session.metrics.startPain = painValue;
            AppState.session.metrics.readiness = calculateReadiness(painValue, fatigueValue);
            
            AppState.progress.totalSessions++;
            
            document.getElementById('phaseBio').classList.add('hidden');
            document.getElementById('phaseMission').classList.remove('hidden');
            
            selectPhase(1);
            startMissionTimer();
            updateMLRecommendations();
            refreshExperienceSummary();
            
            showNotification('Mission Started', 'Execute protocol with precision. Stay safe.', 'success');
            updateSystemStatus();
            updateNavigationAffordances();
            saveState();
            
            startMetricsSimulation();
        }

        function startMissionTimer(resume = false) {
            const protocol = EXERCISE_PLANS[AppState.session.phase];
            if (!protocol) return;

            Timers.missionRemaining = resume && Timers.missionRemaining > 0 ? Timers.missionRemaining : protocol.duration;
            
            clearTimer('mission');
            
            const updateTimer = () => {
                if (!AppState.session.paused && AppState.session.active && !AppState.emergency.triggered) {
                    Timers.missionRemaining = Math.max(0, Timers.missionRemaining - 1);
                    AppState.session.elapsedTime++;
                    
                    document.getElementById('missionTimer').textContent = formatTime(Timers.missionRemaining);
                    document.getElementById('timeElapsed').textContent = formatTime(AppState.session.elapsedTime);
                    
                    if (Timers.missionRemaining <= 300) {
                        document.getElementById('missionStatus').textContent = 'FINAL PHASE';
                        document.getElementById('missionStatus').style.color = 'var(--accent-orange)';
                    }
                    
                    if (Timers.missionRemaining <= 0) {
                        clearTimer('mission');
                        completeMission();
                    }
                }
            };
            
            // Ensure UI shows the most recent countdown immediately.
            document.getElementById('missionTimer').textContent = formatTime(Timers.missionRemaining);
            document.getElementById('timeElapsed').textContent = formatTime(AppState.session.elapsedTime);
            Timers.mission = setInterval(updateTimer, 1000);
        }

        function pauseMission() {
            AppState.session.paused = !AppState.session.paused;
            const button = document.getElementById('pauseBtn');
            
            if (AppState.session.paused) {
                button.innerHTML = '<i class="ri-play-line"></i> RESUME';
                showNotification('Mission Paused', 'Protocol suspended', 'warning');
            } else {
                button.innerHTML = '<i class="ri-pause-line"></i> PAUSE';
                showNotification('Mission Resumed', 'Continue protocol', 'success');
            }
            
            updateSystemStatus();
            updateNavigationAffordances();
            saveState();
        }

        function selectPhase(phase) {
            if (!EXERCISE_PLANS[phase]) {
                showNotification('Phase Unavailable', 'Advanced phase coming soon', 'info');
                return;
            }
            
            AppState.session.phase = phase;
            const protocol = EXERCISE_PLANS[phase];
            
            document.getElementById('missionTitle').textContent = protocol.title;
            document.getElementById('missionSubtitle').textContent = protocol.description;
            
            const container = document.getElementById('exerciseContainer');
            container.innerHTML = '';
            
            protocol.exercises.forEach((exercise) => {
                const isCompleted = AppState.session.completedExercises.includes(exercise.id);
                
                const exerciseHTML = `
                    <div class="exercise-card ${isCompleted ? 'completed' : ''}" id="ex-${exercise.id}">
                        <div class="exercise-header">
                            <h4 class="exercise-title">${exercise.name}</h4>
                            <span class="exercise-difficulty">${exercise.difficulty}</span>
                            ${exercise.mlAdaptive ? '<span class="badge ml-2"><i class="ri-brain-line"></i> AI</span>' : ''}
                        </div>
                        
                        <div class="exercise-meta">
                            <span><i class="ri-time-line"></i> ${exercise.duration}s</span>
                            <span><i class="ri-repeat-line"></i> ${exercise.sets} sets</span>
                            ${exercise.reps ? `<span><i class="ri-number-1"></i> ${exercise.reps} reps</span>` : ''}
                        </div>

                        ${exercise.prescription ? `<div class="exercise-prescription"><i class="ri-sticky-note-line"></i> ${exercise.prescription}</div>` : ''}
                        
                        <p class="text-neutral-400 mb-4">${exercise.description}</p>
                        
                        <div class="exercise-stats">
                            ${exercise.progressMetrics.map(metric => `
                                <div class="stat-item">
                                    <div class="stat-value">--</div>
                                    <div class="stat-label">${metric}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-secondary" onclick="viewExerciseDetails('${exercise.id}')">
                                <i class="ri-information-line"></i> DETAILS
                            </button>
                            ${!isCompleted ? `
                            <button class="btn btn-primary" onclick="startExerciseTimer('${exercise.id}')">
                                <i class="ri-timer-line"></i> START TIMER
                            </button>
                            ` : ''}
                            <button class="btn btn-success" onclick="completeExercise('${exercise.id}')" 
                                    ${isCompleted ? 'disabled' : ''}>
                                <i class="ri-check-line"></i> COMPLETE
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML += exerciseHTML;
            });
            
            if (AppState.session.active) {
                clearTimer('mission');
                startMissionTimer();
            }
            
            showNotification(`Phase ${phase} Loaded`, protocol.description, 'info');
            refreshExperienceSummary();
            saveState();
        }

        function viewExerciseDetails(exerciseId) {
            const protocol = EXERCISE_PLANS[AppState.session.phase];
            const exercise = protocol.exercises.find(e => e.id === exerciseId);
            
            if (exercise) {
                showNotification(
                    exercise.name,
                    `${exercise.description}\n\nDuration: ${exercise.duration}s | Sets: ${exercise.sets}\nDifficulty: ${exercise.difficulty}`,
                    'info',
                    8000
                );
            }
        }

        function startExerciseTimer(exerciseId) {
            const protocol = EXERCISE_PLANS[AppState.session.phase];
            const exercise = protocol.exercises.find(e => e.id === exerciseId);
            
            if (!exercise) return;
            
            AppState.session.currentExercise = exercise;
            Timers.exerciseTimeLeft = exercise.duration;
            Timers.exerciseStartTime = new Date();
            Timers.exerciseRunning = true;
            
            document.getElementById('timerTitle').textContent = exercise.name;
            document.getElementById('exerciseName').textContent = exercise.name;
            document.getElementById('exerciseDescription').textContent = exercise.description;
            document.getElementById('exerciseTimer').textContent = formatTime(exercise.duration);
            document.getElementById('timerModal').classList.add('active');
            
            document.getElementById('timerPauseBtn').innerHTML = '<i class="ri-pause-line"></i> PAUSE';
            runExerciseCountdown(exercise);
        }

        function runExerciseCountdown(exercise) {
            if (!exercise) return;
            clearTimer('exercise');
            
            Timers.exercise = setInterval(() => {
                if (Timers.exerciseRunning && !AppState.session.paused && !AppState.emergency.triggered) {
                    Timers.exerciseTimeLeft--;
                    document.getElementById('exerciseTimer').textContent = formatTime(Timers.exerciseTimeLeft);
                    
                    const elapsed = exercise.duration - Timers.exerciseTimeLeft;
                    const progress = elapsed / exercise.duration;
                    const marker = document.getElementById('exercisePainMarker');
                    if (marker) {
                        const painValue = Math.min(10, Math.max(0, AppState.session.metrics.painIndex + (progress * 2)));
                        marker.textContent = painValue.toFixed(1);
                        marker.style.left = `${painValue * 10}%`;
                    }
                    
                    if (Timers.exerciseTimeLeft <= 0) {
                        clearTimer('exercise');
                        showNotification('Time Complete', 'Exercise finished! Great work.', 'success');
                        Timers.exerciseRunning = false;
                    }
                }
            }, 1000);
        }

        function hideTimer() {
            Timers.exerciseRunning = false;
            clearTimer('exercise');
            document.getElementById('timerModal').classList.remove('active');
        }

        function pauseExerciseTimer() {
            Timers.exerciseRunning = !Timers.exerciseRunning;
            const button = document.getElementById('timerPauseBtn');
            
            if (Timers.exerciseRunning) {
                button.innerHTML = '<i class="ri-pause-line"></i> PAUSE';
            } else {
                button.innerHTML = '<i class="ri-play-line"></i> RESUME';
            }
        }

        function stopExerciseTimer() {
            Timers.exerciseRunning = false;
            clearTimer('exercise');
            document.getElementById('timerModal').classList.remove('active');
            showNotification('Exercise Stopped', 'Timer cancelled', 'warning');
        }

        function completeExerciseTimer() {
            if (AppState.session.currentExercise) {
                completeExercise(AppState.session.currentExercise.id);
            }
            hideTimer();
        }

        function completeExercise(exerciseId) {
            if (AppState.session.completedExercises.includes(exerciseId)) {
                showNotification('Already Completed', 'Exercise already marked as complete', 'info');
                return;
            }
            
            const painLevel = AppState.session.metrics.painIndex;
            if (painLevel >= AppState.operator.profile.painThreshold) {
                const proceed = confirm(`Pain level is ${painLevel.toFixed(1)}/10 (threshold: ${AppState.operator.profile.painThreshold}/10). Continue anyway?`);
                if (!proceed) return;
            }
            
            AppState.session.completedExercises.push(exerciseId);
            
            AppState.session.painHistory.push({
                exercise: exerciseId,
                pain: painLevel,
                time: new Date().toISOString(),
                duration: EXERCISE_PLANS[AppState.session.phase].exercises.find(e => e.id === exerciseId)?.duration || 0
            });
            
            AppState.session.metrics.maxPain = Math.max(AppState.session.metrics.maxPain, painLevel);
            
            const exerciseElement = document.getElementById(`ex-${exerciseId}`);
            if (exerciseElement) {
                exerciseElement.classList.add('completed');
                exerciseElement.querySelector('.btn-success').disabled = true;
            }
            
            const completedCount = AppState.session.completedExercises.length;
            document.getElementById('completedExercises').textContent = completedCount;
            
            const totalExercises = Object.values(EXERCISE_PLANS).reduce(
                (total, protocol) => total + protocol.exercises.length, 0
            );
            const successRate = Math.round((completedCount / totalExercises) * 100);
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            // Update ML recommendations after exercise completion
            updateMLRecommendations();
            
            showNotification('Exercise Completed', 'Great work! Progress saved.', 'success');
            saveState();
        }

        function initializePainMonitoring() {
            const painScale = document.getElementById('painScale');
            const painMarker = document.getElementById('painMarker');
            const exercisePainScale = document.getElementById('exercisePainScale');
            const exercisePainMarker = document.getElementById('exercisePainMarker');
            
            updatePainThreshold();
            
            setupDraggableMarker(painMarker, painScale, (percentage) => {
                const painValue = percentage / 10;
                updatePainValue(painValue);
            });
            
            setupDraggableMarker(exercisePainMarker, exercisePainScale, (percentage) => {
                const painValue = percentage / 10;
                exercisePainMarker.textContent = painValue.toFixed(1);
            });
        }

        function setupDraggableMarker(marker, container, onUpdate) {
            let isDragging = false;
            
            const startDrag = (e) => {
                isDragging = true;
                marker.classList.add('cursor-grabbing');
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
            };
            
            const onDrag = (e) => {
                if (!isDragging) return;
                
                const rect = container.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const percentage = (x / rect.width) * 100;
                
                marker.style.left = `${percentage}%`;
                const painValue = (percentage / 10).toFixed(1);
                marker.textContent = painValue;
                onUpdate(percentage);
            };
            
            const stopDrag = () => {
                isDragging = false;
                marker.classList.remove('cursor-grabbing');
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
            };
            
            marker.addEventListener('mousedown', startDrag);
            marker.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches[0]) startDrag(e.touches[0]);
            });
        }

        function updatePainValue(value) {
            const painValue = Math.round(value * 10) / 10;
            AppState.session.metrics.painIndex = painValue;
            
            document.getElementById('realTimePain').textContent = painValue.toFixed(1);
            document.getElementById('livePain').textContent = painValue.toFixed(1);
            document.getElementById('painValue').textContent = painValue.toFixed(1);
            
            const readiness = calculateReadiness(painValue, AppState.session.metrics.fatigue);
            AppState.session.metrics.readiness = readiness;
            document.getElementById('readinessScore').textContent = `${readiness}%`;
            document.getElementById('bioReadiness').textContent = `${readiness}%`;
            
            const ringOffset = 283 * (1 - readiness / 100);
            document.getElementById('readinessRing').style.strokeDashoffset = ringOffset;
            
            document.getElementById('readinessBar').style.width = `${readiness}%`;
            
            const fatigue = Math.min(100, painValue * 15);
            AppState.session.metrics.fatigue = fatigue;
            document.getElementById('fatigueBar').style.width = `${fatigue}%`;
            document.getElementById('fatigueValue').textContent = `${Math.round(fatigue)}%`;
            
            const threshold = AppState.operator.profile.painThreshold;
            if (painValue >= threshold) {
                document.getElementById('painWarning').classList.remove('hidden');
                if (painValue >= 8) {
                    showNotification('Severe Pain Alert', `Pain level ${painValue.toFixed(1)}/10 detected`, 'error');
                }
            } else {
                document.getElementById('painWarning').classList.add('hidden');
            }
            
            refreshExperienceSummary();
            
            // Update ML recommendations based on pain changes
            updateMLRecommendations();
            
            saveState();
        }

        function updatePainThreshold() {
            const threshold = AppState.operator.profile.painThreshold * 10;
            document.getElementById('painThreshold').style.left = `${threshold}%`;
        }

        function emergencyStop() {
            AppState.session.paused = true;
            AppState.emergency.triggered = true;
            AppState.emergency.lastStop = new Date();
            AppState.emergency.stopCount++;
            
            clearTimer('mission');
            clearTimer('exercise');
            Timers.exerciseRunning = false;
            
            document.getElementById('emergencyModal').classList.add('active');
            
            showNotification('Pause for safety', 'Session paused for safety', 'error');
            updateSystemStatus();
            updateNavigationAffordances();
            saveState();
            
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
        }

        function resumeFromEmergency() {
            document.getElementById('emergencyModal').classList.remove('active');
            
            const proceed = confirm('Ready to continue the session?\n\nPlease ensure you are feeling stable and ready to continue.');
            if (proceed) {
                AppState.session.paused = false;
                AppState.emergency.triggered = false;
                startMissionTimer(true);
                showNotification('Session resumed', 'Continue slowly and carefully', 'warning');
                updateSystemStatus();
                updateNavigationAffordances();
            }
        }

        function abortMission() {
            const confirmAbort = confirm('Are you sure you want to end the session?\n\nAll progress will be saved and you will return to the main menu.');
            if (confirmAbort) {
                document.getElementById('emergencyModal').classList.remove('active');
                completeMission(true);
            }
        }

        function abortProtocol() {
            const confirmAbort = confirm('Clear sign-in information?\n\nAll entered data will be cleared.');
            if (confirmAbort) {
                document.getElementById('operatorId').value = '';
                document.getElementById('securityCode').value = '';
                showNotification('Cleared', 'Sign-in fields cleared', 'warning');
            }
        }

        function completeMission(aborted = false) {
            clearTimer('mission');
            clearTimer('exercise');
            clearTimer('metrics');
            clearTimer('biometric');
            
            const duration = AppState.session.elapsedTime;
            const completedCount = AppState.session.completedExercises.length;
            
            const totalExercises = Object.values(EXERCISE_PLANS).reduce(
                (total, protocol) => total + protocol.exercises.length, 0
            );
            const successRate = Math.round((completedCount / totalExercises) * 100);
            
            const painHistory = AppState.session.painHistory;
            const avgPain = painHistory.length > 0 
                ? painHistory.reduce((sum, record) => sum + record.pain, 0) / painHistory.length
                : AppState.session.metrics.painIndex;
            
            const improvement = (AppState.session.metrics.startPain - avgPain).toFixed(1);
            
            document.getElementById('debriefTime').textContent = formatTime(duration);
            document.getElementById('debriefExercises').textContent = `${completedCount}/${totalExercises}`;
            document.getElementById('debriefPain').textContent = avgPain.toFixed(1);
            document.getElementById('debriefSuccess').textContent = `${successRate}%`;
            
            const improvementElement = document.querySelector('#phaseDebrief .metric-change');
            if (improvementElement) {
                improvementElement.textContent = `${improvement >= 0 ? '-' : '+'}${Math.abs(improvement)}`;
                improvementElement.className = `metric-change ${improvement >= 0 ? 'positive' : 'negative'}`;
            }
            
            const today = new Date().toDateString();
            if (AppState.progress.lastSession !== today) {
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                AppState.progress.streak = AppState.progress.lastSession === yesterday 
                    ? AppState.progress.streak + 1 
                    : 1;
                AppState.progress.longestStreak = Math.max(AppState.progress.longestStreak, AppState.progress.streak);
                AppState.progress.lastSession = today;
            }
            
            generatePainChart();
            updateMLRecommendations();
            
            document.getElementById('phaseMission').classList.add('hidden');
            document.getElementById('phaseDebrief').classList.remove('hidden');
            Timers.missionRemaining = 0;
            
            showNotification(
                aborted ? 'Mission Aborted' : 'Mission Complete',
                aborted ? 'Progress saved. Safety first.' : 'Excellent work! Mission accomplished.',
                aborted ? 'warning' : 'success'
            );
            
            AppState.session.active = false;
            AppState.emergency.triggered = false;
            refreshExperienceSummary();
            updateSystemStatus();
            saveState();
        }

        function generatePainChart() {
            const chartContainer = document.getElementById('painHistoryChart');
            const painHistory = AppState.session.painHistory;
            
            if (painHistory.length === 0) {
                chartContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-4xl text-neutral-600 mb-4">
                            <i class="ri-line-chart-line"></i>
                        </div>
                        <p class="text-neutral-400">No pain data recorded during this session.</p>
                    </div>
                `;
                return;
            }
            
            let chartHTML = '<div class="space-y-4">';
            painHistory.forEach((record, index) => {
                const exercise = EXERCISE_PLANS[AppState.session.phase]?.exercises.find(e => e.id === record.exercise);
                const exerciseName = exercise?.name || `Exercise ${index + 1}`;
                const barWidth = Math.min(100, record.pain * 10);
                const barColor = record.pain <= 3 ? 'bg-green' : record.pain <= 7 ? 'bg-yellow' : 'bg-red';
                
                chartHTML += `
                    <div class="flex items-center gap-4">
                        <div class="w-32 text-sm truncate" title="${exerciseName}">${exerciseName}</div>
                        <div class="flex-1 h-6 bg-neutral-800 rounded-full overflow-hidden">
                            <div class="h-full ${barColor} rounded-full transition-all" 
                                 style="width: ${barWidth}%"></div>
                        </div>
                        <div class="w-12 text-right font-mono font-bold">${record.pain.toFixed(1)}</div>
                    </div>
                `;
            });
            
            const avgPain = painHistory.reduce((sum, r) => sum + r.pain, 0) / painHistory.length;
            const maxPain = Math.max(...painHistory.map(r => r.pain));
            
            chartHTML += `
                <div class="mt-8 pt-6 border-t border-neutral-800">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-neutral-800/50 rounded-lg">
                            <div class="text-lg font-bold text-teal">${avgPain.toFixed(1)}</div>
                            <div class="text-xs text-neutral-400">Average Pain</div>
                        </div>
                        <div class="text-center p-3 bg-neutral-800/50 rounded-lg">
                            <div class="text-lg font-bold text-red">${maxPain.toFixed(1)}</div>
                            <div class="text-xs text-neutral-400">Peak Pain</div>
                        </div>
                    </div>
                </div>
            `;
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        function showProfileModal() {
            const profile = AppState.operator.profile;
            
            document.getElementById('profileName').value = profile.name;
            document.getElementById('profileInjury').value = profile.injury;
            document.getElementById('profileIntensity').value = profile.intensity;
            document.getElementById('profileSupport').value = profile.support;
            document.getElementById('profileSessions').value = profile.sessionsPerWeek;
            document.getElementById('profilePainThreshold').value = profile.painThreshold;
            document.getElementById('thresholdValueDisplay').textContent = profile.painThreshold;
            document.getElementById('profileMotivation').value = profile.motivation;
            
            document.getElementById('biometricFace').checked = AppState.operator.biometrics.faceRegistered;
            document.getElementById('biometricVoice').checked = AppState.operator.biometrics.voiceRegistered;
            document.getElementById('biometricMotion').checked = AppState.operator.biometrics.motionRegistered;
            
            document.getElementById('privacyTherapist').checked = profile.privacy.shareTherapist;
            document.getElementById('privacyAI').checked = profile.privacy.allowAI;
            document.getElementById('privacyResearch').checked = profile.privacy.anonymousResearch;
            
            document.getElementById('profileModal').classList.add('active');
        }

        function hideProfileEditor() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function saveProfile() {
            const profile = {
                name: document.getElementById('profileName').value.toUpperCase(),
                injury: document.getElementById('profileInjury').value,
                intensity: document.getElementById('profileIntensity').value,
                support: document.getElementById('profileSupport').value,
                sessionsPerWeek: parseInt(document.getElementById('profileSessions').value),
                painThreshold: parseInt(document.getElementById('profilePainThreshold').value),
                motivation: document.getElementById('profileMotivation').value,
                privacy: {
                    shareTherapist: document.getElementById('privacyTherapist').checked,
                    allowAI: document.getElementById('privacyAI').checked,
                    anonymousResearch: document.getElementById('privacyResearch').checked
                }
            };
            
            AppState.operator.profile = profile;
            AppState.operator.id = profile.name;
            
            AppState.operator.biometrics.faceRegistered = document.getElementById('biometricFace').checked;
            AppState.operator.biometrics.voiceRegistered = document.getElementById('biometricVoice').checked;
            AppState.operator.biometrics.motionRegistered = document.getElementById('biometricMotion').checked;
            
            document.getElementById('operatorName').textContent = `PATIENT: ${profile.name}`;
            document.getElementById('briefOperator').textContent = profile.name;
            document.getElementById('operatorId').value = profile.name;
            
            document.getElementById('quickThreshold').textContent = `${profile.painThreshold}/10`;
            document.getElementById('quickFocus').textContent = profile.injury.replace('_', ' ');
            
            updatePainThreshold();
            
            hideProfileEditor();
            saveState();
            refreshExperienceSummary();
            showNotification('Profile Saved', 'Operator profile updated successfully', 'success');
        }

        function exportData() {
            const data = {
                operator: AppState.operator,
                session: AppState.session,
                progress: AppState.progress,
                exportDate: new Date().toISOString(),
                version: AppState.version
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = `Rehab_mission_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data Exported', 'Mission data downloaded as JSON', 'success');
        }

        function saveSession() {
            if (saveState()) {
                showNotification('Session Saved', 'Progress saved successfully', 'success');
            }
        }

        function startNewSession() {
            ['mission', 'exercise', 'metrics', 'biometric'].forEach(clearTimer);
            Timers.missionRemaining = 0;
            Timers.exerciseRunning = false;
            AppState.session = {
                active: false,
                phase: 1,
                startTime: null,
                elapsedTime: 0,
                totalTime: 15 * 60,
                paused: false,
                authenticated: false,
                completedExercises: [],
                currentExercise: null,
                painHistory: [],
                notes: '',
                metrics: {
                    painIndex: 0,
                    fatigue: 0,
                    readiness: 100,
                    stability: 100,
                    startPain: 0,
                    avgPain: 0,
                    maxPain: 0
                },
                mlInsights: {
                    recommendation: 'Focus on balance exercises',
                    confidence: 85,
                    improvements: {
                        stability: 8,
                        painReduction: 15,
                        endurance: 12
                    }
                }
            };
            
            AppState.emergency.triggered = false;
            
            document.getElementById('phaseDebrief').classList.add('hidden');
            document.getElementById('phaseAuth').classList.remove('hidden');
            
            document.getElementById('baselinePain').value = 0;
            document.getElementById('painValue').textContent = '0';
            document.getElementById('fatigueBar').style.width = '0%';
            document.getElementById('fatigueValue').textContent = '0%';
            document.getElementById('readinessScore').textContent = '100%';
            document.getElementById('readinessRing').style.strokeDashoffset = '283';
            
            updateMLRecommendations();
            refreshExperienceSummary();
            updateNavigationAffordances();
            
            showNotification('New session Ready', 'Begin new mission when ready', 'info');
            updateSystemStatus();
            saveState();
        }

        function clearTimer(timerName) {
            if (Timers[timerName]) {
                clearInterval(Timers[timerName]);
                Timers[timerName] = null;
            }
        }

        function startMetricsSimulation() {
            clearTimer('metrics');
            
            Timers.metrics = setInterval(() => {
                if (document.hidden || !AppState.session.active || AppState.session.paused || AppState.emergency.triggered) {
                    return;
                }
                
                const currentPain = AppState.session.metrics.painIndex;
                const fluctuation = (Math.random() - 0.5) * 0.5;
                const newPain = Math.max(0, Math.min(10, currentPain + fluctuation));
                
                if (Math.abs(newPain - currentPain) > 0.1) {
                    updatePainValue(newPain);
                }
                
                const baseHeartRate = 70;
                const activityFactor = AppState.session.metrics.painIndex * 3;
                const heartRate = Math.round(baseHeartRate + activityFactor + (Math.random() * 20 - 10));
                document.getElementById('heartRate').textContent = heartRate;
                
                const exerciseProgress = AppState.session.completedExercises.length / 12;
                const painFactor = 1 - (AppState.session.metrics.painIndex / 20);
                const stability = Math.round(70 + (exerciseProgress * 20) + (painFactor * 10));
                document.getElementById('stabilityScore').textContent = `${stability}%`;
                
            }, 5000);
        }

        // =========================================================
        // CALM MODE TOGGLE
        // =========================================================
        (function(){
            const KEY = "RehabCalmMode";
            const media = window.matchMedia('(prefers-reduced-motion: reduce)');
            let hasStoredPreference = false;

            function apply(on, { persist = true } = {}){
                const shouldReduce = !!on || media.matches;
                document.body.classList.toggle("calm", !!on);
                document.body.classList.toggle("reduced-motion", shouldReduce);
                if (persist) {
                    try{ 
                        localStorage.setItem(KEY, on ? "1" : "0");
                        hasStoredPreference = true;
                    }catch(e){}
                }
                const btn = document.getElementById("calmToggleBtn");
                if(btn) btn.setAttribute("aria-pressed", on ? "true" : "false");
                if(btn) btn.setAttribute("aria-label", on ? "Calm mode on - reduced motion" : "Pro mode on - full visuals");
                if(btn) btn.innerHTML = on ? '<i class="ri-moon-clear-line"></i>' : '<i class="ri-sun-line"></i>';
                const label = document.getElementById("calmToggleLabel");
                if(label) label.textContent = on ? "Calm" : "Pro";
                if (shouldReduce) {
                    clearDecorativeLayers();
                } else {
                    refreshDecorativeLayers();
                }
                alignStatusAnimationWithMotion();
            }
            function init(){
                let storedPreference = null;
                try{ 
                    const saved = localStorage.getItem(KEY);
                    if (saved !== null) {
                        storedPreference = saved === "1";
                        hasStoredPreference = true;
                    }
                }catch(e){}
                const on = storedPreference !== null ? storedPreference : media.matches;
                apply(on, { persist: storedPreference !== null });
                window.toggleCalmMode = () => apply(!document.body.classList.contains("calm"));
                const onMediaChange = (event) => {
                    if (!hasStoredPreference) {
                        apply(event.matches, { persist: false });
                    } else {
                        document.body.classList.toggle("reduced-motion", document.body.classList.contains("calm") || event.matches);
                        if (document.body.classList.contains("reduced-motion")) {
                            clearDecorativeLayers();
                            alignStatusAnimationWithMotion();
                        } else {
                            refreshDecorativeLayers();
                        }
                    }
                };
                if (typeof media.addEventListener === "function") {
                    media.addEventListener("change", onMediaChange);
                } else if (typeof media.addListener === "function") {
                    media.addListener(onMediaChange);
                }
            }
            if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
            else init();
        })();

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                pauseIntervalsForVisibility();
            } else {
                resumeIntervalsAfterVisibility();
            }
        });

        // =========================================================
        // INITIALIZATION
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            if (loadState()) {
                showNotification('System Ready', 'Previous session loaded successfully', 'success');
            }
            
            refreshDecorativeLayers();
            startClock();
            
            initializePainMonitoring();
            
            document.getElementById('baselinePain').addEventListener('input', function() {
                const value = parseInt(this.value);
                document.getElementById('painValue').textContent = value;
                document.getElementById('fatigueBar').style.width = `${value * 10}%`;
                document.getElementById('fatigueValue').textContent = `${value * 10}%`;
                
                const readiness = calculateReadiness(value, value * 10);
                document.getElementById('readinessScore').textContent = `${readiness}%`;
                
                const ringOffset = 283 * (1 - readiness / 100);
                document.getElementById('readinessRing').style.strokeDashoffset = ringOffset;
                
                document.getElementById('painMarker').style.left = `${value * 10}%`;
                document.getElementById('painMarker').textContent = value;
            });
            
            document.getElementById('profilePainThreshold').addEventListener('input', function() {
                document.getElementById('thresholdValueDisplay').textContent = this.value;
            });
            
            document.getElementById('operatorId').value = AppState.operator.id;
            document.getElementById('securityCode').value = AppState.operator.clearance;
            document.getElementById('missionProfile').value = AppState.operator.profile.intensity;
            document.getElementById('operatorName').textContent = `PATIENT: ${AppState.operator.id}`;
            
            document.getElementById('quickThreshold').textContent = `${AppState.operator.profile.painThreshold}/10`;
            document.getElementById('quickFocus').textContent = AppState.operator.profile.injury.replace('_', ' ');
            document.getElementById('quickGoal').textContent = '45 min';
            
            // Initialize ML recommendations
            updateMLRecommendations();
            refreshExperienceSummary();
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && AppState.session.active) {
                    e.preventDefault();
                    pauseMission();
                }
                
                if (e.code === 'Escape' && AppState.session.active) {
                    emergencyStop();
                }
                
                if (e.ctrlKey && e.code === 'KeyS') {
                    e.preventDefault();
                    saveState();
                    showNotification('Auto-Save', 'Progress saved', 'success');
                }
                
                // Voice control toggle (V key)
                if (e.code === 'KeyV' && e.ctrlKey) {
                    e.preventDefault();
                    toggleVoiceControl();
                }
                
                // Video call toggle (C key)
                if (e.code === 'KeyC' && e.ctrlKey) {
                    e.preventDefault();
                    toggleVideoCall();
                }
            });
            
            updateSystemStatus();
            
            console.log('ðŸ”¥ Rehab Session Pro v4.0 - Advanced Features Active');
            console.log('Features: Voice Control, Biometric Auth, Video Calls, ML Recommendations, Social Sharing');
        });
    </script>
</body>
</html>
